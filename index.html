<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Bidan & Terapis - Sistem Lengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #FFF0F5;
            background-image: url('https://www.transparenttextures.com/patterns/sakura.png');
        }
        .kawaii-shadow {
            box-shadow: 0 4px 6px -1px rgba(219, 112, 147, 0.3), 0 2px 4px -2px rgba(219, 112, 147, 0.2);
        }
        .btn-primary {
            background-color: #FF69B4;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #FF1493;
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #f7b8d6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background-color: #87CEEB;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #00BFFF;
            transform: translateY(-2px);
        }
        .btn-admin {
            background-color: #9370DB;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-admin:hover {
            background-color: #7B68EE;
            transform: translateY(-2px);
        }
        .tab-active {
            border-bottom: 3px solid #FF69B4;
            color: #FF69B4;
            font-weight: 700;
        }
        .tab-inactive {
            color: #a0aec0;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .attendance-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .attendance-item:hover {
            background-color: #f9fafb;
            border-left-color: #FF69B4;
        }
        .attendance-item.selected {
            background-color: #f0f9ff;
            border-left-color: #3b82f6;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF69B4;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-day {
            border: 1px solid #e2e8f0;
            min-height: 100px;
            padding: 8px;
            position: relative;
        }
        .calendar-day.today {
            background-color: #f0fff4;
            border-color: #68d391;
        }
        .calendar-day.weekend {
            background-color: #f7fafc;
        }
        .calendar-event {
            background-color: #bee3f8;
            border-radius: 4px;
            padding: 2px 4px;
            margin-bottom: 2px;
            font-size: 12px;
            cursor: pointer;
        }
        .calendar-event.pagi {
            background-color: #c6f6d5;
            border-left: 3px solid #38a169;
        }
        .calendar-event.sore {
            background-color: #fed7d7;
            border-left: 3px solid #e53e3e;
        }
        .calendar-event.malam {
            background-color: #e9d8fd;
            border-left: 3px solid #805ad5;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .admin-locked {
            position: relative;
        }
        .admin-locked::after {
            content: "üîí";
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 14px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .shift-pagi {
            background-color: #c6f6d5;
            border-color: #38a169;
        }
        .shift-sore {
            background-color: #fed7d7;
            border-color: #e53e3e;
        }
        .export-option {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .export-option:hover {
            border-color: #FF69B4;
            transform: translateY(-2px);
        }
        .export-option.selected {
            border-color: #FF69B4;
            background-color: #fdf2f8;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center kawaii-shadow fade-in">
            <h2 class="text-3xl font-bold text-pink-500 mb-2">‚ô° Konnichiwa! ‚ô°</h2>
            <p class="text-lg text-gray-600 mb-6">Siapa nama kamu? üòä</p>
            <input type="text" id="name-input" placeholder="Tulis nama/nama panggilan di sini..." class="w-full px-4 py-3 border-2 border-pink-200 rounded-lg focus:outline-none focus:border-pink-400 mb-6 text-center">
            <button id="start-btn" class="w-full btn-primary font-bold py-3 rounded-lg kawaii-shadow">Masuk</button>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center kawaii-shadow fade-in">
            <h2 class="text-3xl font-bold text-purple-500 mb-2">üîê Admin Panel</h2>
            <p class="text-lg text-gray-600 mb-6">Masukkan password admin</p>
            <input type="password" id="admin-password" placeholder="Password admin..." class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:outline-none focus:border-purple-400 mb-6 text-center">
            <button id="admin-login-submit" class="w-full btn-admin font-bold py-3 rounded-lg kawaii-shadow">Masuk</button>
            <button id="admin-login-cancel" class="w-full bg-gray-300 text-gray-700 font-bold py-3 rounded-lg kawaii-shadow mt-2">Batal</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="max-w-7xl mx-auto bg-white min-h-screen shadow-lg hidden">
        <div class="p-6 bg-pink-100" style="background-image: url('https://i.pinimg.com/564x/c2/a7/9a/c2a79a0f4435887803673059811438a3.jpg'); background-size: cover; background-position: center;">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">Absensi Bidan Terapis & Admin</h1>
                    <div class="text-white mt-1" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
                        <p class="font-medium text-sm" id="display-name">Nabilah Pulungan</p>
                        <p class="text-xs" id="current-datetime">Senin, 1 Januari 2024</p>
                    </div>
                </div>
                <div class="text-right">
                    <button id="user-logout" class="bg-white text-pink-500 px-4 py-2 rounded-lg text-sm font-medium kawaii-shadow">Logout</button>
                    <button id="admin-access-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium kawaii-shadow mt-2">Admin Access</button>
                </div>
            </div>
        </div>

        <!-- Tabs - Tab Admin selalu ditampilkan -->
        <div class="flex border-b">
            <button id="tab-datang" class="flex-1 py-3 text-center font-medium tab-active">Absen Datang</button>
            <button id="tab-pulang" class="flex-1 py-3 text-center font-medium tab-inactive">Absen Pulang</button>
            <button id="tab-admin" class="flex-1 py-3 text-center font-medium tab-inactive admin-locked">Panel Admin</button>
        </div>

        <div class="p-6 space-y-6">
            <!-- Universal Shift Selector -->
            <div class="bg-blue-50 p-4 rounded-lg kawaii-shadow">
                <h3 class="font-bold text-lg text-blue-800 mb-2">Pilih Shift Kerja Hari Ini</h3>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="shift" value="Pagi" class="form-radio text-pink-500" checked>
                        <span class="text-gray-700">‚òÄÔ∏è Pagi (08:00 - 17:00)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="shift" value="Sore" class="form-radio text-pink-500">
                        <span class="text-gray-700">üåô Sore (15:00 - 21:30)</span>
                    </label>
                </div>
            </div>

            <!-- Datang Tab Content -->
            <div id="content-datang">
                <div class="bg-green-50 p-4 rounded-lg kawaii-shadow">
                    <h3 class="font-bold text-lg text-green-800 mb-2">Lokasi Kamu Saat Ini</h3>
                    <button id="get-location-btn" class="w-full btn-secondary font-bold py-2 rounded-lg text-sm mb-2 kawaii-shadow">üìç Dapatkan Lokasi</button>
                    <p id="location-display" class="text-center text-gray-600 text-sm h-10">Lokasi akan tampil di sini...</p>
                </div>

                <button id="absen-datang-btn" class="w-full btn-primary font-bold py-4 rounded-lg kawaii-shadow text-lg mt-4" disabled>Absen Datang & Kirim</button>
            </div>

            <!-- Pulang Tab Content -->
            <div id="content-pulang" class="hidden">
                <div class="bg-yellow-50 p-4 rounded-lg kawaii-shadow">
                    <h3 class="font-bold text-lg text-yellow-800 mb-2">Daftar Absen Datang (Belum Pulang)</h3>
                    <div class="flex items-center mb-2">
                        <input type="text" id="search-absen" placeholder="Cari berdasarkan nama..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <button id="refresh-absen-btn" class="ml-2 bg-pink-500 text-white px-4 py-2 rounded-lg kawaii-shadow">Refresh</button>
                    </div>
                    <div id="absen-list" class="space-y-2 max-h-60 overflow-y-auto p-2">
                        <!-- List absen datang akan ditampilkan di sini -->
                    </div>
                </div>

                <div class="bg-green-50 p-4 rounded-lg kawaii-shadow mt-4">
                    <h3 class="font-bold text-lg text-green-800 mb-2">Lokasi Kamu Saat Ini</h3>
                    <button id="get-location-btn-pulang" class="w-full btn-secondary font-bold py-2 rounded-lg text-sm mb-2 kawaii-shadow">üìç Dapatkan Lokasi</button>
                    <p id="location-display-pulang" class="text-center text-gray-600 text-sm h-10">Lokasi akan tampil di sini...</p>
                </div>

                <button id="absen-pulang-btn" class="w-full btn-primary font-bold py-4 rounded-lg kawaii-shadow text-lg mt-4" disabled>Absen Pulang & Kirim</button>
            </div>

            <!-- Admin Tab Content -->
            <div id="content-admin" class="hidden">
                <!-- Admin Access Required Message -->
                <div id="admin-access-required" class="bg-yellow-50 p-8 rounded-lg kawaii-shadow text-center">
                    <div class="text-5xl mb-4">üîí</div>
                    <h3 class="text-xl font-bold text-yellow-800 mb-2">Akses Admin Diperlukan</h3>
                    <p class="text-gray-600 mb-6">Panel admin membutuhkan autentikasi. Silakan login sebagai admin untuk mengakses fitur ini.</p>
                    <button id="admin-login-from-tab" class="btn-admin font-bold py-3 px-6 rounded-lg kawaii-shadow">Login sebagai Admin</button>
                </div>

                <!-- Admin Content (akan ditampilkan setelah login) -->
                <div id="admin-content" class="hidden">
                    <!-- Admin Controls -->
                    <div class="bg-purple-50 p-4 rounded-lg kawaii-shadow mb-6">
                        <h3 class="font-bold text-lg text-purple-800 mb-4">Kontrol Admin</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <button id="refresh-admin-data" class="btn-admin py-2 rounded-lg kawaii-shadow">Refresh Data</button>
                            <button id="export-data" class="btn-secondary py-2 rounded-lg kawaii-shadow">Export Data</button>
                            <button id="fix-user-data" class="bg-yellow-500 text-white py-2 rounded-lg kawaii-shadow">Perbaiki Data User</button>
                            <button id="generate-pdf" class="bg-red-500 text-white py-2 rounded-lg kawaii-shadow">Generate PDF Report</button>
                        </div>
                    </div>

                    <!-- PDF Export Modal -->
                    <div id="pdf-export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
                        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full kawaii-shadow fade-in">
                            <h2 class="text-2xl font-bold text-pink-500 mb-4">Export Laporan PDF</h2>
                            <div class="space-y-4 mb-6">
                                <p class="text-gray-600">Pilih jenis laporan yang ingin diexport:</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="export-option" data-type="table">
                                        <div class="text-center">
                                            <div class="text-3xl mb-2">üìä</div>
                                            <h4 class="font-bold text-gray-800">Data Tabel</h4>
                                            <p class="text-sm text-gray-600 mt-1">Data absensi dalam format tabel</p>
                                        </div>
                                    </div>
                                    <div class="export-option" data-type="calendar">
                                        <div class="text-center">
                                            <div class="text-3xl mb-2">üìÖ</div>
                                            <h4 class="font-bold text-gray-800">Kalender</h4>
                                            <p class="text-sm text-gray-600 mt-1">Tampilan kalender absensi</p>
                                        </div>
                                    </div>
                                    <div class="export-option" data-type="statistics">
                                        <div class="text-center">
                                            <div class="text-3xl mb-2">üìà</div>
                                            <h4 class="font-bold text-gray-800">Statistik</h4>
                                            <p class="text-sm text-gray-600 mt-1">Grafik dan statistik lengkap</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-4 rounded-lg mt-4">
                                    <p class="text-sm text-blue-800"><strong>Tip:</strong> Anda bisa memilih satu, dua, atau ketiga jenis laporan sekaligus!</p>
                                </div>
                            </div>
                            <div class="flex space-x-4">
                                <button id="generate-pdf-btn" class="flex-1 bg-red-500 text-white py-3 rounded-lg kawaii-shadow">Generate PDF</button>
                                <button id="cancel-pdf-export" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg kawaii-shadow">Batal</button>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Filter Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                                <input type="text" id="filter-nama" placeholder="Semua nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="filter-tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                                <select id="filter-shift" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                    <option value="">Semua Shift</option>
                                    <option value="Pagi">Pagi</option>
                                    <option value="Sore">Sore</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button id="apply-filters" class="btn-primary px-4 py-2 rounded-lg kawaii-shadow">Terapkan Filter</button>
                            <button id="clear-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Hapus Filter</button>
                        </div>
                    </div>

                    <!-- View Options -->
                    <div class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Tampilan Data</h3>
                        <div class="flex space-x-4">
                            <button id="view-table" class="btn-secondary px-4 py-2 rounded-lg kawaii-shadow">Tabel</button>
                            <button id="view-calendar" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Kalender</button>
                            <button id="view-statistics" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Statistik</button>
                        </div>
                    </div>

                    <!-- Table View -->
                    <div id="table-view" class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Data Absensi</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-700">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3">Tanggal</th>
                                        <th class="px-4 py-3">Nama</th>
                                        <th class="px-4 py-3">Shift</th>
                                        <th class="px-4 py-3">Waktu Datang</th>
                                        <th class="px-4 py-3">Keterlambatan</th>
                                        <th class="px-4 py-3">Waktu Pulang</th>
                                        <th class="px-4 py-3">Total Jam</th>
                                        <th class="px-4 py-3">Status</th>
                                        <th class="px-4 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-table-body">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Calendar View -->
                    <div id="calendar-view" class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6 hidden">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Kalender Absensi</h3>
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month" class="btn-secondary px-4 py-2 rounded-lg kawaii-shadow">‚Üê Bulan Sebelumnya</button>
                            <h4 id="current-month" class="text-lg font-bold">Januari 2024</h4>
                            <button id="next-month" class="btn-secondary px-4 py-2 rounded-lg kawaii-shadow">Bulan Selanjutnya ‚Üí</button>
                        </div>
                        
                        <!-- Legend -->
                        <div class="flex flex-wrap gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-green-200 border border-green-500 rounded"></div>
                                <span class="text-sm">Shift Pagi</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-red-200 border border-red-500 rounded"></div>
                                <span class="text-sm">Shift Sore</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 bg-purple-200 border border-purple-500 rounded"></div>
                                <span class="text-sm">Shift Malam</span>
                            </div>
                        </div>
                        
                        <div id="calendar-container" class="grid grid-cols-7 gap-1">
                            <!-- Kalender akan diisi oleh JavaScript -->
                        </div>
                    </div>

                    <!-- Statistics View -->
                    <div id="statistics-view" class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6 hidden">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Statistik Absensi</h3>
                        
                        <!-- Period Selector -->
                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <h4 class="font-bold text-blue-800 mb-2">Pilih Periode Statistik</h4>
                            <div class="flex space-x-4">
                                <button id="stats-weekly" class="btn-secondary px-4 py-2 rounded-lg kawaii-shadow">Mingguan</button>
                                <button id="stats-monthly" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Bulanan</button>
                                <button id="stats-yearly" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Tahunan</button>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="stat-card">
                                <h4 class="text-lg font-bold mb-2">Total Absensi</h4>
                                <p id="total-absensi" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="stat-card">
                                <h4 class="text-lg font-bold mb-2">Rata-rata Keterlambatan</h4>
                                <p id="avg-late" class="text-3xl font-bold">0 menit</p>
                            </div>
                            <div class="stat-card">
                                <h4 class="text-lg font-bold mb-2">Total Keterlambatan</h4>
                                <p id="total-late" class="text-3xl font-bold">0 menit</p>
                            </div>
                        </div>

                        <!-- Charts Container -->
                        <div id="charts-container">
                            <!-- Charts will be loaded here based on period selection -->
                        </div>
                    </div>

                    <!-- Edit Modal -->
                    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
                        <div class="bg-white rounded-2xl p-8 max-w-md w-full kawaii-shadow fade-in">
                            <h2 class="text-2xl font-bold text-pink-500 mb-4">Edit Data Absensi</h2>
                            <form id="edit-form" class="space-y-4">
                                <input type="hidden" id="edit-id">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                    <input type="date" id="edit-tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                                    <input type="text" id="edit-nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                                    <select id="edit-shift" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                        <option value="Pagi">Pagi</option>
                                        <option value="Sore">Sore</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Datang</label>
                                        <input type="time" id="edit-waktu-datang" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Pulang</label>
                                        <input type="time" id="edit-waktu-pulang" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterlambatan</label>
                                    <input type="text" id="edit-keterlambatan" placeholder="Contoh: 5 menit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lembur</label>
                                    <input type="text" id="edit-lembur" placeholder="Contoh: 30 menit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                </div>
                                <div class="flex space-x-4 mt-6">
                                    <button type="submit" class="flex-1 btn-primary py-3 rounded-lg kawaii-shadow">Simpan Perubahan</button>
                                    <button type="button" id="cancel-edit" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg kawaii-shadow">Batal</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg border-l-4 border-green-500 hidden z-50 max-w-sm fade-in">
        <div class="flex items-center">
            <div class="mr-3 text-green-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div>
                <p id="toast-message" class="text-gray-800 font-medium">Pesan notifikasi</p>
            </div>
        </div>
    </div>

    <script>
        // URL Google Apps Script Web App
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZxc9s1hUgn04AM3OWV4JLEr1l_oHn8VM0L4Cwaqev54gKag31teoWNSFHa3JBB4FKMQ/exec";

        // State management
        let state = {
            currentUser: null,
            currentTab: 'datang',
            isAdmin: false,
            currentLocation: null,
            absenDatangList: [],
            allAttendanceData: [],
            filteredAttendanceData: [],
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            charts: {},
            currentStatsPeriod: 'weekly',
            selectedExports: new Set()
        };

        // DOM Elements
        const elements = {
            // Modals
            welcomeModal: document.getElementById('welcome-modal'),
            adminLoginModal: document.getElementById('admin-login-modal'),
            mainContent: document.getElementById('main-content'),
            editModal: document.getElementById('edit-modal'),
            pdfExportModal: document.getElementById('pdf-export-modal'),
            toast: document.getElementById('toast'),
            
            // Inputs
            nameInput: document.getElementById('name-input'),
            adminPassword: document.getElementById('admin-password'),
            
            // Buttons
            startBtn: document.getElementById('start-btn'),
            adminAccessBtn: document.getElementById('admin-access-btn'),
            userLogout: document.getElementById('user-logout'),
            adminLoginSubmit: document.getElementById('admin-login-submit'),
            adminLoginCancel: document.getElementById('admin-login-cancel'),
            adminLoginFromTab: document.getElementById('admin-login-from-tab'),
            getLocationBtn: document.getElementById('get-location-btn'),
            getLocationBtnPulang: document.getElementById('get-location-btn-pulang'),
            absenDatangBtn: document.getElementById('absen-datang-btn'),
            absenPulangBtn: document.getElementById('absen-pulang-btn'),
            refreshAbsenBtn: document.getElementById('refresh-absen-btn'),
            generatePdf: document.getElementById('generate-pdf'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            cancelPdfExport: document.getElementById('cancel-pdf-export'),
            
            // Tabs
            tabDatang: document.getElementById('tab-datang'),
            tabPulang: document.getElementById('tab-pulang'),
            tabAdmin: document.getElementById('tab-admin'),
            contentDatang: document.getElementById('content-datang'),
            contentPulang: document.getElementById('content-pulang'),
            contentAdmin: document.getElementById('content-admin'),
            
            // Admin elements
            adminAccessRequired: document.getElementById('admin-access-required'),
            adminContent: document.getElementById('admin-content'),
            refreshAdminData: document.getElementById('refresh-admin-data'),
            exportData: document.getElementById('export-data'),
            fixUserData: document.getElementById('fix-user-data'),
            filterNama: document.getElementById('filter-nama'),
            filterTanggal: document.getElementById('filter-tanggal'),
            filterShift: document.getElementById('filter-shift'),
            applyFilters: document.getElementById('apply-filters'),
            clearFilters: document.getElementById('clear-filters'),
            viewTable: document.getElementById('view-table'),
            viewCalendar: document.getElementById('view-calendar'),
            viewStatistics: document.getElementById('view-statistics'),
            tableView: document.getElementById('table-view'),
            calendarView: document.getElementById('calendar-view'),
            statisticsView: document.getElementById('statistics-view'),
            adminTableBody: document.getElementById('admin-table-body'),
            calendarContainer: document.getElementById('calendar-container'),
            currentMonth: document.getElementById('current-month'),
            prevMonth: document.getElementById('prev-month'),
            nextMonth: document.getElementById('next-month'),
            statsWeekly: document.getElementById('stats-weekly'),
            statsMonthly: document.getElementById('stats-monthly'),
            statsYearly: document.getElementById('stats-yearly'),
            chartsContainer: document.getElementById('charts-container'),
            
            // Edit form
            editForm: document.getElementById('edit-form'),
            editId: document.getElementById('edit-id'),
            editTanggal: document.getElementById('edit-tanggal'),
            editNama: document.getElementById('edit-nama'),
            editShift: document.getElementById('edit-shift'),
            editWaktuDatang: document.getElementById('edit-waktu-datang'),
            editWaktuPulang: document.getElementById('edit-waktu-pulang'),
            editKeterlambatan: document.getElementById('edit-keterlambatan'),
            editLembur: document.getElementById('edit-lembur'),
            cancelEdit: document.getElementById('cancel-edit'),
            
            // Display elements
            displayName: document.getElementById('display-name'),
            currentDatetime: document.getElementById('current-datetime'),
            locationDisplay: document.getElementById('location-display'),
            locationDisplayPulang: document.getElementById('location-display-pulang'),
            absenList: document.getElementById('absen-list'),
            searchAbsen: document.getElementById('search-absen'),
            
            // Statistics
            totalAbsensi: document.getElementById('total-absensi'),
            avgLate: document.getElementById('avg-late'),
            totalLate: document.getElementById('total-late')
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // Check if we're returning from a refresh and have a user stored
            const storedUser = localStorage.getItem('currentUser');
            const storedAdmin = localStorage.getItem('isAdmin') === 'true';
            
            if (storedUser) {
                state.currentUser = storedUser;
                state.isAdmin = storedAdmin;
                elements.welcomeModal.classList.add('hidden');
                elements.mainContent.classList.remove('hidden');
                elements.displayName.textContent = storedUser;
                
                // Update admin state
                updateAdminState();
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Welcome modal
            elements.startBtn.addEventListener('click', handleStart);
            elements.nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleStart();
            });
            
            // Header buttons
            elements.adminAccessBtn.addEventListener('click', showAdminLogin);
            elements.userLogout.addEventListener('click', handleLogout);
            
            // Admin login modal
            elements.adminLoginSubmit.addEventListener('click', handleAdminLogin);
            elements.adminLoginCancel.addEventListener('click', hideAdminLogin);
            elements.adminPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAdminLogin();
            });
            
            // Admin login from tab
            elements.adminLoginFromTab.addEventListener('click', showAdminLogin);
            
            // Tabs
            elements.tabDatang.addEventListener('click', () => switchTab('datang'));
            elements.tabPulang.addEventListener('click', () => switchTab('pulang'));
            elements.tabAdmin.addEventListener('click', () => switchTab('admin'));
            
            // Location buttons
            elements.getLocationBtn.addEventListener('click', getCurrentLocation);
            elements.getLocationBtnPulang.addEventListener('click', getCurrentLocationPulang);
            
            // Absen buttons
            elements.absenDatangBtn.addEventListener('click', submitAbsenDatang);
            elements.absenPulangBtn.addEventListener('click', submitAbsenPulang);
            elements.refreshAbsenBtn.addEventListener('click', loadAbsenDatangList);
            
            // Search
            elements.searchAbsen.addEventListener('input', filterAbsenList);
            
            // Admin controls
            elements.refreshAdminData.addEventListener('click', loadAllAttendanceData);
            elements.exportData.addEventListener('click', exportDataToCSV);
            elements.fixUserData.addEventListener('click', showFixUserDataModal);
            elements.generatePdf.addEventListener('click', showPdfExportModal);
            elements.generatePdfBtn.addEventListener('click', generatePdfReport);
            elements.cancelPdfExport.addEventListener('click', hidePdfExportModal);
            
            // PDF Export options
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    const type = e.currentTarget.dataset.type;
                    toggleExportOption(type, e.currentTarget);
                });
            });
            
            // Filters
            elements.applyFilters.addEventListener('click', applyAdminFilters);
            elements.clearFilters.addEventListener('click', clearAdminFilters);
            
            // View options
            elements.viewTable.addEventListener('click', () => switchAdminView('table'));
            elements.viewCalendar.addEventListener('click', () => switchAdminView('calendar'));
            elements.viewStatistics.addEventListener('click', () => switchAdminView('statistics'));
            
            // Calendar navigation
            elements.prevMonth.addEventListener('click', prevMonth);
            elements.nextMonth.addEventListener('click', nextMonth);
            
            // Statistics period
            elements.statsWeekly.addEventListener('click', () => switchStatsPeriod('weekly'));
            elements.statsMonthly.addEventListener('click', () => switchStatsPeriod('monthly'));
            elements.statsYearly.addEventListener('click', () => switchStatsPeriod('yearly'));
            
            // Edit modal
            elements.editForm.addEventListener('submit', handleEditSubmit);
            elements.cancelEdit.addEventListener('click', hideEditModal);
        }

        // Handle start button click
        function handleStart() {
            const name = elements.nameInput.value.trim();
            if (!name) {
                showToast('Harap masukkan nama kamu!', 'error');
                return;
            }
            
            state.currentUser = name;
            localStorage.setItem('currentUser', name);
            elements.displayName.textContent = name;
            elements.welcomeModal.classList.add('hidden');
            elements.mainContent.classList.remove('hidden');
            
            showToast(`Selamat datang, ${name}!`, 'success');
            
            // Update admin state
            updateAdminState();
        }

        // Handle logout
        function handleLogout() {
            state.currentUser = null;
            state.isAdmin = false;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isAdmin');
            
            elements.mainContent.classList.add('hidden');
            elements.welcomeModal.classList.remove('hidden');
            elements.nameInput.value = '';
            
            showToast('Berhasil logout!', 'success');
        }

        // Show admin login modal
        function showAdminLogin() {
            elements.adminLoginModal.classList.remove('hidden');
        }

        // Hide admin login modal
        function hideAdminLogin() {
            elements.adminLoginModal.classList.add('hidden');
            elements.adminPassword.value = '';
        }

        // Handle admin login
        function handleAdminLogin() {
            const password = elements.adminPassword.value.trim();
            if (password === '112211') {
                state.isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                hideAdminLogin();
                updateAdminState();
                
                // If on admin tab, load data
                if (state.currentTab === 'admin') {
                    loadAllAttendanceData();
                }
                
                showToast('Berhasil login sebagai admin!', 'success');
            } else {
                showToast('Password admin salah!', 'error');
            }
        }

        // Update admin state in UI
        function updateAdminState() {
            if (state.isAdmin) {
                // User is admin
                elements.tabAdmin.classList.remove('admin-locked');
                elements.adminAccessBtn.textContent = 'Admin Mode';
                elements.adminAccessBtn.classList.remove('bg-purple-500');
                elements.adminAccessBtn.classList.add('bg-green-500');
                
                // Show admin content if on admin tab
                if (state.currentTab === 'admin') {
                    elements.adminAccessRequired.classList.add('hidden');
                    elements.adminContent.classList.remove('hidden');
                }
            } else {
                // User is not admin
                elements.tabAdmin.classList.add('admin-locked');
                elements.adminAccessBtn.textContent = 'Admin Access';
                elements.adminAccessBtn.classList.remove('bg-green-500');
                elements.adminAccessBtn.classList.add('bg-purple-500');
                
                // Show access required message if on admin tab
                if (state.currentTab === 'admin') {
                    elements.adminAccessRequired.classList.remove('hidden');
                    elements.adminContent.classList.add('hidden');
                }
            }
        }

        // Switch between tabs
        function switchTab(tab) {
            // Update tab states
            elements.tabDatang.classList.remove('tab-active');
            elements.tabDatang.classList.add('tab-inactive');
            elements.tabPulang.classList.remove('tab-active');
            elements.tabPulang.classList.add('tab-inactive');
            elements.tabAdmin.classList.remove('tab-active');
            elements.tabAdmin.classList.add('tab-inactive');
            
            elements.contentDatang.classList.add('hidden');
            elements.contentPulang.classList.add('hidden');
            elements.contentAdmin.classList.add('hidden');
            
            // Activate selected tab
            state.currentTab = tab;
            switch(tab) {
                case 'datang':
                    elements.tabDatang.classList.remove('tab-inactive');
                    elements.tabDatang.classList.add('tab-active');
                    elements.contentDatang.classList.remove('hidden');
                    break;
                case 'pulang':
                    elements.tabPulang.classList.remove('tab-inactive');
                    elements.tabPulang.classList.add('tab-active');
                    elements.contentPulang.classList.remove('hidden');
                    loadAbsenDatangList();
                    break;
                case 'admin':
                    elements.tabAdmin.classList.remove('tab-inactive');
                    elements.tabAdmin.classList.add('tab-active');
                    elements.contentAdmin.classList.remove('hidden');
                    
                    // Check if user is admin
                    if (state.isAdmin) {
                        elements.adminAccessRequired.classList.add('hidden');
                        elements.adminContent.classList.remove('hidden');
                        loadAllAttendanceData();
                    } else {
                        elements.adminAccessRequired.classList.remove('hidden');
                        elements.adminContent.classList.add('hidden');
                    }
                    break;
            }
        }

        // Get current location for datang
        function getCurrentLocation() {
            elements.getLocationBtn.disabled = true;
            elements.getLocationBtn.innerHTML = '<div class="loading-spinner"></div>Mendapatkan lokasi...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        state.currentLocation = { lat, lng };
                        
                        // Get address from coordinates
                        getAddressFromCoords(lat, lng, elements.locationDisplay);
                        
                        elements.absenDatangBtn.disabled = false;
                        elements.getLocationBtn.disabled = false;
                        elements.getLocationBtn.textContent = 'üìç Dapatkan Lokasi';
                    },
                    (error) => {
                        handleLocationError(error, elements.locationDisplay);
                        elements.getLocationBtn.disabled = false;
                        elements.getLocationBtn.textContent = 'üìç Dapatkan Lokasi';
                    }
                );
            } else {
                elements.locationDisplay.textContent = 'Geolocation tidak didukung oleh browser ini';
                elements.getLocationBtn.disabled = false;
                elements.getLocationBtn.textContent = 'üìç Dapatkan Lokasi';
            }
        }

        // Get current location for pulang
        function getCurrentLocationPulang() {
            elements.getLocationBtnPulang.disabled = true;
            elements.getLocationBtnPulang.innerHTML = '<div class="loading-spinner"></div>Mendapatkan lokasi...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        state.currentLocation = { lat, lng };
                        
                        // Get address from coordinates
                        getAddressFromCoords(lat, lng, elements.locationDisplayPulang);
                        
                        elements.absenPulangBtn.disabled = false;
                        elements.getLocationBtnPulang.disabled = false;
                        elements.getLocationBtnPulang.textContent = 'üìç Dapatkan Lokasi';
                    },
                    (error) => {
                        handleLocationError(error, elements.locationDisplayPulang);
                        elements.getLocationBtnPulang.disabled = false;
                        elements.getLocationBtnPulang.textContent = 'üìç Dapatkan Lokasi';
                    }
                );
            } else {
                elements.locationDisplayPulang.textContent = 'Geolocation tidak didukung oleh browser ini';
                elements.getLocationBtnPulang.disabled = false;
                elements.getLocationBtnPulang.textContent = 'üìç Dapatkan Lokasi';
            }
        }

        // Get address from coordinates
        function getAddressFromCoords(lat, lng, displayElement) {
            // For demo purposes, we'll use a simple reverse geocoding
            // In a real app, you would use Google Maps Geocoding API or similar
            displayElement.textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`;
            
            // Simulate API call delay
            setTimeout(() => {
                displayElement.textContent = `Lokasi terdeteksi: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }, 1000);
        }

        // Handle location error
        function handleLocationError(error, displayElement) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    displayElement.textContent = "User menolak permintaan geolocation";
                    break;
                case error.POSITION_UNAVAILABLE:
                    displayElement.textContent = "Informasi lokasi tidak tersedia";
                    break;
                case error.TIMEOUT:
                    displayElement.textContent = "Permintaan lokasi timeout";
                    break;
                case error.UNKNOWN_ERROR:
                    displayElement.textContent = "Terjadi error yang tidak diketahui";
                    break;
            }
        }

        // Submit absen datang
        function submitAbsenDatang() {
            if (!state.currentLocation) {
                showToast('Harap dapatkan lokasi terlebih dahulu!', 'error');
                return;
            }
            
            const shift = document.querySelector('input[name="shift"]:checked').value;
            const now = new Date();
            const waktu = now.toTimeString().split(' ')[0]; // Format HH:MM:SS
            
            // Calculate keterlambatan
            let keterlambatan = "Tepat Waktu";
            if (shift === "Pagi" && now.getHours() >= 8) {
                if (now.getHours() > 8 || (now.getHours() === 8 && now.getMinutes() > 0)) {
                    const lateMinutes = (now.getHours() - 8) * 60 + now.getMinutes();
                    keterlambatan = `${lateMinutes} menit`;
                }
            } else if (shift === "Sore" && now.getHours() >= 15) {
                if (now.getHours() > 15 || (now.getHours() === 15 && now.getMinutes() > 0)) {
                    const lateMinutes = (now.getHours() - 15) * 60 + now.getMinutes();
                    keterlambatan = `${lateMinutes} menit`;
                }
            }
            
            const tanggal = formatDate(now);
            
            const data = {
                action: 'absen_datang',
                nama: state.currentUser,
                shift: shift,
                tanggal: tanggal,
                waktu: waktu,
                lokasi: elements.locationDisplay.textContent,
                keterlambatan: keterlambatan,
                latitude: state.currentLocation.lat,
                longitude: state.currentLocation.lng
            };
            
            elements.absenDatangBtn.disabled = true;
            elements.absenDatangBtn.innerHTML = '<div class="loading-spinner"></div>Mengirim...';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    showToast('Absen datang berhasil disimpan!', 'success');
                    // Reset form
                    elements.locationDisplay.textContent = 'Lokasi akan tampil di sini...';
                    elements.absenDatangBtn.disabled = true;
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            })
            .finally(() => {
                elements.absenDatangBtn.disabled = false;
                elements.absenDatangBtn.textContent = 'Absen Datang & Kirim';
            });
        }

        // Submit absen pulang
        function submitAbsenPulang() {
            if (!state.currentLocation) {
                showToast('Harap dapatkan lokasi terlebih dahulu!', 'error');
                return;
            }
            
            const selectedAbsen = document.querySelector('.attendance-item.selected');
            if (!selectedAbsen) {
                showToast('Harap pilih absen datang yang sesuai!', 'error');
                return;
            }
            
            const absenDatangId = selectedAbsen.dataset.id;
            const shift = document.querySelector('input[name="shift"]:checked').value;
            const now = new Date();
            const waktu = now.toTimeString().split(' ')[0]; // Format HH:MM:SS
            
            // Calculate lembur
            let lembur = "Tidak ada";
            if (shift === "Pagi" && now.getHours() >= 17) {
                if (now.getHours() > 17 || (now.getHours() === 17 && now.getMinutes() > 0)) {
                    const overtimeMinutes = (now.getHours() - 17) * 60 + now.getMinutes();
                    lembur = `${overtimeMinutes} menit`;
                }
            } else if (shift === "Sore" && now.getHours() >= 21) {
                if (now.getHours() > 21 || (now.getHours() === 21 && now.getMinutes() > 30)) {
                    const overtimeMinutes = (now.getHours() - 21) * 60 + (now.getMinutes() - 30);
                    lembur = `${overtimeMinutes} menit`;
                }
            }
            
            const tanggal = formatDate(now);
            
            const data = {
                action: 'absen_pulang',
                absen_datang_id: absenDatangId,
                nama: state.currentUser,
                shift: shift,
                tanggal: tanggal,
                waktu: waktu,
                lokasi: elements.locationDisplayPulang.textContent,
                lembur: lembur,
                latitude: state.currentLocation.lat,
                longitude: state.currentLocation.lng
            };
            
            elements.absenPulangBtn.disabled = true;
            elements.absenPulangBtn.innerHTML = '<div class="loading-spinner"></div>Mengirim...';
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    showToast('Absen pulang berhasil disimpan!', 'success');
                    // Reset form
                    elements.locationDisplayPulang.textContent = 'Lokasi akan tampil di sini...';
                    elements.absenPulangBtn.disabled = true;
                    loadAbsenDatangList();
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            })
            .finally(() => {
                elements.absenPulangBtn.disabled = false;
                elements.absenPulangBtn.textContent = 'Absen Pulang & Kirim';
            });
        }

        // Load absen datang list for pulang tab
        function loadAbsenDatangList() {
            elements.absenList.innerHTML = '<p class="text-center text-gray-500 py-4">Memuat data...</p>';
            
            fetch(`${SCRIPT_URL}?action=get_attendance&nama=${encodeURIComponent(state.currentUser)}`)
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    state.absenDatangList = result.data;
                    renderAbsenDatangList();
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                elements.absenList.innerHTML = `<p class="text-center text-red-500 py-4">Error: ${error.message}</p>`;
            });
        }

        // Render absen datang list
        function renderAbsenDatangList() {
            if (state.absenDatangList.length === 0) {
                elements.absenList.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada data absen datang yang belum pulang</p>';
                return;
            }
            
            let html = '';
            state.absenDatangList.forEach(absen => {
                html += `
                    <div class="attendance-item bg-white p-3 rounded-lg border border-gray-200 cursor-pointer" data-id="${absen.id}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium">${absen.tanggal}</p>
                                <p class="text-sm text-gray-600">Shift: ${absen.shift} | Datang: ${absen.waktu}</p>
                                <p class="text-xs text-gray-500 truncate">${absen.lokasi}</p>
                            </div>
                            <span class="status-badge bg-yellow-100 text-yellow-800">Belum Pulang</span>
                        </div>
                    </div>
                `;
            });
            
            elements.absenList.innerHTML = html;
            
            // Add click event to items
            document.querySelectorAll('.attendance-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.attendance-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                });
            });
        }

        // Filter absen list
        function filterAbsenList() {
            const searchTerm = elements.searchAbsen.value.toLowerCase();
            const items = elements.absenList.querySelectorAll('.attendance-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Load all attendance data for admin
        function loadAllAttendanceData() {
            if (!state.isAdmin) {
                showToast('Anda harus login sebagai admin untuk mengakses data ini', 'error');
                return;
            }
            
            fetch(`${SCRIPT_URL}?action=get_all_attendance`)
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    state.allAttendanceData = result.data;
                    state.filteredAttendanceData = result.data;
                    renderAdminTable();
                    renderCalendar();
                    loadStatistics();
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Render admin table
        function renderAdminTable() {
            if (state.filteredAttendanceData.length === 0) {
                elements.adminTableBody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">Tidak ada data absensi</td></tr>';
                return;
            }
            
            let html = '';
            state.filteredAttendanceData.forEach(item => {
                const statusClass = item.status === 'Hadir' ? 'bg-yellow-100 text-yellow-800' : 
                                  item.status === 'Pulang' ? 'bg-green-100 text-green-800' : 
                                  'bg-blue-100 text-blue-800';
                
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">${item.tanggal}</td>
                        <td class="px-4 py-3">${item.nama}</td>
                        <td class="px-4 py-3">${item.shift}</td>
                        <td class="px-4 py-3">${item.waktu_datang || '-'}</td>
                        <td class="px-4 py-3">${item.keterlambatan || '-'}</td>
                        <td class="px-4 py-3">${item.waktu_pulang || '-'}</td>
                        <td class="px-4 py-3">${item.total_jam_kerja || '-'}</td>
                        <td class="px-4 py-3"><span class="status-badge ${statusClass}">${item.status}</span></td>
                        <td class="px-4 py-3">
                            <button class="edit-btn bg-blue-500 text-white px-3 py-1 rounded text-xs mr-1" data-id="${item.id}">Edit</button>
                            <button class="delete-btn bg-red-500 text-white px-3 py-1 rounded text-xs" data-id="${item.id}">Hapus</button>
                        </td>
                    </tr>
                `;
            });
            
            elements.adminTableBody.innerHTML = html;
            
            // Add event listeners to buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    showEditModal(id);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    deleteAttendance(id);
                });
            });
        }

        // Apply admin filters
        function applyAdminFilters() {
            const nama = elements.filterNama.value.trim().toLowerCase();
            const tanggal = elements.filterTanggal.value;
            const shift = elements.filterShift.value;
            
            state.filteredAttendanceData = state.allAttendanceData.filter(item => {
                if (nama && !item.nama.toLowerCase().includes(nama)) return false;
                if (tanggal) {
                    const itemDate = new Date(item.tanggal.split(' ').reverse().join('-'));
                    const filterDate = new Date(tanggal);
                    if (itemDate.toDateString() !== filterDate.toDateString()) return false;
                }
                if (shift && item.shift !== shift) return false;
                return true;
            });
            
            renderAdminTable();
            renderCalendar();
        }

        // Clear admin filters
        function clearAdminFilters() {
            elements.filterNama.value = '';
            elements.filterTanggal.value = '';
            elements.filterShift.value = '';
            state.filteredAttendanceData = state.allAttendanceData;
            renderAdminTable();
            renderCalendar();
        }

        // Switch admin view
        function switchAdminView(view) {
            elements.tableView.classList.add('hidden');
            elements.calendarView.classList.add('hidden');
            elements.statisticsView.classList.add('hidden');
            
            elements.viewTable.classList.remove('btn-secondary');
            elements.viewCalendar.classList.remove('btn-secondary');
            elements.viewStatistics.classList.remove('btn-secondary');
            
            elements.viewTable.classList.add('bg-gray-300', 'text-gray-700');
            elements.viewCalendar.classList.add('bg-gray-300', 'text-gray-700');
            elements.viewStatistics.classList.add('bg-gray-300', 'text-gray-700');
            
            switch(view) {
                case 'table':
                    elements.tableView.classList.remove('hidden');
                    elements.viewTable.classList.remove('bg-gray-300', 'text-gray-700');
                    elements.viewTable.classList.add('btn-secondary');
                    break;
                case 'calendar':
                    elements.calendarView.classList.remove('hidden');
                    elements.viewCalendar.classList.remove('bg-gray-300', 'text-gray-700');
                    elements.viewCalendar.classList.add('btn-secondary');
                    renderCalendar();
                    break;
                case 'statistics':
                    elements.statisticsView.classList.remove('hidden');
                    elements.viewStatistics.classList.remove('bg-gray-300', 'text-gray-700');
                    elements.viewStatistics.classList.add('btn-secondary');
                    loadStatistics();
                    break;
            }
        }

        // Render calendar with color coding for shifts
        function renderCalendar() {
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni",
                "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            elements.currentMonth.textContent = `${monthNames[state.calendarMonth]} ${state.calendarYear}`;
            
            // Get first day of month and number of days
            const firstDay = new Date(state.calendarYear, state.calendarMonth, 1);
            const lastDay = new Date(state.calendarYear, state.calendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Create calendar header
            let html = '';
            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            dayNames.forEach(day => {
                html += `<div class="text-center font-bold py-2 bg-gray-100">${day}</div>`;
            });
            
            // Add empty cells for days before the first day of the month
            for (let i = 0; i < startingDay; i++) {
                html += `<div class="calendar-day bg-gray-50"></div>`;
            }
            
            // Add cells for each day of the month
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(state.calendarYear, state.calendarMonth, day);
                const dateString = formatDate(date);
                const isToday = date.toDateString() === today.toDateString();
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                let dayClass = "calendar-day";
                if (isToday) dayClass += " today";
                if (isWeekend) dayClass += " weekend";
                
                // Apply background color based on shifts for this day
                const dayEvents = state.filteredAttendanceData.filter(item => {
                    const itemDate = new Date(item.tanggal.split(' ').reverse().join('-'));
                    return itemDate.toDateString() === date.toDateString();
                });
                
                // Count shifts for background color
                const pagiCount = dayEvents.filter(e => e.shift === 'Pagi').length;
                const soreCount = dayEvents.filter(e => e.shift === 'Sore').length;
                
                if (pagiCount > 0 && soreCount === 0) {
                    dayClass += " shift-pagi";
                } else if (soreCount > 0 && pagiCount === 0) {
                    dayClass += " shift-sore";
                } else if (pagiCount > 0 && soreCount > 0) {
                    // Mixed shifts - gradient background
                    dayClass += " bg-gradient-to-br from-green-100 to-red-100";
                }
                
                html += `<div class="${dayClass}">`;
                html += `<div class="font-bold mb-1">${day}</div>`;
                
                // Add attendance events for this day
                dayEvents.forEach(event => {
                    const eventClass = `calendar-event ${event.shift.toLowerCase()}`;
                    html += `<div class="${eventClass}" title="${event.nama} - ${event.shift}">${event.nama} (${event.shift})</div>`;
                });
                
                html += `</div>`;
            }
            
            elements.calendarContainer.innerHTML = html;
        }

        // Navigate to previous month
        function prevMonth() {
            state.calendarMonth--;
            if (state.calendarMonth < 0) {
                state.calendarMonth = 11;
                state.calendarYear--;
            }
            renderCalendar();
        }

        // Navigate to next month
        function nextMonth() {
            state.calendarMonth++;
            if (state.calendarMonth > 11) {
                state.calendarMonth = 0;
                state.calendarYear++;
            }
            renderCalendar();
        }

        // Switch statistics period
        function switchStatsPeriod(period) {
            state.currentStatsPeriod = period;
            
            // Update button states
            elements.statsWeekly.classList.remove('btn-secondary');
            elements.statsMonthly.classList.remove('btn-secondary');
            elements.statsYearly.classList.remove('btn-secondary');
            
            elements.statsWeekly.classList.add('bg-gray-300', 'text-gray-700');
            elements.statsMonthly.classList.add('bg-gray-300', 'text-gray-700');
            elements.statsYearly.classList.add('bg-gray-300', 'text-gray-700');
            
            switch(period) {
                case 'weekly':
                    elements.statsWeekly.classList.remove('bg-gray-300', 'text-gray-700');
                    elements.statsWeekly.classList.add('btn-secondary');
                    loadWeeklyStats();
                    break;
                case 'monthly':
                    elements.statsMonthly.classList.remove('bg-gray-300', 'text-gray-700');
                    elements.statsMonthly.classList.add('btn-secondary');
                    loadMonthlyStats();
                    break;
                case 'yearly':
                    elements.statsYearly.classList.remove('bg-gray-300', 'text-gray-700');
                    elements.statsYearly.classList.add('btn-secondary');
                    loadYearlyStats();
                    break;
            }
        }

        // Load statistics
        function loadStatistics() {
            fetch(`${SCRIPT_URL}?action=get_statistics`)
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    renderStatistics(result.statistics);
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Load weekly statistics
        function loadWeeklyStats() {
            fetch(`${SCRIPT_URL}?action=get_weekly_stats`)
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    renderWeeklyStats(result.weekly_stats);
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Load monthly statistics
        function loadMonthlyStats() {
            fetch(`${SCRIPT_URL}?action=get_monthly_stats`)
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    renderMonthlyStats(result.monthly_stats);
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Load yearly statistics
        function loadYearlyStats() {
            fetch(`${SCRIPT_URL}?action=get_yearly_stats`)
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    renderYearlyStats(result.yearly_stats);
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Render statistics
        function renderStatistics(statistics) {
            elements.totalAbsensi.textContent = statistics.total_absensi;
            elements.avgLate.textContent = statistics.rata_rata_keterlambatan + ' menit';
            elements.totalLate.textContent = statistics.total_keterlambatan + ' menit';
        }

        // Render weekly statistics
        function renderWeeklyStats(weeklyStats) {
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <h4 class="font-bold text-lg mb-4">Perbandingan Shift</h4>
                        <div class="chart-container">
                            <canvas id="chart-shift-comparison-weekly"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-lg mb-4">Absensi per Hari</h4>
                        <div class="chart-container">
                            <canvas id="chart-daily-stats-weekly"></canvas>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <h4 class="font-bold text-lg mb-4">Perbandingan Antar Bidan</h4>
                        <div class="chart-container">
                            <canvas id="chart-bidan-comparison-weekly"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            elements.chartsContainer.innerHTML = html;
            
            // Render shift comparison chart
            const shiftCtx = document.getElementById('chart-shift-comparison-weekly').getContext('2d');
            if (state.charts.shiftComparisonWeekly) {
                state.charts.shiftComparisonWeekly.destroy();
            }
            
            state.charts.shiftComparisonWeekly = new Chart(shiftCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Shift Pagi', 'Shift Sore'],
                    datasets: [{
                        data: [weeklyStats.shift_comparison.Pagi, weeklyStats.shift_comparison.Sore],
                        backgroundColor: ['#38a169', '#e53e3e'],
                        borderColor: ['#2f855a', '#c53030'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Shift Mingguan'
                        }
                    }
                }
            });
            
            // Render daily stats chart
            const dailyCtx = document.getElementById('chart-daily-stats-weekly').getContext('2d');
            if (state.charts.dailyStatsWeekly) {
                state.charts.dailyStatsWeekly.destroy();
            }
            
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const pagiData = days.map(day => weeklyStats.days[day]?.Pagi || 0);
            const soreData = days.map(day => weeklyStats.days[day]?.Sore || 0);
            
            state.charts.dailyStatsWeekly = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [
                        {
                            label: 'Shift Pagi',
                            data: pagiData,
                            backgroundColor: 'rgba(56, 161, 105, 0.7)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Shift Sore',
                            data: soreData,
                            backgroundColor: 'rgba(229, 62, 62, 0.7)',
                            borderColor: 'rgba(229, 62, 62, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Absensi'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hari'
                            }
                        }
                    }
                }
            });
            
            // Render bidan comparison chart
            const bidanCtx = document.getElementById('chart-bidan-comparison-weekly').getContext('2d');
            if (state.charts.bidanComparisonWeekly) {
                state.charts.bidanComparisonWeekly.destroy();
            }
            
            const bidanNames = Object.keys(weeklyStats.nama_comparison);
            const bidanPagiData = bidanNames.map(nama => weeklyStats.nama_comparison[nama].Pagi);
            const bidanSoreData = bidanNames.map(nama => weeklyStats.nama_comparison[nama].Sore);
            
            state.charts.bidanComparisonWeekly = new Chart(bidanCtx, {
                type: 'bar',
                data: {
                    labels: bidanNames,
                    datasets: [
                        {
                            label: 'Shift Pagi',
                            data: bidanPagiData,
                            backgroundColor: 'rgba(56, 161, 105, 0.7)',
                            borderColor: 'rgba(56, 161, 105, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Shift Sore',
                            data: bidanSoreData,
                            backgroundColor: 'rgba(229, 62, 62, 0.7)',
                            borderColor: 'rgba(229, 62, 62, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Jumlah Absensi'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Nama Bidan'
                            }
                        }
                    }
                }
            });
        }

        // Render monthly statistics
        function renderMonthlyStats(monthlyStats) {
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <h4 class="font-bold text-lg mb-4">Perbandingan Shift Bulanan</h4>
                        <div class="chart-container">
                            <canvas id="chart-shift-comparison-monthly"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-lg mb-4">Absensi per Minggu</h4>
                        <div class="chart-container">
                            <canvas id="chart-weekly-stats-monthly"></canvas>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <h4 class="font-bold text-lg mb-4">Perbandingan Antar Bidan (Bulanan)</h4>
                        <div class="chart-container">
                            <canvas id="chart-bidan-comparison-monthly"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            elements.chartsContainer.innerHTML = html;
            
            // Similar chart rendering for monthly stats
            // Implementation would follow the same pattern as weekly stats
        }

        // Render yearly statistics
        function renderYearlyStats(yearlyStats) {
            let html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <h4 class="font-bold text-lg mb-4">Perbandingan Shift Tahunan</h4>
                        <div class="chart-container">
                            <canvas id="chart-shift-comparison-yearly"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-lg mb-4">Absensi per Bulan</h4>
                        <div class="chart-container">
                            <canvas id="chart-monthly-stats-yearly"></canvas>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-6">
                    <div>
                        <h4 class="font-bold text-lg mb-4">Perbandingan Antar Bidan (Tahunan)</h4>
                        <div class="chart-container">
                            <canvas id="chart-bidan-comparison-yearly"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            elements.chartsContainer.innerHTML = html;
            
            // Similar chart rendering for yearly stats
            // Implementation would follow the same pattern as weekly stats
        }

        // Show edit modal
        function showEditModal(id) {
            const item = state.filteredAttendanceData.find(i => i.id === id);
            if (!item) return;
            
            // Convert tanggal to YYYY-MM-DD format
            const dateParts = item.tanggal.split(' ');
            const formattedDate = `${dateParts[2]}-${getMonthNumber(dateParts[1]) + 1}-${dateParts[0]}`;
            
            elements.editId.value = item.id;
            elements.editTanggal.value = formattedDate;
            elements.editNama.value = item.nama;
            elements.editShift.value = item.shift;
            elements.editWaktuDatang.value = item.waktu_datang || '';
            elements.editWaktuPulang.value = item.waktu_pulang || '';
            elements.editKeterlambatan.value = item.keterlambatan || '';
            elements.editLembur.value = item.lembur || '';
            
            elements.editModal.classList.remove('hidden');
        }

        // Hide edit modal
        function hideEditModal() {
            elements.editModal.classList.add('hidden');
        }

        // Handle edit form submission
        function handleEditSubmit(e) {
            e.preventDefault();
            
            const data = {
                action: 'update_attendance',
                id: elements.editId.value,
                tanggal: elements.editTanggal.value,
                nama: elements.editNama.value,
                shift: elements.editShift.value,
                waktu_datang: elements.editWaktuDatang.value,
                waktu_pulang: elements.editWaktuPulang.value,
                keterlambatan: elements.editKeterlambatan.value,
                lembur: elements.editLembur.value,
                total_jam_kerja: calculateWorkingHours(elements.editWaktuDatang.value, elements.editWaktuPulang.value)
            };
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    showToast('Data berhasil diperbarui!', 'success');
                    hideEditModal();
                    loadAllAttendanceData();
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Delete attendance record
        function deleteAttendance(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
            
            const data = {
                action: 'delete_attendance',
                id: id
            };
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    showToast('Data berhasil dihapus!', 'success');
                    loadAllAttendanceData();
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Show fix user data modal
        function showFixUserDataModal() {
            const namaLama = prompt("Masukkan nama lama:");
            if (!namaLama) return;
            
            const namaBaru = prompt("Masukkan nama baru:");
            if (!namaBaru) return;
            
            const data = {
                action: 'fix_user_data',
                nama_lama: namaLama,
                nama_baru: namaBaru
            };
            
            fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.result === 'success') {
                    showToast(`Berhasil memperbaiki ${result.updated} data!`, 'success');
                    loadAllAttendanceData();
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showToast(`Error: ${error.message}`, 'error');
            });
        }

        // Export data to CSV
        function exportDataToCSV() {
            const headers = ["Tanggal", "Nama", "Shift", "Waktu Datang", "Keterlambatan", "Waktu Pulang", "Lembur", "Total Jam Kerja", "Status"];
            let csv = headers.join(",") + "\n";
            
            state.filteredAttendanceData.forEach(item => {
                const row = [
                    item.tanggal,
                    item.nama,
                    item.shift,
                    item.waktu_datang || '',
                    item.keterlambatan || '',
                    item.waktu_pulang || '',
                    item.lembur || '',
                    item.total_jam_kerja || '',
                    item.status
                ];
                csv += row.map(field => `"${field}"`).join(",") + "\n";
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `absensi_${formatDate(new Date())}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Data berhasil diexport!', 'success');
        }

        // Show PDF export modal
        function showPdfExportModal() {
            state.selectedExports.clear();
            document.querySelectorAll('.export-option').forEach(option => {
                option.classList.remove('selected');
            });
            elements.pdfExportModal.classList.remove('hidden');
        }

        // Hide PDF export modal
        function hidePdfExportModal() {
            elements.pdfExportModal.classList.add('hidden');
        }

        // Toggle export option selection
        function toggleExportOption(type, element) {
            if (state.selectedExports.has(type)) {
                state.selectedExports.delete(type);
                element.classList.remove('selected');
            } else {
                state.selectedExports.add(type);
                element.classList.add('selected');
            }
        }

        // Generate PDF report
        function generatePdfReport() {
            if (state.selectedExports.size === 0) {
                showToast('Pilih setidaknya satu jenis laporan!', 'error');
                return;
            }

            showToast('Membuat PDF report...', 'success');
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            let yPosition = 20;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            
            // Add header
            pdf.setFontSize(20);
            pdf.setTextColor(40, 40, 40);
            pdf.text('LAPORAN ABSENSI BIDAN', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 10;
            
            pdf.setFontSize(12);
            pdf.setTextColor(100, 100, 100);
            pdf.text(`Tanggal Generate: ${new Date().toLocaleDateString('id-ID')}`, pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 20;
            
            // Generate selected reports
            const promises = [];
            
            if (state.selectedExports.has('table')) {
                promises.push(generateTablePDF(pdf, yPosition));
            }
            
            if (state.selectedExports.has('calendar')) {
                promises.push(generateCalendarPDF(pdf, yPosition));
            }
            
            if (state.selectedExports.has('statistics')) {
                promises.push(generateStatisticsPDF(pdf, yPosition));
            }
            
            // Wait for all promises to complete
            Promise.all(promises).then(() => {
                pdf.save(`laporan_absensi_${formatDateForFilename(new Date())}.pdf`);
                hidePdfExportModal();
                showToast('PDF report berhasil di-generate!', 'success');
            }).catch(error => {
                console.error('Error generating PDF:', error);
                showToast('Error generating PDF report', 'error');
            });
        }

        // Generate table PDF
        function generateTablePDF(pdf, startY) {
            return new Promise((resolve) => {
                // Add table title
                pdf.setFontSize(16);
                pdf.setTextColor(40, 40, 40);
                pdf.text('DATA TABEL ABSENSI', 20, startY);
                
                // Create table data
                const headers = [['Tanggal', 'Nama', 'Shift', 'Waktu Datang', 'Keterlambatan', 'Waktu Pulang', 'Status']];
                const tableData = state.filteredAttendanceData.map(item => [
                    item.tanggal,
                    item.nama,
                    item.shift,
                    item.waktu_datang || '-',
                    item.keterlambatan || '-',
                    item.waktu_pulang || '-',
                    item.status
                ]);
                
                const allData = headers.concat(tableData);
                
                // Simple table implementation
                let y = startY + 10;
                const colWidths = [30, 35, 20, 25, 30, 25, 25];
                const xStart = 20;
                
                // Draw table headers
                pdf.setFontSize(10);
                pdf.setFillColor(240, 240, 240);
                let x = xStart;
                
                headers[0].forEach((header, i) => {
                    pdf.rect(x, y, colWidths[i], 10, 'F');
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(header, x + 2, y + 7);
                    x += colWidths[i];
                });
                
                y += 10;
                
                // Draw table rows
                tableData.forEach((row, rowIndex) => {
                    if (y > pageHeight - 20) {
                        pdf.addPage();
                        y = 20;
                    }
                    
                    x = xStart;
                    row.forEach((cell, cellIndex) => {
                        pdf.setTextColor(0, 0, 0);
                        pdf.text(cell.substring(0, 15), x + 2, y + 7);
                        x += colWidths[cellIndex];
                    });
                    y += 10;
                });
                
                resolve();
            });
        }

        // Generate calendar PDF
        function generateCalendarPDF(pdf, startY) {
            return new Promise((resolve) => {
                // Add calendar title
                pdf.setFontSize(16);
                pdf.setTextColor(40, 40, 40);
                pdf.text('KALENDER ABSENSI', 20, startY);
                
                // Simple calendar representation
                pdf.setFontSize(10);
                let y = startY + 15;
                const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni",
                    "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                
                pdf.text(`Bulan: ${monthNames[state.calendarMonth]} ${state.calendarYear}`, 20, y);
                y += 10;
                pdf.text('Total Data: ' + state.filteredAttendanceData.length, 20, y);
                
                resolve();
            });
        }

        // Generate statistics PDF
        function generateStatisticsPDF(pdf, startY) {
            return new Promise((resolve) => {
                // Add statistics title
                pdf.setFontSize(16);
                pdf.setTextColor(40, 40, 40);
                pdf.text('STATISTIK ABSENSI', 20, startY);
                
                // Add summary statistics
                pdf.setFontSize(12);
                let y = startY + 15;
                pdf.text(`Total Absensi: ${state.allAttendanceData.length}`, 20, y);
                y += 10;
                pdf.text(`Rata-rata Keterlambatan: ${elements.avgLate.textContent}`, 20, y);
                y += 10;
                pdf.text(`Total Keterlambatan: ${elements.totalLate.textContent}`, 20, y);
                
                resolve();
            });
        }

        // Calculate working hours
        function calculateWorkingHours(startTime, endTime) {
            if (!startTime || !endTime) return '';
            
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);
            
            let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);
            if (totalMinutes < 0) totalMinutes += 24 * 60;
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            return `${hours} jam ${minutes} menit`;
        }

        // Format date to Indonesian format
        function formatDate(date) {
            const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", 
                           "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            
            return `${day} ${month} ${year}`;
        }

        // Format date for filename
        function formatDateForFilename(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            
            return `${day}-${month}-${year}_${hours}-${minutes}`;
        }

        // Get month number from name
        function getMonthNumber(monthName) {
            const months = {
                'Januari': 0, 'Februari': 1, 'Maret': 2, 'April': 3,
                'Mei': 4, 'Juni': 5, 'Juli': 6, 'Agustus': 7,
                'September': 8, 'Oktober': 9, 'November': 10, 'Desember': 11
            };
            return months[monthName] || 0;
        }

        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", 
                           "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            const dayName = days[now.getDay()];
            const day = now.getDate();
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            const time = now.toLocaleTimeString('id-ID');
            
            elements.currentDatetime.textContent = `${dayName}, ${day} ${month} ${year} - ${time}`;
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = elements.toast;
            const toastMessage = document.getElementById('toast-message');
            
            // Set message and color based on type
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toast.classList.remove('border-green-500');
                toast.classList.add('border-red-500');
            } else {
                toast.classList.remove('border-red-500');
                toast.classList.add('border-green-500');
            }
            
            // Show toast
            toast.classList.remove('hidden');
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>