<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Absensi Klinik Nabilah</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#db2777', // Pink 600
                        primaryLight: '#fce7f3', // Pink 100
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #fdf2f8; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.8); }
        
        /* Spinner Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #db2777; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Scrollbar */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Pulse animation for GPS */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col items-center overflow-hidden bg-pink-50" onload="initApp()">

    <!-- KONFIGURASI -->
    <script>
        // --- GANTI URL INI DENGAN DEPLOYMENT BARU ANDA ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOj9qLKIYWnRqDRRV1kuULYLuRhRfxwY5a4hV5JuJT_2wQIeDdl9kyYh28G-ECGbpv/exec"; 
        
        const CLINIC_LAT = 1.3695652; 
        const CLINIC_LNG = 99.2735516; 
        const MAX_RADIUS_METER = 20000; 

        const SHIFT_RULES = {
            "Pagi": { start: "08:00", end: "17:00", late_tolerance: 15, label: "08:00 - 17:00" },
            "Sore": { start: "15:00", end: "21:30", late_tolerance: 15, label: "15:00 - 21:30" },
            "Jumat Full": { start: "08:00", end: "17:00", late_tolerance: 15, label: "08:00 - 17:00" },
            "Libur": { start: "-", end: "-", late_tolerance: 0, label: "OFF" },
            "Non-Shift": { start: "Bebas", end: "Bebas", late_tolerance: 999, label: "FLEKSIBEL" }
        };
    </script>

    <!-- LOADING SCREEN -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-[99] flex flex-col items-center justify-center hidden">
        <div class="loader mb-2 w-10 h-10 border-4"></div>
        <p id="loadingText" class="text-xs font-bold text-pink-600 animate-pulse">Memproses Data...</p>
    </div>

    <!-- MAIN CONTAINER (Mobile Format: Max Width 480px) -->
    <div class="w-full max-w-md h-full flex flex-col bg-white shadow-2xl relative overflow-hidden sm:rounded-xl sm:my-4 sm:h-[95vh]">
        
        <!-- Decoration Header -->
        <div class="absolute top-0 w-full h-48 bg-gradient-to-b from-pink-500 to-pink-600 -z-0 rounded-b-[40px] shadow-lg"></div>

        <!-- PAGE 1: LOGIN -->
        <section id="loginPage" class="flex-1 flex flex-col justify-center px-8 z-10">
            <div class="glass-panel p-6 rounded-2xl shadow-lg border-t-4 border-pink-400 text-center">
                <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-white shadow-sm">
                    <i class="fas fa-heartbeat text-3xl text-pink-600"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Klinik Nabilah</h1>
                <p class="text-xs text-pink-500 font-bold tracking-wider mb-6">SISTEM E-ABSENSI v4.1</p>
                <p class="text-[10px] text-gray-400 mb-4">Fixed: Issue absen pulang</p>

                <div class="text-left space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 ml-1 uppercase">Nama Anda</label>
                        <div class="relative">
                            <select id="selectNama" class="w-full p-3 pl-4 border border-gray-200 rounded-xl bg-white text-sm focus:ring-2 focus:ring-pink-500 outline-none appearance-none">
                                <option value="">-- Pilih --</option>
                                <optgroup label="Bidan (Shift)">
                                    <option value="Riska">Riska</option>
                                    <option value="Linda">Linda</option>
                                    <option value="Desva">Desva</option>
                                    <option value="Aisyah">Aisyah</option>
                                    <option value="Rina">Rina</option>
                                </optgroup>
                                <optgroup label="Admin / Staff">
                                    <option value="Dina">Dina</option>
                                    <option value="Ropat">Ropat</option>
                                </optgroup>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-300 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-pink-600 to-pink-500 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all text-sm flex justify-center items-center gap-2">
                        Masuk <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <button onclick="showAdminLogin()" class="w-full text-center text-[10px] text-gray-400 py-2 hover:text-pink-600">
                        <i class="fas fa-lock"></i> Login Admin
                    </button>
                    
                    <button onclick="showDebugInfo()" class="w-full text-center text-[8px] text-gray-300 py-1 hover:text-gray-500">
                        <i class="fas fa-bug"></i> Debug Info
                    </button>
                </div>
            </div>
        </section>

        <!-- PAGE 2: DASHBOARD -->
        <section id="userDashboard" class="flex-1 flex flex-col hidden z-10 overflow-hidden">
            <!-- Top Bar -->
            <div class="px-6 pt-6 pb-2 flex justify-between items-center text-white">
                <div>
                    <p class="text-xs opacity-80">Selamat Datang,</p>
                    <h2 class="text-xl font-bold" id="userNameDisplay">User</h2>
                    <p class="text-[10px] bg-white/20 inline-block px-2 py-0.5 rounded-full mt-1" id="currentDateDisplay">...</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="refreshUserData()" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-white/40">
                        <i class="fas fa-sync text-xs"></i>
                    </button>
                    <button onclick="logout()" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-white/40">
                        <i class="fas fa-power-off text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-4 pb-6 hide-scroll">
                
                <!-- Shift Card -->
                <div class="bg-white rounded-2xl p-4 shadow-md mb-4 mt-2 border border-pink-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Jadwal Hari Ini</p>
                            <h3 id="shiftDisplay" class="text-2xl font-bold text-pink-600 mt-1">...</h3>
                            <p id="shiftTimeDisplay" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                <i class="far fa-clock"></i> ...
                            </p>
                        </div>
                        <div class="bg-pink-50 p-2 rounded-lg text-pink-500">
                            <i class="fas fa-calendar-day text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- GPS Status -->
                <div class="flex items-center gap-2 mb-4 bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                    <div class="w-2 h-2 rounded-full bg-gray-300 ml-2" id="gpsIndicator"></div>
                    <div class="flex-1">
                        <p id="locationStatus" class="text-[10px] font-bold text-gray-700">Mencari Lokasi...</p>
                        <p id="distanceStatus" class="text-[10px] text-gray-400 leading-none">Menunggu GPS...</p>
                    </div>
                    <button onclick="requestLocation()" class="text-[8px] bg-gray-100 px-2 py-1 rounded text-gray-500">Refresh</button>
                </div>

                <!-- ACTION BUTTONS GRID (1 Baris 3 Tombol) -->
                <div class="grid grid-cols-3 gap-3 mb-5">
                    <!-- Absen Masuk (Besar) -->
                    <button onclick="submitAbsensi('Hadir')" class="col-span-1 bg-gradient-to-br from-green-500 to-green-600 text-white p-3 rounded-xl shadow-lg shadow-green-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24">
                        <i class="fas fa-fingerprint text-2xl"></i>
                        <span class="text-xs font-bold leading-none mt-1">ABSEN<br>MASUK</span>
                    </button>

                    <!-- Izin -->
                    <button onclick="submitAbsensi('Izin')" class="col-span-1 bg-white border border-blue-100 p-3 rounded-xl shadow-sm active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24 text-blue-500 hover:bg-blue-50">
                        <i class="fas fa-envelope-open-text text-xl"></i>
                        <span class="text-xs font-bold">Izin</span>
                    </button>

                    <!-- Sakit -->
                    <button onclick="submitAbsensi('Sakit')" class="col-span-1 bg-white border border-yellow-100 p-3 rounded-xl shadow-sm active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24 text-yellow-500 hover:bg-yellow-50">
                        <i class="fas fa-procedures text-xl"></i>
                        <span class="text-xs font-bold">Sakit</span>
                    </button>
                </div>

                <!-- STATUS INFO -->
                <div id="todayStatus" class="mb-4 hidden">
                    <div class="bg-blue-50 border border-blue-100 rounded-xl p-3">
                        <p class="text-[10px] text-blue-600 font-bold flex items-center gap-2">
                            <i class="fas fa-info-circle"></i> Status Hari Ini
                        </p>
                        <p class="text-xs text-blue-700 mt-1" id="todayStatusText">Belum absen hari ini</p>
                        <p class="text-[10px] text-blue-500 mt-1" id="todayStatusTime"></p>
                    </div>
                </div>

                <!-- HISTORY SECTION (Tempat Absen Pulang) -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-xs text-gray-600">
                            <i class="fas fa-history mr-1"></i> RIWAYAT & ABSEN PULANG
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="loadDebugData()" class="text-[8px] text-gray-400" title="Debug">
                                <i class="fas fa-bug"></i>
                            </button>
                            <button onclick="loadUserHistory()" class="text-[10px] text-pink-500">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white text-[10px] text-gray-400 font-bold uppercase border-b border-gray-100">
                                <tr>
                                    <th class="p-3">Tgl</th>
                                    <th class="p-3">Shift</th>
                                    <th class="p-3">Masuk</th>
                                    <th class="p-3 text-center">Pulang</th>
                                </tr>
                            </thead>
                            <tbody id="userHistoryBody" class="text-xs text-gray-600 divide-y divide-gray-50">
                                <tr><td colspan="4" class="p-4 text-center text-gray-300">
                                    <div class="loader mx-auto w-6 h-6 border-2"></div>
                                    <p class="text-[10px] mt-2">Memuat riwayat...</p>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="h-10"></div> <!-- Spacer bottom -->
            </div>
        </section>

        <!-- PAGE 3: ADMIN -->
        <section id="adminDashboard" class="flex-1 flex flex-col hidden bg-gray-50 h-full overflow-hidden">
            <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10 sticky top-0">
                <div>
                    <h2 class="font-bold text-pink-700">Laporan Admin</h2>
                    <p class="text-[10px] text-gray-400" id="adminDataInfo">Memuat data...</p>
                </div>
                <button onclick="logout()" class="text-xs bg-gray-100 px-3 py-1 rounded-full">Tutup</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div class="bg-white p-3 rounded-xl shadow-sm mb-3 space-y-2">
                    <div class="flex gap-2">
                        <input type="date" id="filterStartDate" class="w-1/2 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                        <input type="date" id="filterEndDate" class="w-1/2 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                    </div>
                    <div class="flex gap-2">
                        <select id="filterName" class="flex-1 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                            <option value="All">Semua</option>
                            <option value="Riska">Riska</option>
                            <option value="Linda">Linda</option>
                            <option value="Desva">Desva</option>
                            <option value="Aisyah">Aisyah</option>
                            <option value="Rina">Rina</option>
                            <option value="Dina">Dina</option>
                            <option value="Ropat">Ropat</option>
                        </select>
                        <button onclick="loadAdminData()" class="bg-pink-600 text-white px-3 rounded text-[10px] font-bold">CARI</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="bg-green-50 p-2 rounded-lg text-center border border-green-100">
                        <span class="text-lg font-bold text-green-700" id="statHadir">0</span>
                        <p class="text-[8px] text-green-500 uppercase">Hadir</p>
                    </div>
                    <div class="bg-red-50 p-2 rounded-lg text-center border border-red-100">
                        <span class="text-lg font-bold text-red-700" id="statTelat">0</span>
                        <p class="text-[8px] text-red-500 uppercase">Telat</p>
                    </div>
                    <div class="bg-yellow-50 p-2 rounded-lg text-center border border-yellow-100">
                        <span class="text-lg font-bold text-yellow-700" id="statIzin">0</span>
                        <p class="text-[8px] text-yellow-500 uppercase">Izin</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-[10px] text-left">
                            <thead class="bg-pink-50 text-pink-700 uppercase font-bold">
                                <tr>
                                    <th class="p-2">Tgl</th>
                                    <th class="p-2">Nama</th>
                                    <th class="p-2">Shift</th>
                                    <th class="p-2">In</th>
                                    <th class="p-2">Out</th>
                                    <th class="p-2">Ket</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="divide-y divide-gray-100">
                                <tr><td colspan="6" class="p-4 text-center text-gray-300">Tidak ada data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <button onclick="window.print()" class="absolute bottom-6 right-6 w-12 h-12 bg-gray-800 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-black"><i class="fas fa-print"></i></button>
        </section>

    </div>

    <!-- LOGIC -->
    <script>
        const rosterCycle = [
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Desva", "Aisyah", "Riska"], s: ["Rina", "Linda"], l: [] }, 
            { p: ["Linda", "Desva", "Riska"], s: ["Aisyah", "Rina"], l: [] }, 
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] }, 
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Aisyah", "Rina", "Riska"], s: ["Linda", "Desva"], l: [] },
            { p: ["Desva", "Aisyah", "Linda"], s: ["Riska", "Rina"], l: [] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Riska", "Rina", "Linda"], s: ["Aisyah", "Desva"], l: [] },
            { p: ["Aisyah", "Rina", "Linda"], s: ["Linda", "Riska"], l: [] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Linda", "Desva"], s: ["Aisyah", "Rina"], l: [] },
            { p: ["Riska", "Rina", "Aisyah"], s: ["Desva", "Linda"], l: [] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Linda", "Riska", "Rina"], s: ["Desva", "Aisyah"], l: [] },
            { p: ["Aisyah", "Rina", "Linda"], s: ["Riska", "Desva"], l: [] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] }
        ];

        let currentUser = null;
        let currentShift = null;
        let userLocation = null;
        let adminData = [];
        let userHistoryData = [];

        // ========== INITIALIZATION ==========
        function initApp() {
            console.log("=== APP INITIALIZED ===");
            console.log("Script URL:", SCRIPT_URL);
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterStartDate').value = today;
            document.getElementById('filterEndDate').value = today;
            
            // Initialize GPS
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updatePosition, errorPosition, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                
                // Watch position for updates
                navigator.geolocation.watchPosition(updatePosition, errorPosition, {
                    enableHighAccuracy: true,
                    maximumAge: 30000
                });
            } else {
                document.getElementById('locationStatus').innerText = "GPS Tidak Support";
                document.getElementById('gpsIndicator').className = "w-2 h-2 rounded-full bg-red-500 ml-2";
            }
        }

        function requestLocation() {
            document.getElementById('locationStatus').innerText = "Meminta lokasi...";
            document.getElementById('distanceStatus').innerText = "Silakan izinkan akses GPS";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    updatePosition, 
                    errorPosition, 
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }

        // ========== GPS FUNCTIONS ==========
        function updatePosition(pos) {
            userLocation = { 
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy
            };
            
            const d = getDistance(userLocation.lat, userLocation.lng, CLINIC_LAT, CLINIC_LNG);
            const accuracyText = userLocation.accuracy > 50 ? ` (±${Math.round(userLocation.accuracy)}m)` : '';
            
            document.getElementById('distanceStatus').innerText = `${Math.round(d)} m dari klinik${accuracyText}`;
            const gpsEl = document.getElementById('gpsIndicator');
            const locTxt = document.getElementById('locationStatus');

            if(d <= MAX_RADIUS_METER) {
                gpsEl.className = "w-2 h-2 rounded-full bg-green-500 ml-2 pulse";
                locTxt.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Lokasi Valid`;
                locTxt.className = "text-[10px] font-bold text-green-600";
            } else {
                gpsEl.className = "w-2 h-2 rounded-full bg-red-500 ml-2";
                locTxt.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Di Luar Area`;
                locTxt.className = "text-[10px] font-bold text-red-600";
            }
        }

        function errorPosition(err) {
            console.error("GPS Error:", err);
            document.getElementById('locationStatus').innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> GPS Error`;
            document.getElementById('locationStatus').className = "text-[10px] font-bold text-red-600";
            document.getElementById('distanceStatus').innerText = "Aktifkan GPS dan berikan izin";
            document.getElementById('gpsIndicator').className = "w-2 h-2 rounded-full bg-red-500 ml-2";
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // ========== SHIFT CALCULATION ==========
        function getDayOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            return Math.floor(diff / (1000 * 60 * 60 * 24)) - 1;
        }

        function getShiftForUser(name, date = new Date()) {
            if (["Dina", "Ropat"].includes(name)) return "Non-Shift";
            
            const startOffset = 10;
            const dayIndex = getDayOfYear(date);
            const rosterIndex = (dayIndex + startOffset) % 35;
            const finalIndex = rosterIndex < 0 ? rosterIndex + 35 : rosterIndex;
            const todaySchedule = rosterCycle[finalIndex];
            const dayOfWeek = date.getDay();

            if (todaySchedule.p.includes(name)) return "Pagi";
            if (todaySchedule.s.includes(name)) return "Sore";
            if (todaySchedule.l.includes(name)) return "Libur";
            if (dayOfWeek === 5 && (todaySchedule.p.includes(name) || todaySchedule.s.includes(name))) return "Jumat Full";
            return "Libur";
        }

        // ========== AUTH FUNCTIONS ==========
        function handleLogin() {
            const name = document.getElementById('selectNama').value;
            if (!name) {
                Swal.fire({
                    toast: true,
                    position: 'top',
                    icon: 'warning',
                    title: 'Pilih nama dulu',
                    showConfirmButton: false,
                    timer: 1500
                });
                return;
            }

            currentUser = name;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('flex');
            
            loadUserDashboard();
            loadUserHistory();
        }

        function logout() {
            Swal.fire({
                title: 'Keluar?',
                text: 'Apakah Anda yakin ingin keluar?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#db2777',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        }

        function refreshUserData() {
            loadUserDashboard();
            loadUserHistory();
            requestLocation();
            
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'success',
                title: 'Data diperbarui',
                showConfirmButton: false,
                timer: 1000
            });
        }

        // ========== USER DASHBOARD ==========
        function loadUserDashboard() {
            document.getElementById('userNameDisplay').innerText = currentUser;
            const now = new Date();
            document.getElementById('currentDateDisplay').innerText = now.toLocaleDateString('id-ID', { 
                weekday: 'short',
                day: 'numeric', 
                month: 'short', 
                year: 'numeric' 
            });
            
            currentShift = getShiftForUser(currentUser, now);
            document.getElementById('shiftDisplay').innerText = currentShift === 'Non-Shift' ? 'Bebas' : currentShift;
            
            const info = SHIFT_RULES[currentShift];
            document.getElementById('shiftTimeDisplay').innerHTML = info ? 
                `<i class="far fa-clock"></i> ${info.label}` : 
                `<i class="far fa-clock"></i> -`;
        }

        // ========== HISTORY & ABSEN PULANG ==========
        function loadUserHistory() {
            const tbody = document.getElementById('userHistoryBody');
            tbody.innerHTML = `
                <tr><td colspan="4" class="p-4 text-center text-gray-300">
                    <div class="loader mx-auto w-6 h-6 border-2"></div>
                    <p class="text-[10px] mt-2">Memuat riwayat...</p>
                </td></tr>
            `;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ 
                    action: "GET_USER_HISTORY", 
                    nama: currentUser 
                })
            })
            .then(res => res.json())
            .then(resp => {
                console.log("History Response:", resp);
                
                if(resp.result === 'success') {
                    userHistoryData = resp.data;
                    tbody.innerHTML = "";
                    
                    if(resp.data.length === 0) {
                        tbody.innerHTML = `
                            <tr><td colspan="4" class="p-4 text-center text-gray-300 italic">
                                <i class="fas fa-inbox text-lg mb-2"></i><br>
                                Belum ada data absensi.
                            </td></tr>`;
                        return;
                    }
                    
                    // Check today's status
                    checkTodayStatus(resp.data);
                    
                    resp.data.forEach((row, index) => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-pink-50 transition group";
                        
                        // Debug info
                        console.log(`Row ${index}:`, row);
                        
                        const uniqueId = row.uniqueId || '';
                        const tanggalDisplay = row.tanggal || '';
                        const shiftDisplay = row.shift || '-';
                        const masukDisplay = row.masuk || '-';
                        const pulangDisplay = row.pulang || '';
                        const status = row.status || '';
                        
                        let actionHtml = "";
                        let pulangClass = "";
                        
                        // Jika Status HADIR & Belum Pulang, Tampilkan Tombol Pulang
                        if(status === "Hadir" && (!pulangDisplay || pulangDisplay === "" || pulangDisplay === "-")) {
                            if (uniqueId) {
                                actionHtml = `
                                    <button onclick="triggerPulangSpecific('${escapeString(uniqueId)}', '${escapeString(tanggalDisplay)}')" 
                                        class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-md hover:from-orange-600 hover:to-orange-700 active:scale-95 transition flex items-center gap-1 mx-auto">
                                        <i class="fas fa-sign-out-alt"></i> PULANG
                                    </button>
                                `;
                                pulangClass = "font-bold text-orange-600";
                            } else {
                                actionHtml = `<span class="text-red-500 text-[9px]">ID Error</span>`;
                            }
                        } else {
                            actionHtml = `<span class="font-mono ${pulangClass}">${pulangDisplay || '-'}</span>`;
                        }

                        tr.innerHTML = `
                            <td class="p-3 text-gray-500 font-medium">${tanggalDisplay}</td>
                            <td class="p-3 text-[10px] text-gray-400">${shiftDisplay}</td>
                            <td class="p-3 font-mono font-bold text-gray-700">${masukDisplay}</td>
                            <td class="p-3 text-center align-middle">${actionHtml}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr><td colspan="4" class="p-4 text-center text-red-300">
                            <i class="fas fa-exclamation-triangle text-lg mb-2"></i><br>
                            Gagal memuat data.
                        </td></tr>`;
                }
            })
            .catch(error => {
                console.error("Error loading history:", error);
                tbody.innerHTML = `
                    <tr><td colspan="4" class="p-4 text-center text-red-300">
                        <i class="fas fa-wifi-slash text-lg mb-2"></i><br>
                        Gagal terhubung ke server.
                    </td></tr>`;
            });
        }

        function escapeString(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function checkTodayStatus(historyData) {
            const today = new Date();
            const todayStr = String(today.getDate()).padStart(2, '0') + '/' + 
                           String(today.getMonth() + 1).padStart(2, '0');
            
            const todayEntry = historyData.find(entry => entry.tanggal === todayStr);
            const statusDiv = document.getElementById('todayStatus');
            const statusText = document.getElementById('todayStatusText');
            const statusTime = document.getElementById('todayStatusTime');
            
            if (todayEntry) {
                statusDiv.classList.remove('hidden');
                if (todayEntry.status === 'Hadir') {
                    if (todayEntry.pulang && todayEntry.pulang !== '' && todayEntry.pulang !== '-') {
                        statusText.innerHTML = `<span class="text-green-600">✓ Sudah absen pulang</span>`;
                        statusTime.textContent = `Masuk: ${todayEntry.masuk} | Pulang: ${todayEntry.pulang}`;
                    } else {
                        statusText.innerHTML = `<span class="text-blue-600">✓ Sudah absen masuk</span>`;
                        statusTime.textContent = `Jam masuk: ${todayEntry.masuk} | Silakan absen pulang nanti`;
                    }
                } else {
                    statusText.innerHTML = `<span class="text-yellow-600">Status: ${todayEntry.status}</span>`;
                    statusTime.textContent = `Catatan: ${todayEntry.keterangan || '-'}`;
                }
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        // ========== ABSEN PULANG FUNCTION ==========
        function triggerPulangSpecific(timestampId, dateDisplay) {
            console.log("=== TRIGGER PULANG ===");
            console.log("Timestamp ID:", timestampId);
            console.log("Date Display:", dateDisplay);
            console.log("Current User:", currentUser);
            console.log("Length:", timestampId.length);
            
            // Validasi timestamp
            if (!timestampId || timestampId.length < 10) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Timestamp tidak valid. Silakan refresh halaman.',
                    confirmButtonColor: '#db2777'
                });
                return;
            }
            
            Swal.fire({
                title: 'Absen Pulang?',
                html: `
                    <div class="text-left">
                        <p>Konfirmasi absen pulang untuk:</p>
                        <p><strong>Tanggal:</strong> ${dateDisplay}</p>
                        <p><strong>Waktu:</strong> ${new Date().toLocaleTimeString('id-ID')}</p>
                        <p class="text-xs text-gray-400 mt-2">Pastikan Anda sudah berada di luar area kerja.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Absen Pulang',
                cancelButtonText: 'Batal',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return new Promise((resolve, reject) => {
                        const now = new Date();
                        const jamPulang = String(now.getHours()).padStart(2, '0') + ":" + 
                                         String(now.getMinutes()).padStart(2, '0');
                        
                        const payload = {
                            action: "ABSEN_PULANG_SPECIFIC",
                            nama: currentUser,
                            timestampId: timestampId,
                            jamPulang: jamPulang
                        };
                        
                        console.log("Sending payload:", payload);
                        
                        fetch(SCRIPT_URL, {
                            method: "POST",
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(data => {
                            console.log("Server response:", data);
                            resolve(data);
                        })
                        .catch(error => {
                            console.error("Fetch error:", error);
                            reject(error);
                        });
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    if(data.result === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                                    <p>Absen pulang berhasil disimpan.</p>
                                    <p class="text-sm font-bold mt-2">${data.message}</p>
                                </div>
                            `,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        // Refresh history after 1 second
                        setTimeout(() => {
                            loadUserHistory();
                        }, 1000);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal',
                            html: `
                                <div class="text-left">
                                    <p>${data.message}</p>
                                    <p class="text-xs text-gray-500 mt-2">Timestamp: ${timestampId.substring(0, 30)}...</p>
                                    <p class="text-xs text-gray-500">Silakan coba lagi atau hubungi admin.</p>
                                </div>
                            `,
                            confirmButtonColor: '#db2777'
                        });
                    }
                }
            });
        }

        // ========== ABSEN MASUK / IZIN / SAKIT ==========
        function submitAbsensi(statusType) {
            // Validasi GPS
            if (!userLocation && statusType === 'Hadir') {
                Swal.fire({
                    icon: 'warning',
                    title: 'GPS Tidak Aktif',
                    text: 'Aktifkan GPS untuk absen masuk. Untuk izin/sakit, silakan isi alasan.',
                    confirmButtonColor: '#db2777'
                });
                return;
            }
            
            const now = new Date();
            let lateMinutes = 0;

            if (statusType === 'Hadir' && SHIFT_RULES[currentShift]) {
                const shiftStart = SHIFT_RULES[currentShift].start;
                if (shiftStart !== "-" && shiftStart !== "Bebas") {
                    const [h, m] = shiftStart.split(':').map(Number);
                    const shiftObj = new Date(now);
                    shiftObj.setHours(h, m + SHIFT_RULES[currentShift].late_tolerance, 0);
                    if (now > shiftObj) lateMinutes = Math.floor((now - shiftObj) / 60000);
                }
            }

            if (statusType !== 'Hadir') {
                Swal.fire({
                    title: `Form ${statusType}`,
                    html: `
                        <div class="text-left">
                            <p class="text-sm mb-2">Isikan alasan ${statusType.toLowerCase()}:</p>
                            <textarea id="reasonInput" class="w-full p-2 border border-gray-300 rounded text-sm" 
                                rows="3" placeholder="Contoh: ${statusType === 'Izin' ? 'Izin ke rumah sakit' : 'Sakit demam'}..."></textarea>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonColor: '#db2777',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Kirim',
                    cancelButtonText: 'Batal',
                    preConfirm: () => {
                        const reason = document.getElementById('reasonInput').value;
                        if (!reason || reason.trim() === '') {
                            Swal.showValidationMessage('Harap isi alasan');
                            return false;
                        }
                        return reason;
                    }
                }).then((res) => {
                    if (res.isConfirmed) {
                        sendAbsenData(statusType, lateMinutes, res.value);
                    }
                });
            } else {
                // Validasi lokasi untuk absen masuk
                const d = getDistance(userLocation.lat, userLocation.lng, CLINIC_LAT, CLINIC_LNG);
                if (d > MAX_RADIUS_METER) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Di Luar Area',
                        html: `
                            <div class="text-left">
                                <p>Anda berada di luar area klinik.</p>
                                <p class="text-sm">Jarak: ${Math.round(d)} m (maks: ${MAX_RADIUS_METER} m)</p>
                                <p class="text-xs text-gray-500 mt-2">Silakan mendekat ke klinik untuk absen.</p>
                            </div>
                        `,
                        confirmButtonColor: '#db2777'
                    });
                    return;
                }
                
                sendAbsenData(statusType, lateMinutes, "");
            }
        }

        function sendAbsenData(status, late, note) {
            toggleLoading(true, `Menyimpan absensi ${status}...`);
            
            const now = new Date();
            const timeStr = String(now.getHours()).padStart(2, '0') + ":" + 
                          String(now.getMinutes()).padStart(2, '0');

            const payload = {
                action: "ABSEN_MASUK",
                nama: currentUser,
                lokasi: userLocation ? `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}` : "No GPS",
                shiftJadwal: currentShift,
                shiftAktual: (currentShift === 'Libur' && status === 'Hadir') ? 'Lembur' : currentShift,
                jamMasuk: timeStr,
                status: status,
                telat: late,
                keterangan: note
            };

            console.log("Sending absen data:", payload);
            
            fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify(payload) 
            })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                console.log("Absen response:", data);
                
                if (data.result === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Tersimpan!',
                        html: `
                            <div class="text-center">
                                <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                                <p>${data.message}</p>
                                <p class="text-sm font-bold mt-2">Jam: ${timeStr}</p>
                                ${late > 0 ? `<p class="text-orange-600 text-sm">Keterlambatan: ${late} menit</p>` : ''}
                            </div>
                        `,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Refresh data setelah 1 detik
                    setTimeout(() => {
                        loadUserHistory();
                    }, 1000);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: data.message || 'Terjadi kesalahan',
                        confirmButtonColor: '#db2777'
                    });
                }
            })
            .catch(error => {
                toggleLoading(false);
                console.error("Error:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Koneksi Error',
                    text: 'Gagal terhubung ke server. Periksa koneksi internet.',
                    confirmButtonColor: '#db2777'
                });
            });
        }

        // ========== ADMIN FUNCTIONS ==========
        function showAdminLogin() {
            Swal.fire({
                title: 'Login Admin',
                html: `
                    <div class="text-left">
                        <p class="text-sm mb-2">Masukkan password admin:</p>
                        <input type="password" id="adminPassword" class="swal2-input" placeholder="Password">
                    </div>
                `,
                confirmButtonColor: '#db2777',
                showCancelButton: true,
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const password = document.getElementById('adminPassword').value;
                    if (password !== "112211") {
                        Swal.showValidationMessage('Password salah');
                        return false;
                    }
                    return true;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminDashboard').classList.add('flex');
                    loadAdminData();
                }
            });
        }

        function loadAdminData() {
            toggleLoading(true, "Memuat data admin...");
            
            fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: "GET_DATA" }) 
            })
            .then(res => res.json())
            .then(resp => {
                toggleLoading(false);
                if (resp.result === 'success') {
                    adminData = resp.data;
                    document.getElementById('adminDataInfo').textContent = 
                        `${resp.total} data ditemukan | ${new Date().toLocaleTimeString('id-ID')}`;
                    renderAdminTable();
                } else {
                    Swal.fire('Error', resp.message || 'Gagal memuat data', 'error');
                }
            })
            .catch(error => {
                toggleLoading(false);
                Swal.fire('Error', 'Gagal terhubung ke server', 'error');
            });
        }

        function renderAdminTable() {
            const startStr = document.getElementById('filterStartDate').value;
            const endStr = document.getElementById('filterEndDate').value;
            const nameFilter = document.getElementById('filterName').value;
            
            const sDate = startStr ? new Date(startStr) : null;
            const eDate = endStr ? new Date(endStr) : null;
            if (sDate) sDate.setHours(0,0,0,0);
            if (eDate) eDate.setHours(0,0,0,0);

            let h=0, t=0, i=0;
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = "";

            const filtered = adminData.filter(row => {
                const rDate = new Date(row.tanggal);
                rDate.setHours(0,0,0,0);
                if (sDate && rDate < sDate) return false;
                if (eDate && rDate > eDate) return false;
                if (nameFilter !== "All" && row.nama !== nameFilter) return false;
                return true;
            });

            // Sort by timestamp descending (newest first)
            filtered.sort((a,b) => {
                const dateA = new Date(a.timestamp || a.tanggal);
                const dateB = new Date(b.timestamp || b.tanggal);
                return dateB - dateA;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="p-4 text-center text-gray-300">
                        <i class="fas fa-inbox text-lg mb-2"></i><br>
                        Tidak ada data untuk filter ini.
                    </td></tr>`;
                document.getElementById('statHadir').innerText = "0";
                document.getElementById('statTelat').innerText = "0";
                document.getElementById('statIzin').innerText = "0";
                return;
            }

            filtered.forEach(row => {
                if (row.status === 'Hadir') h++;
                if (parseInt(row.telat) > 0) t++;
                if (['Sakit','Izin'].includes(row.status)) i++;
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-pink-50";
                
                let dateDisp = row.tanggal ? row.tanggal.split('-').reverse().slice(0,2).join('/') : '-';
                let statusClass = row.status === 'Hadir' ? 
                    (row.jam_pulang && row.jam_pulang !== '-' ? 'text-green-600' : 'text-blue-600') : 
                    'text-yellow-600';
                
                // Highlight jika telat
                const isLate = parseInt(row.telat) > 0;
                const lateBadge = isLate ? 
                    `<span class="text-[8px] bg-red-100 text-red-700 px-1 py-0.5 rounded ml-1">+${row.telat}m</span>` : '';

                tr.innerHTML = `
                    <td class="p-2 text-gray-500 font-mono text-[9px]">${dateDisp}</td>
                    <td class="p-2 font-bold text-gray-700 text-[9px]">${row.nama}</td>
                    <td class="p-2 text-gray-600 text-[9px]">${row.shift || '-'}</td>
                    <td class="p-2 font-mono text-gray-600 text-[9px]">${row.jam_masuk || '-'}${lateBadge}</td>
                    <td class="p-2 font-mono text-gray-600 text-[9px]">${row.jam_pulang || '-'}</td>
                    <td class="p-2 font-bold text-[9px] uppercase ${statusClass}">${row.status}</td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('statHadir').innerText = h;
            document.getElementById('statTelat').innerText = t;
            document.getElementById('statIzin').innerText = i;
        }

        // ========== DEBUG FUNCTIONS ==========
        function showDebugInfo() {
            console.log("=== DEBUG INFO ===");
            console.log("Current User:", currentUser);
            console.log("Current Shift:", currentShift);
            console.log("User Location:", userLocation);
            console.log("Script URL:", SCRIPT_URL);
            console.log("User History Data:", userHistoryData);
            
            Swal.fire({
                title: 'Debug Info',
                html: `
                    <div class="text-left text-xs">
                        <p><strong>User:</strong> ${currentUser || 'Not logged in'}</p>
                        <p><strong>Shift:</strong> ${currentShift || '-'}</p>
                        <p><strong>Location:</strong> ${userLocation ? `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}` : 'No GPS'}</p>
                        <p><strong>Script URL:</strong> ${SCRIPT_URL.substring(0, 50)}...</p>
                        <p><strong>History Count:</strong> ${userHistoryData.length}</p>
                        <p><strong>Browser:</strong> ${navigator.userAgent.substring(0, 50)}...</p>
                        <p><strong>Time:</strong> ${new Date().toLocaleString('id-ID')}</p>
                    </div>
                `,
                icon: 'info',
                confirmButtonColor: '#db2777',
                confirmButtonText: 'OK'
            });
        }

        function loadDebugData() {
            if (!currentUser) return;
            
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ 
                    action: "DEBUG_DATA", 
                    nama: currentUser 
                })
            })
            .then(res => res.json())
            .then(resp => {
                console.log("Debug Data:", resp);
                Swal.fire({
                    title: 'Debug Data',
                    html: `
                        <div class="text-left text-xs max-h-60 overflow-y-auto">
                            <pre>${JSON.stringify(resp, null, 2)}</pre>
                        </div>
                    `,
                    width: '80%',
                    confirmButtonColor: '#db2777'
                });
            });
        }

        // ========== UTILITY FUNCTIONS ==========
        function toggleLoading(show, message = "Memproses Data...") {
            const el = document.getElementById('loadingOverlay');
            const textEl = document.getElementById('loadingText');
            
            textEl.textContent = message;
            
            if (show) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        // ========== INIT APP ON LOAD ==========
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
