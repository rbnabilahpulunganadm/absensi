<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Absensi Klinik Nabilah</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#db2777', // Pink 600
                        primaryLight: '#fce7f3', // Pink 100
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #fdf2f8; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.8); }
        
        /* Spinner Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #db2777; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Scrollbar */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col items-center overflow-hidden bg-pink-50">

    <!-- KONFIGURASI -->
    <script>
        // --- GANTI URL INI DENGAN DEPLOYMENT BARU ANDA ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOj9qLKIYWnRqDRRV1kuULYLuRhRfxwY5a4hV5JuJT_2wQIeDdl9kyYh28G-ECGbpv/exec"; 
        
        const CLINIC_LAT = 1.3695941; 
        const CLINIC_LNG = 99.2735394; 
        const MAX_RADIUS_METER = 2000; 

        const SHIFT_RULES = {
            "Pagi": { start: "08:00", end: "14:00", late_tolerance: 15, label: "08:00 - 14:00" },
            "Sore": { start: "14:00", end: "20:00", late_tolerance: 15, label: "14:00 - 20:00" },
            "Malam": { start: "20:00", end: "08:00", late_tolerance: 15, label: "20:00 - 08:00" },
            "Jumat Full": { start: "08:00", end: "17:00", late_tolerance: 15, label: "08:00 - 17:00" },
            "Libur": { start: "-", end: "-", late_tolerance: 0, label: "OFF" },
            "Non-Shift": { start: "Bebas", end: "Bebas", late_tolerance: 999, label: "FLEKSIBEL" }
        };
    </script>

    <!-- LOADING SCREEN -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-[99] flex flex-col items-center justify-center hidden">
        <div class="loader mb-2 w-10 h-10 border-4"></div>
        <p class="text-xs font-bold text-pink-600 animate-pulse">Memproses Data...</p>
    </div>

    <!-- MAIN CONTAINER (Mobile Format: Max Width 480px) -->
    <div class="w-full max-w-md h-full flex flex-col bg-white shadow-2xl relative overflow-hidden sm:rounded-xl sm:my-4 sm:h-[95vh]">
        
        <!-- Decoration Header -->
        <div class="absolute top-0 w-full h-48 bg-gradient-to-b from-pink-500 to-pink-600 -z-0 rounded-b-[40px] shadow-lg"></div>

        <!-- PAGE 1: LOGIN -->
        <section id="loginPage" class="flex-1 flex flex-col justify-center px-8 z-10">
            <div class="glass-panel p-6 rounded-2xl shadow-lg border-t-4 border-pink-400 text-center">
                <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-white shadow-sm">
                    <i class="fas fa-heartbeat text-3xl text-pink-600"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Klinik Nabilah</h1>
                <p class="text-xs text-pink-500 font-bold tracking-wider mb-6">SISTEM E-ABSENSI</p>

                <div class="text-left space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 ml-1 uppercase">Nama Anda</label>
                        <div class="relative">
                            <select id="selectNama" class="w-full p-3 pl-4 border border-gray-200 rounded-xl bg-white text-sm focus:ring-2 focus:ring-pink-500 outline-none appearance-none">
                                <option value="">-- Pilih --</option>
                                <optgroup label="Bidan (Shift)">
                                    <option value="Riska">Riska</option>
                                    <option value="Linda">Linda</option>
                                    <option value="Desva">Desva</option>
                                    <option value="Aisyah">Aisyah</option>
                                    <option value="Rina">Rina</option>
                                </optgroup>
                                <optgroup label="Admin / Staff">
                                    <option value="Dina">Dina</option>
                                    <option value="Ropat">Ropat</option>
                                </optgroup>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-300 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-pink-600 to-pink-500 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all text-sm flex justify-center items-center gap-2">
                        Masuk <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <button onclick="showAdminLogin()" class="w-full text-center text-[10px] text-gray-400 py-2 hover:text-pink-600">
                        <i class="fas fa-lock"></i> Login Admin
                    </button>
                </div>
            </div>
        </section>

        <!-- PAGE 2: DASHBOARD -->
        <section id="userDashboard" class="flex-1 flex flex-col hidden z-10 overflow-hidden">
            <!-- Top Bar -->
            <div class="px-6 pt-6 pb-2 flex justify-between items-center text-white">
                <div>
                    <p class="text-xs opacity-80">Selamat Datang,</p>
                    <h2 class="text-xl font-bold" id="userNameDisplay">User</h2>
                    <p class="text-[10px] bg-white/20 inline-block px-2 py-0.5 rounded-full mt-1" id="currentDateDisplay">...</p>
                </div>
                <button onclick="logout()" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-white/40">
                    <i class="fas fa-power-off text-xs"></i>
                </button>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-4 pb-6 hide-scroll">
                
                <!-- Shift Card -->
                <div class="bg-white rounded-2xl p-4 shadow-md mb-4 mt-2 border border-pink-50">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Jadwal Hari Ini</p>
                            <h3 id="shiftDisplay" class="text-2xl font-bold text-pink-600 mt-1">...</h3>
                            <p id="shiftTimeDisplay" class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                <i class="far fa-clock"></i> ...
                            </p>
                        </div>
                        <div class="bg-pink-50 p-2 rounded-lg text-pink-500">
                            <i class="fas fa-calendar-day text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- GPS Status -->
                <div class="flex items-center gap-2 mb-4 bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                    <div class="w-2 h-2 rounded-full bg-gray-300 ml-2" id="gpsIndicator"></div>
                    <div class="flex-1">
                        <p id="locationStatus" class="text-[10px] font-bold text-gray-700">Mencari Lokasi...</p>
                        <p id="distanceStatus" class="text-[10px] text-gray-400 leading-none">...</p>
                    </div>
                </div>

                <!-- ACTION BUTTONS GRID (1 Baris 3 Tombol) -->
                <div class="grid grid-cols-3 gap-3 mb-5">
                    <!-- Absen Masuk (Besar) -->
                    <button onclick="submitAbsensi('Hadir')" class="col-span-1 bg-gradient-to-br from-green-500 to-green-600 text-white p-3 rounded-xl shadow-lg shadow-green-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24">
                        <i class="fas fa-fingerprint text-2xl"></i>
                        <span class="text-xs font-bold leading-none mt-1">ABSEN<br>MASUK</span>
                    </button>

                    <!-- Izin -->
                    <button onclick="submitAbsensi('Izin')" class="col-span-1 bg-white border border-blue-100 p-3 rounded-xl shadow-sm active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24 text-blue-500 hover:bg-blue-50">
                        <i class="fas fa-envelope-open-text text-xl"></i>
                        <span class="text-xs font-bold">Izin</span>
                    </button>

                    <!-- Sakit -->
                    <button onclick="submitAbsensi('Sakit')" class="col-span-1 bg-white border border-yellow-100 p-3 rounded-xl shadow-sm active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24 text-yellow-500 hover:bg-yellow-50">
                        <i class="fas fa-procedures text-xl"></i>
                        <span class="text-xs font-bold">Sakit</span>
                    </button>
                </div>

                <!-- HISTORY SECTION (Tempat Absen Pulang) -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-xs text-gray-600">RIWAYAT & ABSEN PULANG</h3>
                        <button onclick="loadUserHistory()" class="text-[10px] text-pink-500"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white text-[10px] text-gray-400 font-bold uppercase border-b border-gray-100">
                                <tr>
                                    <th class="p-3">Tgl</th>
                                    <th class="p-3">Shift</th>
                                    <th class="p-3">Masuk</th>
                                    <th class="p-3 text-center">Aksi Pulang</th>
                                </tr>
                            </thead>
                            <tbody id="userHistoryBody" class="text-xs text-gray-600 divide-y divide-gray-50">
                                <tr><td colspan="4" class="p-4 text-center text-gray-300">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="h-10"></div> <!-- Spacer bottom -->
            </div>
        </section>

        <!-- PAGE 3: ADMIN -->
        <section id="adminDashboard" class="flex-1 flex flex-col hidden bg-gray-50 h-full overflow-hidden">
            <div class="bg-white p-4 shadow-sm flex justify-between items-center z-10 sticky top-0">
                <h2 class="font-bold text-pink-700">Laporan Admin</h2>
                <button onclick="logout()" class="text-xs bg-gray-100 px-3 py-1 rounded-full">Tutup</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <div class="bg-white p-3 rounded-xl shadow-sm mb-3 space-y-2">
                    <div class="flex gap-2">
                        <input type="date" id="filterStartDate" class="w-1/2 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                        <input type="date" id="filterEndDate" class="w-1/2 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                    </div>
                    <div class="flex gap-2">
                        <select id="filterName" class="flex-1 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                            <option value="All">Semua</option>
                            <option value="Riska">Riska</option>
                            <option value="Linda">Linda</option>
                            <option value="Desva">Desva</option>
                            <option value="Aisyah">Aisyah</option>
                            <option value="Rina">Rina</option>
                        </select>
                        <button onclick="loadAdminData()" class="bg-pink-600 text-white px-3 rounded text-[10px] font-bold">CARI</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="bg-green-50 p-2 rounded-lg text-center border border-green-100">
                        <span class="text-lg font-bold text-green-700" id="statHadir">0</span>
                        <p class="text-[8px] text-green-500 uppercase">Hadir</p>
                    </div>
                    <div class="bg-red-50 p-2 rounded-lg text-center border border-red-100">
                        <span class="text-lg font-bold text-red-700" id="statTelat">0</span>
                        <p class="text-[8px] text-red-500 uppercase">Telat</p>
                    </div>
                    <div class="bg-yellow-50 p-2 rounded-lg text-center border border-yellow-100">
                        <span class="text-lg font-bold text-yellow-700" id="statIzin">0</span>
                        <p class="text-[8px] text-yellow-500 uppercase">Izin</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-[10px] text-left">
                            <thead class="bg-pink-50 text-pink-700 uppercase font-bold">
                                <tr>
                                    <th class="p-2">Tgl</th>
                                    <th class="p-2">Nama</th>
                                    <th class="p-2">In</th>
                                    <th class="p-2">Out</th>
                                    <th class="p-2">Ket</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <button onclick="window.print()" class="absolute bottom-6 right-6 w-12 h-12 bg-gray-800 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-black"><i class="fas fa-print"></i></button>
        </section>

    </div>

    <!-- LOGIC -->
    <script>
        const rosterCycle = [
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Desva", "Aisyah", "Riska"], s: ["Rina", "Linda"], l: [] }, 
            { p: ["Linda", "Desva", "Riska"], s: ["Aisyah", "Rina"], l: [] }, 
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] }, 
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Aisyah", "Rina", "Riska"], s: ["Linda", "Desva"], l: [] },
            { p: ["Desva", "Aisyah", "Linda"], s: ["Riska", "Rina"], l: [] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Riska", "Rina", "Linda"], s: ["Aisyah", "Desva"], l: [] },
            { p: ["Aisyah", "Rina", "Linda"], s: ["Linda", "Riska"], l: [] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] },
            { p: ["Riska", "Linda", "Desva"], s: ["Aisyah", "Rina"], l: [] },
            { p: ["Riska", "Rina", "Aisyah"], s: ["Desva", "Linda"], l: [] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Riska", "Rina"], s: ["Desva", "Linda"], l: ["Aisyah"] },
            { p: ["Aisyah", "Rina"], s: ["Riska", "Linda"], l: ["Desva"] },
            { p: ["Desva", "Aisyah"], s: ["Riska", "Rina"], l: ["Linda"] },
            { p: ["Linda", "Desva"], s: ["Aisyah", "Rina"], l: ["Riska"] },
            { p: ["Linda", "Riska", "Rina"], s: ["Desva", "Aisyah"], l: [] },
            { p: ["Aisyah", "Rina", "Linda"], s: ["Riska", "Desva"], l: [] },
            { p: ["Riska", "Linda"], s: ["Desva", "Aisyah"], l: ["Rina"] }
        ];

        let currentUser = null;
        let currentShift = null;
        let userLocation = null;
        let adminData = [];

        function initApp() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterStartDate').value = today;
            document.getElementById('filterEndDate').value = today;
            
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updatePosition, errorPosition, { enableHighAccuracy: true });
            } else {
                document.getElementById('locationStatus').innerText = "GPS Error";
            }
        }

        function getDayOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            return Math.floor(diff / (1000 * 60 * 60 * 24)) - 1; 
        }

        function getShiftForUser(name, date = new Date()) {
            if (["Dina", "Ropat"].includes(name)) return "Non-Shift";
            
            const startOffset = 10; 
            const dayIndex = getDayOfYear(date);
            const rosterIndex = (dayIndex + startOffset) % 35;
            const finalIndex = rosterIndex < 0 ? rosterIndex + 35 : rosterIndex;
            const todaySchedule = rosterCycle[finalIndex];
            const dayOfWeek = date.getDay(); 

            if (todaySchedule.p.includes(name)) return "Pagi";
            if (todaySchedule.s.includes(name)) return "Sore";
            if (todaySchedule.l.includes(name)) return "Libur";
            if (dayOfWeek === 5 && (todaySchedule.p.includes(name) || todaySchedule.s.includes(name))) return "Jumat Full";
            return "Libur"; 
        }

        function updatePosition(pos) {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            const d = getDistance(userLocation.lat, userLocation.lng, CLINIC_LAT, CLINIC_LNG);
            
            document.getElementById('distanceStatus').innerText = `${Math.round(d)} m dari klinik`;
            const gpsEl = document.getElementById('gpsIndicator');
            const locTxt = document.getElementById('locationStatus');

            if(d <= MAX_RADIUS_METER) {
                gpsEl.className = "w-2 h-2 rounded-full bg-green-500 ml-2 animate-pulse";
                locTxt.innerHTML = "Lokasi Valid";
                locTxt.className = "text-[10px] font-bold text-green-600";
            } else {
                gpsEl.className = "w-2 h-2 rounded-full bg-red-500 ml-2";
                locTxt.innerHTML = "Terlalu Jauh";
                locTxt.className = "text-[10px] font-bold text-red-600";
            }
        }
        function errorPosition() { document.getElementById('locationStatus').innerText = "Aktifkan GPS!"; }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; const φ1 = lat1 * Math.PI/180; const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180; const Δλ = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ/2) * Math.sin(Δλ/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- AUTH ---
        function handleLogin() {
            const name = document.getElementById('selectNama').value;
            if (!name) return Swal.fire({toast:true, position:'top', icon:'warning', title:'Pilih nama dulu', showConfirmButton:false, timer:1500});

            currentUser = name;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('flex');
            
            loadUserDashboard();
            loadUserHistory();
        }
        function logout() { location.reload(); }

        function loadUserDashboard() {
            document.getElementById('userNameDisplay').innerText = currentUser;
            const now = new Date();
            document.getElementById('currentDateDisplay').innerText = now.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
            
            currentShift = getShiftForUser(currentUser, now);
            document.getElementById('shiftDisplay').innerText = currentShift === 'Non-Shift' ? 'Bebas' : currentShift;
            
            const info = SHIFT_RULES[currentShift];
            document.getElementById('shiftTimeDisplay').innerHTML = info ? `<i class="far fa-clock"></i> ${info.label}` : "-";
        }

        // --- HISTORY & PULANG LOGIC ---
        function loadUserHistory() {
            const tbody = document.getElementById('userHistoryBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-300"><div class="loader mx-auto w-6 h-6 border-2"></div></td></tr>';

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "GET_USER_HISTORY", nama: currentUser })
            })
            .then(res => res.json())
            .then(resp => {
                if(resp.result === 'success') {
                    tbody.innerHTML = "";
                    if(resp.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-300 italic">Belum ada data.</td></tr>';
                        return;
                    }
                    
                    resp.data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-pink-50 transition group";
                        
                        let actionHtml = "";
                        // Jika Status HADIR & Belum Pulang, Tampilkan Tombol Pulang
                        if(row.status === "Hadir" && (!row.pulang || row.pulang === "")) {
                            actionHtml = `
                                <button onclick="triggerPulangSpecific('${row.uniqueId}', '${row.tanggal}')" 
                                    class="bg-orange-500 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-md hover:bg-orange-600 active:scale-95 transition flex items-center gap-1 mx-auto">
                                    <i class="fas fa-sign-out-alt"></i> PLG
                                </button>
                            `;
                        } else {
                            actionHtml = `<span class="font-mono text-gray-500 font-bold">${row.pulang || '-'}</span>`;
                        }

                        tr.innerHTML = `
                            <td class="p-3 text-gray-500">${row.tanggal}</td>
                            <td class="p-3 text-[10px] text-gray-400">${row.shift}</td>
                            <td class="p-3 font-mono font-bold text-gray-700">${row.masuk}</td>
                            <td class="p-3 text-center align-middle">${actionHtml}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
        }

        // FUNGSI ABSEN PULANG SPESIFIK (SOLUSI DUPLIKAT)
        function triggerPulangSpecific(timestampId, dateDisplay) {
            Swal.fire({
                title: 'Pulang?',
                text: `Konfirmasi pulang untuk data tgl ${dateDisplay}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316', // Orange
                confirmButtonText: 'Ya, Pulang',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    toggleLoading(true);
                    
                    const now = new Date();
                    const jamPulang = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');

                    fetch(SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            action: "ABSEN_PULANG_SPECIFIC",
                            nama: currentUser,
                            timestampId: timestampId, // KUNCI UNIK
                            jamPulang: jamPulang
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        toggleLoading(false);
                        if(data.result === 'success') {
                            Swal.fire({icon:'success', title:'Berhasil Pulang!', timer:1500, showConfirmButton:false});
                            loadUserHistory(); // Refresh
                        } else {
                            Swal.fire('Gagal', data.message, 'error');
                        }
                    });
                }
            });
        }

        // --- ABSEN MASUK / IZIN ---
        function submitAbsensi(statusType) {
            const now = new Date();
            let lateMinutes = 0;

            if (statusType === 'Hadir' && SHIFT_RULES[currentShift]) {
                const shiftStart = SHIFT_RULES[currentShift].start;
                if (shiftStart !== "-" && shiftStart !== "Bebas") {
                    const [h, m] = shiftStart.split(':').map(Number);
                    const shiftObj = new Date(now);
                    shiftObj.setHours(h, m + SHIFT_RULES[currentShift].late_tolerance, 0);
                    if (now > shiftObj) lateMinutes = Math.floor((now - shiftObj) / 60000);
                }
            }

            if (statusType !== 'Hadir') {
                Swal.fire({
                    title: `Info ${statusType}`,
                    input: 'textarea',
                    inputPlaceholder: 'Alasan...',
                    confirmButtonColor: '#db2777'
                }).then((res) => {
                    if (res.isConfirmed) sendAbsenData(statusType, lateMinutes, res.value);
                });
            } else {
                sendAbsenData(statusType, lateMinutes, "");
            }
        }

        function sendAbsenData(status, late, note) {
            toggleLoading(true);
            const now = new Date();
            const timeStr = String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0');

            const payload = {
                action: "ABSEN_MASUK",
                nama: currentUser,
                lokasi: userLocation ? `${userLocation.lat}, ${userLocation.lng}` : "No GPS",
                shiftJadwal: currentShift,
                shiftAktual: (currentShift === 'Libur' && status === 'Hadir') ? 'Lembur' : currentShift,
                jamMasuk: timeStr,
                status: status,
                telat: late,
                keterangan: note
            };

            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                if (data.result === 'success') {
                    Swal.fire({icon: 'success', title: 'Tersimpan!', timer: 1500, showConfirmButton: false});
                    loadUserHistory(); 
                } else {
                    Swal.fire('Gagal', data.message, 'error');
                }
            });
        }

        // --- ADMIN ---
        function showAdminLogin() {
            Swal.fire({
                title: 'Admin',
                input: 'password',
                confirmButtonColor: '#db2777'
            }).then((res) => {
                if(res.value === "112211") {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminDashboard').classList.add('flex');
                    loadAdminData();
                }
            });
        }

        function loadAdminData() {
            toggleLoading(true);
            fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "GET_DATA" }) })
            .then(res => res.json())
            .then(resp => {
                toggleLoading(false);
                if (resp.result === 'success') {
                    adminData = resp.data;
                    renderAdminTable();
                }
            });
        }

        function renderAdminTable() {
            const startStr = document.getElementById('filterStartDate').value;
            const endStr = document.getElementById('filterEndDate').value;
            const nameFilter = document.getElementById('filterName').value;
            const sDate = startStr ? new Date(startStr) : null;
            const eDate = endStr ? new Date(endStr) : null;
            if (sDate) sDate.setHours(0,0,0,0);
            if (eDate) eDate.setHours(0,0,0,0);

            let h=0, t=0, i=0;
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = "";

            const filtered = adminData.filter(row => {
                const rDate = new Date(row.tanggal);
                rDate.setHours(0,0,0,0);
                if (sDate && rDate < sDate) return false;
                if (eDate && rDate > eDate) return false;
                if (nameFilter !== "All" && row.nama !== nameFilter) return false;
                return true;
            });

            filtered.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by full timestamp

            filtered.forEach(row => {
                if (row.status === 'Hadir') h++;
                if (parseInt(row.telat) > 0) t++;
                if (['Sakit','Izin'].includes(row.status)) i++;
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-pink-50";
                
                let dateDisp = row.tanggal.split('-').reverse().slice(0,2).join('/'); // DD/MM
                let statusBadge = row.status === 'Hadir' ? 'text-green-600' : 'text-yellow-600';

                tr.innerHTML = `
                    <td class="p-2 text-gray-500 font-mono">${dateDisp}</td>
                    <td class="p-2 font-bold text-gray-700">${row.nama}</td>
                    <td class="p-2 font-mono text-gray-600">${row.jam_masuk}</td>
                    <td class="p-2 font-mono text-gray-600">${row.jam_pulang || '-'}</td>
                    <td class="p-2 font-bold text-[9px] uppercase ${statusBadge}">${row.status}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('statHadir').innerText = h;
            document.getElementById('statTelat').innerText = t;
            document.getElementById('statIzin').innerText = i;
        }

        function toggleLoading(show) {
            const el = document.getElementById('loadingOverlay');
            if(show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        initApp();
    </script>
</body>
</html>
