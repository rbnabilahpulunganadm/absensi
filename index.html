<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Absensi Klinik Nabilah - Enhanced Scheduling</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#db2777',
                        primaryLight: '#fce7f3',
                        shiftPagi: '#3b82f6',
                        shiftSore: '#8b5cf6',
                        shiftJumat: '#059669',
                        shiftLibur: '#6b7280',
                        shiftLiburNasional: '#dc2626',
                        shiftNon: '#f59e0b',
                        shiftLembur: '#7c3aed'
                    }
                }
            }
        }
    </script>
    
    <!-- FontAwesome & Google Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Chart.js untuk grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #fdf2f8; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.8); }
        
        /* Spinner Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #db2777; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Mobile Scrollbar */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animasi */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* Shift Badge Colors */
        .badge-pagi { background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .badge-sore { background-color: #f3e8ff; color: #5b21b6; border: 1px solid #c4b5fd; }
        .badge-jumat { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .badge-libur { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .badge-libur-nasional { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .badge-non { background-color: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
        .badge-lembur { background-color: #ede9fe; color: #5b21b6; border: 1px solid #a78bfa; }
        
        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col items-center overflow-hidden bg-pink-50" onload="initApp()">

    <!-- KONFIGURASI -->
    <script>
        // URL Google Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOj9qLKIYWnRqDRRV1kuULYLuRhRfxwY5a4hV5JuJT_2wQIeDdl9kyYh28G-ECGbpv/exec"; 
        
        // Konfigurasi GPS
        const CLINIC_LAT = 1.3695652; 
        const CLINIC_LNG = 99.2735516; 
        const MAX_RADIUS_METER = 20000;
        
        // Nama bulan Indonesia
        const MONTH_NAMES = [
            "Januari", "Februari", "Maret", "April", "Mei", "Juni",
            "Juli", "Agustus", "September", "Oktober", "November", "Desember"
        ];
        
        // Nama hari Indonesia
        const DAY_NAMES = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    </script>

    <!-- LOADING SCREEN -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 z-[9999] flex flex-col items-center justify-center hidden">
        <div class="loader mb-2 w-10 h-10 border-4"></div>
        <p id="loadingText" class="text-xs font-bold text-pink-600 animate-pulse">Memproses Data...</p>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="w-full max-w-md h-full flex flex-col bg-white shadow-2xl relative overflow-hidden sm:rounded-xl sm:my-4 sm:h-[95vh]">
        
        <!-- Decoration Header -->
        <div class="absolute top-0 w-full h-48 bg-gradient-to-b from-pink-500 to-pink-600 -z-0 rounded-b-[40px] shadow-lg"></div>

        <!-- PAGE 1: LOGIN -->
        <section id="loginPage" class="flex-1 flex flex-col justify-center px-8 z-10">
            <div class="glass-panel p-6 rounded-2xl shadow-lg border-t-4 border-pink-400 text-center">
                <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4 border-2 border-white shadow-sm">
                    <i class="fas fa-calendar-alt text-3xl text-pink-600"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Klinik Nabilah</h1>
                <p class="text-xs text-pink-500 font-bold tracking-wider mb-2">SISTEM E-ABSENSI v5.1</p>
                <p class="text-[10px] text-gray-400 mb-4">Enhanced Scheduling System</p>

                <div class="text-left space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 ml-1 uppercase">Nama Anda</label>
                        <div class="relative">
                            <select id="selectNama" class="w-full p-3 pl-4 border border-gray-200 rounded-xl bg-white text-sm focus:ring-2 focus:ring-pink-500 outline-none appearance-none">
                                <option value="">-- Pilih --</option>
                                <optgroup label="Bidan (Shift)">
                                    <option value="Riska">Riska</option>
                                    <option value="Linda">Linda</option>
                                    <option value="Desva">Desva</option>
                                    <option value="Aisyah">Aisyah</option>
                                    <option value="Rina">Rina</option>
                                </optgroup>
                                <optgroup label="Admin / Staff">
                                    <option value="Dina">Dina</option>
                                    <option value="Ropat">Ropat</option>
                                </optgroup>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-300 text-xs pointer-events-none"></i>
                        </div>
                    </div>
                    
                    <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-pink-600 to-pink-500 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl active:scale-95 transition-all text-sm flex justify-center items-center gap-2">
                        Masuk <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <div class="flex justify-between">
                        <button onclick="showAdminLogin()" class="text-[10px] text-gray-400 py-2 hover:text-pink-600">
                            <i class="fas fa-lock"></i> Login Admin
                        </button>
                        <button onclick="showScheduleInfo()" class="text-[10px] text-gray-400 py-2 hover:text-pink-600">
                            <i class="fas fa-info-circle"></i> Info Jadwal
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE 2: DASHBOARD USER -->
        <section id="userDashboard" class="flex-1 flex flex-col hidden z-10 overflow-hidden">
            <!-- Top Bar -->
            <div class="px-6 pt-6 pb-2 flex justify-between items-center text-white">
                <div>
                    <p class="text-xs opacity-80">Selamat Datang,</p>
                    <h2 class="text-xl font-bold" id="userNameDisplay">User</h2>
                    <p class="text-[10px] bg-white/20 inline-block px-2 py-0.5 rounded-full mt-1" id="currentDateDisplay">...</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="showScheduleView()" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-white/40" title="Lihat Jadwal">
                        <i class="fas fa-calendar text-xs"></i>
                    </button>
                    <button onclick="refreshUserData()" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-white/40" title="Refresh">
                        <i class="fas fa-sync text-xs"></i>
                    </button>
                    <button onclick="logout()" class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm hover:bg-white/40" title="Keluar">
                        <i class="fas fa-power-off text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-4 pb-6 hide-scroll">
                
                <!-- TODAY'S STATUS BANNER -->
                <div id="todayStatusBanner" class="mb-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl p-3 shadow-lg fade-in hidden">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[10px] opacity-80">Status Hari Ini</p>
                            <p class="text-sm font-bold" id="todayStatusText">Belum absen</p>
                            <p class="text-[10px] opacity-90" id="todayStatusDetails"></p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] opacity-80">Jam Kerja</p>
                            <p class="text-sm font-bold" id="todayShiftTime">-</p>
                        </div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-white/20" id="todayActionButtons"></div>
                </div>

                <!-- SHIFT INFO CARD -->
                <div class="bg-white rounded-2xl p-4 shadow-md mb-4 mt-2 border border-pink-50" id="shiftInfoCard">
                    <!-- Konten akan diisi oleh JavaScript -->
                </div>

                <!-- GPS Status -->
                <div class="flex items-center gap-2 mb-4 bg-white p-2 rounded-lg shadow-sm border border-gray-100">
                    <div class="w-2 h-2 rounded-full bg-gray-300 ml-2" id="gpsIndicator"></div>
                    <div class="flex-1">
                        <p id="locationStatus" class="text-[10px] font-bold text-gray-700">Mencari Lokasi...</p>
                        <p id="distanceStatus" class="text-[10px] text-gray-400 leading-none">Menunggu GPS...</p>
                    </div>
                    <button onclick="requestLocation()" class="text-[8px] bg-gray-100 px-2 py-1 rounded text-gray-500">Refresh</button>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="grid grid-cols-3 gap-3 mb-5">
                    <button onclick="submitAbsensi('Hadir')" id="btnAbsenMasuk" class="col-span-1 bg-gradient-to-br from-green-500 to-green-600 text-white p-3 rounded-xl shadow-lg shadow-green-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24">
                        <i class="fas fa-fingerprint text-2xl"></i>
                        <span class="text-xs font-bold leading-none mt-1">ABSEN<br>MASUK</span>
                    </button>

                    <button onclick="submitAbsensi('Izin')" class="col-span-1 bg-white border border-blue-100 p-3 rounded-xl shadow-sm active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24 text-blue-500 hover:bg-blue-50">
                        <i class="fas fa-envelope-open-text text-xl"></i>
                        <span class="text-xs font-bold">Izin</span>
                    </button>

                    <button onclick="submitAbsensi('Sakit')" class="col-span-1 bg-white border border-yellow-100 p-3 rounded-xl shadow-sm active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24 text-yellow-500 hover:bg-yellow-50">
                        <i class="fas fa-procedures text-xl"></i>
                        <span class="text-xs font-bold">Sakit</span>
                    </button>
                </div>

                <!-- QUICK SCHEDULE PREVIEW -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-bold text-gray-600">Jadwal 3 Hari Berikutnya</h3>
                        <button onclick="showScheduleView()" class="text-[10px] text-pink-500">Lihat Semua</button>
                    </div>
                    <div id="nextDaysSchedule" class="space-y-2">
                        <!-- Diisi oleh JavaScript -->
                        <div class="text-center text-gray-300 text-xs py-4">
                            <i class="fas fa-spinner fa-spin mr-1"></i> Memuat jadwal...
                        </div>
                    </div>
                </div>

                <!-- HISTORY SECTION -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-2 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="font-bold text-xs text-gray-600">
                            <i class="fas fa-history mr-1"></i> RIWAYAT ABSENSI
                        </h3>
                        <button onclick="loadUserHistory()" class="text-[10px] text-pink-500">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-white text-[10px] text-gray-400 font-bold uppercase border-b border-gray-100">
                                <tr>
                                    <th class="p-3">Tgl</th>
                                    <th class="p-3">Hari</th>
                                    <th class="p-3">Shift</th>
                                    <th class="p-3">Masuk</th>
                                    <th class="p-3">Pulang</th>
                                    <th class="p-3">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userHistoryBody" class="text-xs text-gray-600 divide-y divide-gray-50">
                                <tr><td colspan="6" class="p-4 text-center text-gray-300">
                                    <div class="loader mx-auto w-6 h-6 border-2"></div>
                                    <p class="text-[10px] mt-2">Memuat riwayat...</p>
                                </td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="h-10"></div>
            </div>
        </section>

        <!-- PAGE 3: SCHEDULE VIEW -->
        <section id="scheduleView" class="flex-1 flex flex-col hidden bg-white h-full overflow-hidden">
            <div class="bg-gradient-to-r from-pink-500 to-pink-600 p-4 shadow-sm flex justify-between items-center z-10 sticky top-0 text-white">
                <div>
                    <h2 class="font-bold">Jadwal Shift</h2>
                    <p class="text-[10px] opacity-80" id="scheduleUserInfo">Loading...</p>
                </div>
                <button onclick="hideScheduleView()" class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30">
                    <i class="fas fa-arrow-left mr-1"></i> Kembali
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <!-- Month Selector -->
                <div class="bg-white p-3 rounded-xl shadow-sm mb-4 border border-gray-100">
                    <div class="flex items-center justify-between mb-2">
                        <button onclick="changeScheduleMonth(-1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">
                            <i class="fas fa-chevron-left text-gray-600"></i>
                        </button>
                        <h3 id="scheduleMonthTitle" class="font-bold text-gray-700 text-sm">Januari 2026</h3>
                        <button onclick="changeScheduleMonth(1)" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-1 text-center text-[9px] text-gray-500 font-bold mb-2">
                        <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                    </div>
                    
                    <div id="scheduleCalendar" class="space-y-1">
                        <!-- Calendar akan diisi oleh JavaScript -->
                        <div class="text-center text-gray-300 py-8">
                            <i class="fas fa-spinner fa-spin mr-1"></i> Memuat kalender...
                        </div>
                    </div>
                </div>

                <!-- Schedule Summary -->
                <div id="scheduleSummary" class="bg-gray-50 rounded-xl p-3 mb-4">
                    <h4 class="font-bold text-xs text-gray-700 mb-2">Ringkasan Bulan Ini</h4>
                    <div class="grid grid-cols-2 gap-2 text-[10px]">
                        <div class="bg-white p-2 rounded border">
                            <span class="font-bold text-green-600" id="totalWorkDays">0</span>
                            <p class="text-gray-500">Hari Kerja</p>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <span class="font-bold text-blue-600" id="totalPagi">0</span>
                            <p class="text-gray-500">Shift Pagi</p>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <span class="font-bold text-purple-600" id="totalSore">0</span>
                            <p class="text-gray-500">Shift Sore</p>
                        </div>
                        <div class="bg-white p-2 rounded border">
                            <span class="font-bold text-red-600" id="totalLibur">0</span>
                            <p class="text-gray-500">Hari Libur</p>
                        </div>
                    </div>
                </div>

                <!-- Legend -->
                <div class="bg-white rounded-xl p-3 border border-gray-100">
                    <h4 class="font-bold text-xs text-gray-700 mb-2">Keterangan Warna</h4>
                    <div class="space-y-1 text-[10px]">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-blue-100 border border-blue-300"></div>
                            <span>Shift Pagi (08:00-17:00)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-purple-100 border border-purple-300"></div>
                            <span>Shift Sore (15:00-21:30)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-green-100 border border-green-300"></div>
                            <span>Jumat Full (08:00-17:00)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-gray-100 border border-gray-300"></div>
                            <span>Libur Biasa</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full bg-red-100 border border-red-300"></div>
                            <span>Libur Nasional</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE 4: ADMIN DASHBOARD -->
        <section id="adminDashboard" class="flex-1 flex flex-col hidden bg-gray-50 h-full overflow-hidden">
            <div class="bg-gradient-to-r from-pink-500 to-pink-600 p-4 shadow-sm flex justify-between items-center z-10 sticky top-0 text-white">
                <div>
                    <h2 class="font-bold">Laporan Admin</h2>
                    <p class="text-[10px] opacity-80" id="adminDataInfo">Memuat data...</p>
                </div>
                <button onclick="logout()" class="text-xs bg-white/20 px-3 py-1 rounded-full hover:bg-white/30">Tutup</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                <!-- Filter Controls -->
                <div class="bg-white p-3 rounded-xl shadow-sm mb-3 space-y-2">
                    <div class="flex gap-2">
                        <input type="date" id="filterStartDate" class="w-1/2 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                        <input type="date" id="filterEndDate" class="w-1/2 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                    </div>
                    <div class="flex gap-2">
                        <select id="filterName" class="flex-1 text-[10px] p-2 bg-gray-50 rounded border border-gray-200">
                            <option value="All">Semua</option>
                            <option value="Riska">Riska</option>
                            <option value="Linda">Linda</option>
                            <option value="Desva">Desva</option>
                            <option value="Aisyah">Aisyah</option>
                            <option value="Rina">Rina</option>
                            <option value="Dina">Dina</option>
                            <option value="Ropat">Ropat</option>
                        </select>
                        <button onclick="loadAdminData()" class="bg-pink-600 text-white px-3 rounded text-[10px] font-bold">CARI</button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <div class="bg-green-50 p-2 rounded-lg text-center border border-green-100">
                        <span class="text-lg font-bold text-green-700" id="statHadir">0</span>
                        <p class="text-[8px] text-green-500 uppercase">Hadir</p>
                    </div>
                    <div class="bg-red-50 p-2 rounded-lg text-center border border-red-100">
                        <span class="text-lg font-bold text-red-700" id="statTelat">0</span>
                        <p class="text-[8px] text-red-500 uppercase">Telat</p>
                    </div>
                    <div class="bg-yellow-50 p-2 rounded-lg text-center border border-yellow-100">
                        <span class="text-lg font-bold text-yellow-700" id="statIzin">0</span>
                        <p class="text-[8px] text-yellow-500 uppercase">Izin</p>
                    </div>
                </div>

                <!-- Report Table -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-[10px] text-left">
                            <thead class="bg-pink-50 text-pink-700 uppercase font-bold">
                                <tr>
                                    <th class="p-2">Tanggal</th>
                                    <th class="p-2">Nama</th>
                                    <th class="p-2">Shift</th>
                                    <th class="p-2">In</th>
                                    <th class="p-2">Out</th>
                                    <th class="p-2">Status</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="divide-y divide-gray-100">
                                <tr><td colspan="6" class="p-4 text-center text-gray-300">Tidak ada data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Admin Tools -->
                <div class="mt-4 bg-white rounded-xl p-3 border border-gray-100">
                    <h4 class="font-bold text-xs text-gray-700 mb-2">Tools Admin</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="generateScheduleReport()" class="text-[10px] bg-blue-100 text-blue-700 p-2 rounded hover:bg-blue-200">
                            <i class="fas fa-file-excel mr-1"></i> Export Jadwal
                        </button>
                        <button onclick="debugRosterSystem()" class="text-[10px] bg-yellow-100 text-yellow-700 p-2 rounded hover:bg-yellow-200">
                            <i class="fas fa-bug mr-1"></i> Debug System
                        </button>
                    </div>
                </div>
            </div>
            
            <button onclick="window.print()" class="absolute bottom-6 right-6 w-12 h-12 bg-gray-800 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-black">
                <i class="fas fa-print"></i>
            </button>
        </section>

    </div>

    <!-- MAIN LOGIC -->
    <script>
        // ========== GLOBAL VARIABLES ==========
        let currentUser = null;
        let currentShift = null;
        let userLocation = null;
        let adminData = [];
        let userHistoryData = [];
        let todayStatus = null;
        
        // Untuk schedule view
        let scheduleCurrentMonth = new Date().getMonth() + 1;
        let scheduleCurrentYear = new Date().getFullYear();
        let monthlyScheduleData = null;

        // ========== INITIALIZATION ==========
        function initApp() {
            console.log("=== ABSENSI APP INITIALIZED ===");
            console.log("Script URL:", SCRIPT_URL);
            
            // Set default filter dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('filterStartDate').value = today;
            document.getElementById('filterEndDate').value = today;
            
            // Initialize GPS
            initializeGPS();
            
            // Load shift info modal on login page
            setTimeout(() => {
                if (!currentUser) {
                    showScheduleInfo();
                }
            }, 1000);
        }

        function initializeGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(updatePosition, errorPosition, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
                
                navigator.geolocation.watchPosition(updatePosition, errorPosition, {
                    enableHighAccuracy: true,
                    maximumAge: 30000
                });
            } else {
                document.getElementById('locationStatus').innerText = "GPS Tidak Support";
                document.getElementById('gpsIndicator').className = "w-2 h-2 rounded-full bg-red-500 ml-2";
            }
        }

        // ========== GPS FUNCTIONS ==========
        function updatePosition(pos) {
            userLocation = { 
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude,
                accuracy: pos.coords.accuracy
            };
            
            const d = getDistance(userLocation.lat, userLocation.lng, CLINIC_LAT, CLINIC_LNG);
            const accuracyText = userLocation.accuracy > 50 ? ` (Â±${Math.round(userLocation.accuracy)}m)` : '';
            
            document.getElementById('distanceStatus').innerText = `${Math.round(d)} m dari klinik${accuracyText}`;
            const gpsEl = document.getElementById('gpsIndicator');
            const locTxt = document.getElementById('locationStatus');

            if(d <= MAX_RADIUS_METER) {
                gpsEl.className = "w-2 h-2 rounded-full bg-green-500 ml-2 pulse";
                locTxt.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Lokasi Valid`;
                locTxt.className = "text-[10px] font-bold text-green-600";
            } else {
                gpsEl.className = "w-2 h-2 rounded-full bg-red-500 ml-2";
                locTxt.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Di Luar Area`;
                locTxt.className = "text-[10px] font-bold text-red-600";
            }
        }

        function errorPosition(err) {
            console.error("GPS Error:", err);
            document.getElementById('locationStatus').innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> GPS Error`;
            document.getElementById('locationStatus').className = "text-[10px] font-bold text-red-600";
            document.getElementById('distanceStatus').innerText = "Aktifkan GPS dan berikan izin";
            document.getElementById('gpsIndicator').className = "w-2 h-2 rounded-full bg-red-500 ml-2";
        }

        function requestLocation() {
            document.getElementById('locationStatus').innerText = "Meminta lokasi...";
            document.getElementById('distanceStatus').innerText = "Silakan izinkan akses GPS";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    updatePosition, 
                    errorPosition, 
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // ========== AUTH FUNCTIONS ==========
        function handleLogin() {
            const name = document.getElementById('selectNama').value;
            if (!name) {
                Swal.fire({
                    toast: true,
                    position: 'top',
                    icon: 'warning',
                    title: 'Pilih nama dulu',
                    showConfirmButton: false,
                    timer: 1500
                });
                return;
            }

            currentUser = name;
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('flex');
            
            loadUserDashboard();
            loadUserHistory();
            loadNextDaysSchedule();
            checkTodayStatus();
        }

        function logout() {
            Swal.fire({
                title: 'Keluar?',
                text: 'Apakah Anda yakin ingin keluar?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#db2777',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        }

        function refreshUserData() {
            loadUserDashboard();
            loadUserHistory();
            loadNextDaysSchedule();
            checkTodayStatus();
            requestLocation();
            
            Swal.fire({
                toast: true,
                position: 'top',
                icon: 'success',
                title: 'Data diperbarui',
                showConfirmButton: false,
                timer: 1000
            });
        }

        // ========== TODAY STATUS FUNCTIONS ==========
        function checkTodayStatus() {
            if (!currentUser) return;
            
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "GET_TODAY_STATUS",
                    nama: currentUser
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.result === 'success') {
                    todayStatus = data.data;
                    updateTodayStatusBanner();
                }
            })
            .catch(error => {
                console.error("Error checking today status:", error);
            });
        }

        function updateTodayStatusBanner() {
            const banner = document.getElementById('todayStatusBanner');
            const statusText = document.getElementById('todayStatusText');
            const statusDetails = document.getElementById('todayStatusDetails');
            const shiftTime = document.getElementById('todayShiftTime');
            const actionButtons = document.getElementById('todayActionButtons');
            const btnAbsenMasuk = document.getElementById('btnAbsenMasuk');
            
            if (!todayStatus || todayStatus.status === "Belum Absen") {
                banner.classList.add('hidden');
                btnAbsenMasuk.disabled = false;
                btnAbsenMasuk.className = "col-span-1 bg-gradient-to-br from-green-500 to-green-600 text-white p-3 rounded-xl shadow-lg shadow-green-200 active:scale-95 transition flex flex-col items-center justify-center gap-1 h-24";
                return;
            }
            
            banner.classList.remove('hidden');
            
            if (todayStatus.status === "Hadir") {
                if (todayStatus.sudah_pulang) {
                    // Sudah absen pulang
                    statusText.textContent = "âœ“ Sudah Absen Hari Ini";
                    statusDetails.innerHTML = `Masuk: <strong>${todayStatus.jam_masuk}</strong> | Pulang: <strong>${todayStatus.jam_pulang}</strong>`;
                    shiftTime.textContent = todayStatus.shift === "Sore" ? "15:00-21:30" : "08:00-17:00";
                    
                    actionButtons.innerHTML = `
                        <button class="text-[10px] bg-white/20 px-3 py-1 rounded-full hover:bg-white/30">
                            <i class="fas fa-check-circle mr-1"></i> Selesai
                        </button>
                    `;
                    
                    btnAbsenMasuk.disabled = true;
                    btnAbsenMasuk.className = "col-span-1 bg-gray-300 text-gray-500 p-3 rounded-xl cursor-not-allowed flex flex-col items-center justify-center gap-1 h-24";
                } else {
                    // Sudah absen masuk, belum pulang
                    statusText.textContent = "âœ“ Sudah Absen Masuk";
                    statusDetails.innerHTML = `Masuk: <strong>${todayStatus.jam_masuk}</strong> | Belum absen pulang`;
                    shiftTime.textContent = todayStatus.shift === "Sore" ? "15:00-21:30" : "08:00-17:00";
                    
                    actionButtons.innerHTML = `
                        <button onclick="absenPulangToday()" class="text-[10px] bg-white text-orange-600 px-3 py-1 rounded-full font-bold hover:bg-white/90">
                            <i class="fas fa-sign-out-alt mr-1"></i> Absen Pulang Sekarang
                        </button>
                    `;
                    
                    btnAbsenMasuk.disabled = true;
                    btnAbsenMasuk.className = "col-span-1 bg-gray-300 text-gray-500 p-3 rounded-xl cursor-not-allowed flex flex-col items-center justify-center gap-1 h-24";
                }
            } else if (todayStatus.status === "Izin" || todayStatus.status === "Sakit") {
                // Sudah izin/sakit
                statusText.textContent = `âœ“ ${todayStatus.status}`;
                statusDetails.textContent = "Tidak perlu absen masuk/pulang";
                shiftTime.textContent = "-";
                
                actionButtons.innerHTML = `
                    <button class="text-[10px] bg-white/20 px-3 py-1 rounded-full hover:bg-white/30">
                        <i class="fas fa-info-circle mr-1"></i> Sudah diizinkan
                    </button>
                `;
                
                btnAbsenMasuk.disabled = true;
                btnAbsenMasuk.className = "col-span-1 bg-gray-300 text-gray-500 p-3 rounded-xl cursor-not-allowed flex flex-col items-center justify-center gap-1 h-24";
            }
        }

        function absenPulangToday() {
            if (!userLocation) {
                Swal.fire({
                    icon: 'warning',
                    title: 'GPS Tidak Aktif',
                    text: 'Aktifkan GPS untuk absen pulang.',
                    confirmButtonColor: '#db2777'
                });
                return;
            }
            
            // Validasi lokasi
            const d = getDistance(userLocation.lat, userLocation.lng, CLINIC_LAT, CLINIC_LNG);
            if (d > MAX_RADIUS_METER) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Di Luar Area',
                    html: `
                        <div class="text-left">
                            <p>Anda berada di luar area klinik.</p>
                            <p class="text-sm">Jarak: ${Math.round(d)} m (maks: ${MAX_RADIUS_METER} m)</p>
                            <p class="text-xs text-gray-500 mt-2">Absen pulang tetap bisa dilakukan.</p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Tetap Absen Pulang',
                    cancelButtonText: 'Batal',
                    confirmButtonColor: '#f97316'
                }).then((result) => {
                    if (result.isConfirmed) {
                        processAbsenPulang();
                    }
                });
            } else {
                processAbsenPulang();
            }
        }

        function processAbsenPulang() {
            const now = new Date();
            const jamPulang = String(now.getHours()).padStart(2, '0') + ":" + 
                            String(now.getMinutes()).padStart(2, '0');
            
            Swal.fire({
                title: 'Absen Pulang?',
                html: `
                    <div class="text-left">
                        <p>Konfirmasi absen pulang untuk:</p>
                        <p><strong>Nama:</strong> ${currentUser}</p>
                        <p><strong>Jam Pulang:</strong> ${jamPulang}</p>
                        <p><strong>Lokasi:</strong> ${userLocation ? `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}` : 'GPS tidak aktif'}</p>
                        <p class="text-xs text-gray-400 mt-2">Pastikan Anda sudah menyelesaikan pekerjaan hari ini.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Absen Pulang',
                cancelButtonText: 'Batal',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return new Promise((resolve, reject) => {
                        const payload = {
                            action: "ABSEN_PULANG",
                            nama: currentUser,
                            jamPulang: jamPulang
                        };
                        
                        console.log("ðŸ“¤ Mengirim absen pulang:", payload);
                        
                        fetch(SCRIPT_URL, {
                            method: "POST",
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(data => {
                            console.log("ðŸ“¥ Response absen pulang:", data);
                            resolve(data);
                        })
                        .catch(error => {
                            console.error("âŒ Error absen pulang:", error);
                            reject(error);
                        });
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    if(data.result === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                                    <p>Absen pulang berhasil disimpan.</p>
                                    <p class="text-sm font-bold mt-2">Jam: ${jamPulang}</p>
                                    <p class="text-xs text-gray-500">Selamat beristirahat!</p>
                                </div>
                            `,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        // Update status
                        setTimeout(() => {
                            checkTodayStatus();
                            loadUserHistory();
                        }, 1000);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal',
                            html: `
                                <div class="text-left">
                                    <p>${data.message}</p>
                                    <p class="text-xs text-red-500 mt-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        ${data.message.includes('tidak ditemukan') ? 
                                            'Pastikan Anda sudah absen masuk hari ini.' : 
                                            'Silakan coba lagi atau hubungi admin.'}
                                    </p>
                                </div>
                            `,
                            confirmButtonColor: '#db2777'
                        });
                    }
                }
            });
        }

        // ========== USER DASHBOARD ==========
        function loadUserDashboard() {
            document.getElementById('userNameDisplay').innerText = currentUser;
            
            const now = new Date();
            const dayName = DAY_NAMES[now.getDay()];
            const dateStr = `${dayName}, ${now.getDate()} ${MONTH_NAMES[now.getMonth()]} ${now.getFullYear()}`;
            document.getElementById('currentDateDisplay').innerText = dateStr;
            
            // Load shift info from server
            toggleLoading(true, "Mengambil info shift...");
            
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "GET_SCHEDULE_INFO",
                    nama: currentUser,
                    date: now.toISOString().split('T')[0]
                })
            })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                
                if (data.result === 'success') {
                    currentShift = data.user_shift;
                    
                    // Update shift info card
                    const shiftInfoCard = document.getElementById('shiftInfoCard');
                    const shiftRules = data.shift_rules;
                    const badgeClass = getShiftBadgeClass(currentShift);
                    
                    shiftInfoCard.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wide">Jadwal Hari Ini</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1">${currentShift}</h3>
                                <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                                    <i class="far fa-clock"></i> ${shiftRules.label}
                                </p>
                                ${data.is_holiday ? 
                                    `<p class="text-[10px] text-red-500 mt-1 flex items-center gap-1">
                                        <i class="fas fa-flag"></i> ${data.holiday_type}
                                    </p>` : ''
                                }
                            </div>
                            <div class="${badgeClass} px-3 py-2 rounded-lg font-bold text-xs">
                                ${getShiftShortName(currentShift)}
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <p class="text-[10px] text-gray-500">Roster Index: <span class="font-bold">${data.roster_index}</span></p>
                            <p class="text-[10px] text-gray-500">Pagi: ${data.schedule.pagi.join(', ') || '-'}</p>
                            <p class="text-[10px] text-gray-500">Sore: ${data.schedule.sore.join(', ') || '-'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                toggleLoading(false);
                console.error("Error loading schedule info:", error);
            });
        }

        function getShiftBadgeClass(shiftType) {
            switch(shiftType) {
                case 'Pagi': return 'badge-pagi';
                case 'Sore': return 'badge-sore';
                case 'Jumat Full': return 'badge-jumat';
                case 'Libur': return 'badge-libur';
                case 'Libur Nasional': return 'badge-libur-nasional';
                case 'Non-Shift': return 'badge-non';
                case 'Lembur': return 'badge-lembur';
                default: return 'badge-libur';
            }
        }

        function getShiftShortName(shiftType) {
            switch(shiftType) {
                case 'Pagi': return 'PG';
                case 'Sore': return 'SR';
                case 'Jumat Full': return 'JF';
                case 'Libur': return 'LB';
                case 'Libur Nasional': return 'LN';
                case 'Non-Shift': return 'NS';
                case 'Lembur': return 'LM';
                default: return shiftType.substring(0, 2).toUpperCase();
            }
        }

        // ========== ABSENSI FUNCTIONS ==========
        function submitAbsensi(statusType) {
            // Cek status hari ini dulu
            if (todayStatus && todayStatus.status !== "Belum Absen") {
                if (statusType === 'Hadir' && todayStatus.status === 'Hadir') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sudah Absen',
                        text: 'Anda sudah absen masuk hari ini.',
                        confirmButtonColor: '#db2777'
                    });
                    return;
                }
                
                if ((statusType === 'Izin' || statusType === 'Sakit') && 
                    (todayStatus.status === 'Izin' || todayStatus.status === 'Sakit')) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sudah Diizinkan',
                        text: `Anda sudah mengajukan ${todayStatus.status.toLowerCase()} hari ini.`,
                        confirmButtonColor: '#db2777'
                    });
                    return;
                }
            }
            
            // Validasi GPS untuk absen masuk
            if (statusType === 'Hadir' && (!userLocation || !userLocation.lat)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'GPS Tidak Aktif',
                    text: 'Aktifkan GPS untuk absen masuk. Untuk izin/sakit, silakan isi alasan.',
                    confirmButtonColor: '#db2777'
                });
                return;
            }
            
            // Validasi lokasi untuk absen masuk
            if (statusType === 'Hadir' && userLocation) {
                const d = getDistance(userLocation.lat, userLocation.lng, CLINIC_LAT, CLINIC_LNG);
                if (d > MAX_RADIUS_METER) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Di Luar Area',
                        html: `
                            <div class="text-left">
                                <p>Anda berada di luar area klinik.</p>
                                <p class="text-sm">Jarak: ${Math.round(d)} m (maks: ${MAX_RADIUS_METER} m)</p>
                                <p class="text-xs text-gray-500 mt-2">Silakan mendekat ke klinik untuk absen.</p>
                            </div>
                        `,
                        confirmButtonColor: '#db2777'
                    });
                    return;
                }
            }
            
            if (statusType !== 'Hadir') {
                showReasonForm(statusType);
            } else {
                sendAbsenData(statusType, "");
            }
        }

        function showReasonForm(statusType) {
            Swal.fire({
                title: `Form ${statusType}`,
                html: `
                    <div class="text-left">
                        <p class="text-sm mb-2">Isikan alasan ${statusType.toLowerCase()}:</p>
                        <textarea id="reasonInput" class="w-full p-2 border border-gray-300 rounded text-sm" 
                            rows="3" placeholder="Contoh: ${statusType === 'Izin' ? 'Izin ke rumah sakit' : 'Sakit demam'}..."></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#db2777',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Kirim',
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const reason = document.getElementById('reasonInput').value;
                    if (!reason || reason.trim() === '') {
                        Swal.showValidationMessage('Harap isi alasan');
                        return false;
                    }
                    return reason;
                }
            }).then((res) => {
                if (res.isConfirmed) {
                    sendAbsenData(statusType, res.value);
                }
            });
        }

        function sendAbsenData(status, note) {
            toggleLoading(true, `Menyimpan absensi ${status}...`);
            
            const now = new Date();
            const timeStr = String(now.getHours()).padStart(2, '0') + ":" + 
                          String(now.getMinutes()).padStart(2, '0');

            const payload = {
                action: "ABSEN_MASUK",
                nama: currentUser,
                lokasi: userLocation ? `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}` : "No GPS",
                jamMasuk: timeStr,
                status: status,
                keterangan: note
            };

            fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify(payload) 
            })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                
                if (data.result === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Tersimpan!',
                        html: `
                            <div class="text-center">
                                <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                                <p>${data.message}</p>
                                <p class="text-sm font-bold mt-2">Jam: ${timeStr}</p>
                                <p class="text-sm">Shift: ${data.shift}</p>
                                ${data.rosterIndex !== undefined ? 
                                    `<p class="text-xs text-gray-500">Roster: ${data.rosterIndex}</p>` : ''}
                            </div>
                        `,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Refresh data
                    setTimeout(() => {
                        checkTodayStatus();
                        loadUserHistory();
                        loadUserDashboard();
                    }, 1000);
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Gagal',
                        text: data.message || 'Terjadi kesalahan',
                        confirmButtonColor: '#db2777'
                    });
                }
            })
            .catch(error => {
                toggleLoading(false);
                console.error("Error:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Koneksi Error',
                    text: 'Gagal terhubung ke server. Periksa koneksi internet.',
                    confirmButtonColor: '#db2777'
                });
            });
        }

        // ========== HISTORY FUNCTIONS ==========
        function loadUserHistory() {
            const tbody = document.getElementById('userHistoryBody');
            tbody.innerHTML = `
                <tr><td colspan="6" class="p-4 text-center text-gray-300">
                    <div class="loader mx-auto w-6 h-6 border-2"></div>
                    <p class="text-[10px] mt-2">Memuat riwayat...</p>
                </td></tr>
            `;

            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ 
                    action: "GET_USER_HISTORY", 
                    nama: currentUser 
                })
            })
            .then(res => res.json())
            .then(resp => {
                if(resp.result === 'success') {
                    userHistoryData = resp.data;
                    renderHistoryTable(resp.data);
                }
            })
            .catch(error => {
                console.error("Error loading history:", error);
                tbody.innerHTML = `
                    <tr><td colspan="6" class="p-4 text-center text-red-300">
                        <i class="fas fa-wifi-slash text-lg mb-2"></i><br>
                        Gagal terhubung ke server.
                    </td></tr>`;
            });
        }

        function renderHistoryTable(data) {
            const tbody = document.getElementById('userHistoryBody');
            tbody.innerHTML = "";
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="p-4 text-center text-gray-300 italic">
                        <i class="fas fa-inbox text-lg mb-2"></i><br>
                        Belum ada data absensi.
                    </td></tr>`;
                return;
            }
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-pink-50 transition group border-b border-gray-100";
                
                const uniqueId = row.uniqueId || '';
                const absenID = row.absenID || '';
                const tanggalDisplay = row.tanggal || '';
                const hariDisplay = row.hari || '';
                const shiftDisplay = row.shift || '-';
                const masukDisplay = row.masuk || '-';
                const pulangDisplay = row.pulang || '';
                const statusDisplay = row.status || '';
                
                // Tentukan apakah bisa absen pulang
                let actionHtml = "";
                if (statusDisplay === "Hadir" && (!pulangDisplay || pulangDisplay === "" || pulangDisplay === "-")) {
                    const today = new Date();
                    const todayStr = String(today.getDate()).padStart(2, '0') + '/' + 
                                    String(today.getMonth() + 1).padStart(2, '0');
                    
                    // Hanya tampilkan tombol pulang untuk hari ini
                    if (tanggalDisplay === todayStr || tanggalDisplay.includes(todayStr)) {
                        actionHtml = `
                            <button onclick="triggerPulangSpecific('${absenID}', '${tanggalDisplay}')" 
                                class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-2 py-1 rounded text-[10px] font-bold shadow hover:from-orange-600 hover:to-orange-700 active:scale-95 transition">
                                <i class="fas fa-sign-out-alt mr-1"></i> Pulang
                            </button>
                        `;
                    }
                }

                tr.innerHTML = `
                    <td class="p-3 text-gray-500 text-[10px]">${tanggalDisplay}</td>
                    <td class="p-3 text-gray-400 text-[10px]">${hariDisplay}</td>
                    <td class="p-3">
                        <span class="${getShiftBadgeClass(shiftDisplay)} text-[10px] px-2 py-1 rounded">
                            ${getShiftShortName(shiftDisplay)}
                        </span>
                    </td>
                    <td class="p-3 font-mono font-bold text-gray-700 text-[10px]">${masukDisplay}</td>
                    <td class="p-3 font-mono text-gray-600 text-[10px]">${pulangDisplay || '-'}</td>
                    <td class="p-3 text-center align-middle">
                        ${actionHtml}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function triggerPulangSpecific(absenID, dateDisplay) {
            if (!absenID) {
                // Jika tidak ada absenID, gunakan metode baru
                absenPulangToday();
                return;
            }
            
            const now = new Date();
            const jamPulang = String(now.getHours()).padStart(2, '0') + ":" + 
                            String(now.getMinutes()).padStart(2, '0');
            
            Swal.fire({
                title: 'Absen Pulang?',
                html: `
                    <div class="text-left">
                        <p>Konfirmasi absen pulang untuk:</p>
                        <p><strong>Tanggal:</strong> ${dateDisplay}</p>
                        <p><strong>Waktu:</strong> ${jamPulang}</p>
                        <p class="text-xs text-gray-400 mt-2">Pastikan Anda sudah berada di luar area kerja.</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#f97316',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Ya, Absen Pulang',
                cancelButtonText: 'Batal',
                showLoaderOnConfirm: true,
                preConfirm: () => {
                    return new Promise((resolve, reject) => {
                        const payload = {
                            action: "ABSEN_PULANG_BY_ID",
                            nama: currentUser,
                            absenID: absenID,
                            jamPulang: jamPulang
                        };
                        
                        fetch(SCRIPT_URL, {
                            method: "POST",
                            body: JSON.stringify(payload)
                        })
                        .then(res => res.json())
                        .then(data => {
                            resolve(data);
                        })
                        .catch(error => {
                            reject(error);
                        });
                    });
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = result.value;
                    if(data.result === 'success') {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            html: `
                                <div class="text-center">
                                    <i class="fas fa-check-circle text-4xl text-green-500 mb-3"></i>
                                    <p>Absen pulang berhasil disimpan.</p>
                                    <p class="text-sm font-bold mt-2">${data.message}</p>
                                </div>
                            `,
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                        setTimeout(() => {
                            loadUserHistory();
                            checkTodayStatus();
                        }, 1000);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal',
                            html: `
                                <div class="text-left">
                                    <p>${data.message}</p>
                                    <p class="text-xs text-gray-500 mt-2">Silakan coba lagi atau hubungi admin.</p>
                                </div>
                            `,
                            confirmButtonColor: '#db2777'
                        });
                    }
                }
            });
        }

        // ========== SCHEDULE FUNCTIONS ==========
        function showScheduleView() {
            document.getElementById('userDashboard').classList.add('hidden');
            document.getElementById('scheduleView').classList.remove('hidden');
            document.getElementById('scheduleView').classList.add('flex');
            
            document.getElementById('scheduleUserInfo').textContent = currentUser;
            loadMonthlySchedule();
        }

        function hideScheduleView() {
            document.getElementById('scheduleView').classList.add('hidden');
            document.getElementById('userDashboard').classList.remove('hidden');
            document.getElementById('userDashboard').classList.add('flex');
        }

        function loadMonthlySchedule() {
            const monthTitle = `${MONTH_NAMES[scheduleCurrentMonth - 1]} ${scheduleCurrentYear}`;
            document.getElementById('scheduleMonthTitle').textContent = monthTitle;
            
            toggleLoading(true, "Memuat jadwal bulanan...");
            
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "GET_MONTHLY_SCHEDULE",
                    nama: currentUser,
                    year: scheduleCurrentYear,
                    month: scheduleCurrentMonth
                })
            })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                
                if (data.result === 'success') {
                    monthlyScheduleData = data;
                    renderScheduleCalendar(data.schedule);
                    updateScheduleSummary(data.summary);
                }
            })
            .catch(error => {
                toggleLoading(false);
                console.error("Error loading monthly schedule:", error);
            });
        }

        function changeScheduleMonth(delta) {
            scheduleCurrentMonth += delta;
            
            if (scheduleCurrentMonth > 12) {
                scheduleCurrentMonth = 1;
                scheduleCurrentYear++;
            } else if (scheduleCurrentMonth < 1) {
                scheduleCurrentMonth = 12;
                scheduleCurrentYear--;
            }
            
            loadMonthlySchedule();
        }

        function renderScheduleCalendar(schedule) {
            const calendarDiv = document.getElementById('scheduleCalendar');
            calendarDiv.innerHTML = '';
            
            // Get first day of month
            const firstDay = new Date(scheduleCurrentYear, scheduleCurrentMonth - 1, 1).getDay();
            
            // Add empty cells for days before the first day
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = "h-10";
                calendarDiv.appendChild(emptyCell);
            }
            
            // Add days
            schedule.forEach(day => {
                const dayCell = document.createElement('div');
                dayCell.className = "border border-gray-200 rounded p-1 h-10 cursor-pointer hover:bg-gray-50";
                
                const dayClass = getShiftBadgeClass(day.shift);
                const today = new Date();
                const isToday = today.getDate() === day.day && 
                               today.getMonth() + 1 === scheduleCurrentMonth && 
                               today.getFullYear() === scheduleCurrentYear;
                
                dayCell.innerHTML = `
                    <div class="flex flex-col h-full">
                        <div class="flex justify-between items-start">
                            <span class="text-xs font-bold ${isToday ? 'text-pink-600' : 'text-gray-700'}">${day.day}</span>
                            ${day.is_holiday ? 
                                '<i class="fas fa-flag text-[8px] text-red-500"></i>' : 
                                ''
                            }
                        </div>
                        <div class="mt-auto">
                            <span class="${dayClass} text-[8px] px-1 py-0.5 rounded font-bold">
                                ${getShiftShortName(day.shift)}
                            </span>
                        </div>
                    </div>
                `;
                
                // Add click event to show day details
                dayCell.onclick = () => showDayDetails(day);
                
                calendarDiv.appendChild(dayCell);
            });
        }

        function updateScheduleSummary(summary) {
            document.getElementById('totalWorkDays').textContent = summary.work_days;
            document.getElementById('totalPagi').textContent = summary.pagi_shifts;
            document.getElementById('totalSore').textContent = summary.sore_shifts;
            document.getElementById('totalLibur').textContent = summary.off_days;
        }

        function showDayDetails(day) {
            Swal.fire({
                title: `${day.day_name}, ${day.day} ${MONTH_NAMES[scheduleCurrentMonth - 1]} ${scheduleCurrentYear}`,
                html: `
                    <div class="text-left text-sm">
                        <p><strong>Status:</strong> <span class="${getShiftBadgeClass(day.shift)} px-2 py-1 rounded text-xs">${day.shift}</span></p>
                        <p><strong>Jam:</strong> ${day.shift_info.label}</p>
                        <p><strong>Roster Index:</strong> ${day.roster_index}</p>
                        ${day.is_holiday ? '<p class="text-red-600"><i class="fas fa-flag mr-1"></i> Hari Libur Nasional</p>' : ''}
                        <p class="text-xs text-gray-500 mt-3">Klik di luar untuk menutup</p>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true
            });
        }

        function loadNextDaysSchedule() {
            const nextDaysDiv = document.getElementById('nextDaysSchedule');
            nextDaysDiv.innerHTML = '<div class="text-center text-gray-300 text-xs py-4"><i class="fas fa-spinner fa-spin mr-1"></i> Memuat jadwal...</div>';
            
            const promises = [];
            const today = new Date();
            
            // Get next 3 days
            for (let i = 1; i <= 3; i++) {
                const nextDay = new Date(today);
                nextDay.setDate(today.getDate() + i);
                const dateStr = nextDay.toISOString().split('T')[0];
                
                promises.push(
                    fetch(SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            action: "GET_SCHEDULE_INFO",
                            nama: currentUser,
                            date: dateStr
                        })
                    }).then(res => res.json())
                );
            }
            
            Promise.all(promises).then(results => {
                nextDaysDiv.innerHTML = '';
                
                results.forEach((data, index) => {
                    if (data.result === 'success') {
                        const nextDay = new Date(today);
                        nextDay.setDate(today.getDate() + index + 1);
                        const dayName = DAY_NAMES[nextDay.getDay()];
                        const dayNum = nextDay.getDate();
                        const monthName = MONTH_NAMES[nextDay.getMonth()];
                        
                        const dayDiv = document.createElement('div');
                        dayDiv.className = "bg-white border border-gray-100 rounded-lg p-3";
                        
                        dayDiv.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="text-[10px] text-gray-400">${dayName}, ${dayNum} ${monthName}</p>
                                    <p class="text-xs font-bold text-gray-700">${data.user_shift}</p>
                                    <p class="text-[10px] text-gray-500">${data.shift_rules.label}</p>
                                </div>
                                <div class="${getShiftBadgeClass(data.user_shift)} px-3 py-1 rounded font-bold text-xs">
                                    ${getShiftShortName(data.user_shift)}
                                </div>
                            </div>
                        `;
                        
                        nextDaysDiv.appendChild(dayDiv);
                    }
                });
            });
        }

        // ========== ADMIN FUNCTIONS ==========
        function showAdminLogin() {
            Swal.fire({
                title: 'Login Admin',
                html: `
                    <div class="text-left">
                        <p class="text-sm mb-2">Masukkan password admin:</p>
                        <input type="password" id="adminPassword" class="swal2-input" placeholder="Password">
                    </div>
                `,
                confirmButtonColor: '#db2777',
                showCancelButton: true,
                cancelButtonText: 'Batal',
                preConfirm: () => {
                    const password = document.getElementById('adminPassword').value;
                    if (password !== "112211") {
                        Swal.showValidationMessage('Password salah');
                        return false;
                    }
                    return true;
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('adminDashboard').classList.remove('hidden');
                    document.getElementById('adminDashboard').classList.add('flex');
                    loadAdminData();
                }
            });
        }

        function loadAdminData() {
            toggleLoading(true, "Memuat data admin...");
            
            fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: "GET_DATA" }) 
            })
            .then(res => res.json())
            .then(resp => {
                toggleLoading(false);
                if (resp.result === 'success') {
                    adminData = resp.data;
                    document.getElementById('adminDataInfo').textContent = 
                        `${resp.total} data ditemukan | ${new Date().toLocaleTimeString('id-ID')}`;
                    renderAdminTable();
                } else {
                    Swal.fire('Error', resp.message || 'Gagal memuat data', 'error');
                }
            })
            .catch(error => {
                toggleLoading(false);
                Swal.fire('Error', 'Gagal terhubung ke server', 'error');
            });
        }

        function renderAdminTable() {
            const startStr = document.getElementById('filterStartDate').value;
            const endStr = document.getElementById('filterEndDate').value;
            const nameFilter = document.getElementById('filterName').value;
            
            const sDate = startStr ? new Date(startStr) : null;
            const eDate = endStr ? new Date(endStr) : null;
            if (sDate) sDate.setHours(0,0,0,0);
            if (eDate) eDate.setHours(0,0,0,0);

            let h=0, t=0, i=0;
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = "";

            const filtered = adminData.filter(row => {
                const rDate = new Date(row.tanggal);
                rDate.setHours(0,0,0,0);
                if (sDate && rDate < sDate) return false;
                if (eDate && rDate > eDate) return false;
                if (nameFilter !== "All" && row.nama !== nameFilter) return false;
                return true;
            });

            filtered.sort((a,b) => {
                const dateA = new Date(a.timestamp || a.tanggal);
                const dateB = new Date(b.timestamp || b.tanggal);
                return dateB - dateA;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="p-4 text-center text-gray-300">
                        <i class="fas fa-inbox text-lg mb-2"></i><br>
                        Tidak ada data untuk filter ini.
                    </td></tr>`;
                document.getElementById('statHadir').innerText = "0";
                document.getElementById('statTelat').innerText = "0";
                document.getElementById('statIzin').innerText = "0";
                return;
            }

            filtered.forEach(row => {
                if (row.status === 'Hadir') h++;
                if (parseInt(row.telat) > 0) t++;
                if (['Sakit','Izin'].includes(row.status)) i++;
                
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-pink-50";
                
                let dateDisp = row.tanggal ? row.tanggal.split('-').reverse().slice(0,2).join('/') : '-';
                let statusClass = row.status === 'Hadir' ? 
                    (row.jam_pulang && row.jam_pulang !== '-' ? 'text-green-600' : 'text-blue-600') : 
                    'text-yellow-600';
                
                const lateBadge = parseInt(row.telat) > 0 ? 
                    `<span class="text-[8px] bg-red-100 text-red-700 px-1 py-0.5 rounded ml-1">+${row.telat}m</span>` : '';

                tr.innerHTML = `
                    <td class="p-2 text-gray-500 text-[9px]">${dateDisp}</td>
                    <td class="p-2 font-bold text-gray-700 text-[9px]">${row.nama}</td>
                    <td class="p-2 text-[9px]">
                        <span class="${getShiftBadgeClass(row.shift)} px-2 py-0.5 rounded text-[8px]">
                            ${getShiftShortName(row.shift)}
                        </span>
                    </td>
                    <td class="p-2 font-mono text-gray-600 text-[9px]">${row.jam_masuk || '-'}${lateBadge}</td>
                    <td class="p-2 font-mono text-gray-600 text-[9px]">${row.jam_pulang || '-'}</td>
                    <td class="p-2 font-bold text-[9px] uppercase ${statusClass}">${row.status}</td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('statHadir').innerText = h;
            document.getElementById('statTelat').innerText = t;
            document.getElementById('statIzin').innerText = i;
        }

        function generateScheduleReport() {
            Swal.fire({
                title: 'Generate Report?',
                text: 'Laporan jadwal akan dibuat di Google Sheets',
                icon: 'info',
                showCancelButton: true,
                confirmButtonColor: '#db2777',
                confirmButtonText: 'Generate'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Note: This would need to be implemented on the backend
                    Swal.fire('Info', 'Fitur ini memerlukan konfigurasi tambahan di backend', 'info');
                }
            });
        }

        function debugRosterSystem() {
            toggleLoading(true, "Running debug...");
            
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "DEBUG_ROSTER",
                    date: new Date().toISOString().split('T')[0]
                })
            })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                
                if (data.result === 'success') {
                    console.log("Debug Data:", data);
                    
                    let debugHtml = `
                        <div class="text-left text-xs max-h-96 overflow-y-auto">
                            <p><strong>Test Date:</strong> ${data.test_date}</p>
                            <p><strong>Day:</strong> ${data.day_name}</p>
                            <p><strong>Roster Index:</strong> ${data.roster_index}</p>
                            <p><strong>Cycle Info:</strong> ${data.cycle_info.current_position}/${data.cycle_info.total_days}</p>
                            <hr class="my-2">
                            <p><strong>Schedule Today:</strong></p>
                            <ul class="list-disc pl-4">
                                <li>Pagi: ${data.schedule_today.p.join(', ') || '-'}</li>
                                <li>Sore: ${data.schedule_today.s.join(', ') || '-'}</li>
                                <li>Libur: ${data.schedule_today.l.join(', ') || '-'}</li>
                            </ul>
                            <hr class="my-2">
                            <p><strong>All User Shifts:</strong></p>
                            <pre class="bg-gray-100 p-2 rounded mt-1">${JSON.stringify(data.all_user_shifts, null, 2)}</pre>
                        </div>
                    `;
                    
                    Swal.fire({
                        title: 'Debug Roster System',
                        html: debugHtml,
                        width: '80%',
                        confirmButtonColor: '#db2777'
                    });
                }
            })
            .catch(error => {
                toggleLoading(false);
                console.error("Debug error:", error);
            });
        }

        // ========== UTILITY FUNCTIONS ==========
        function toggleLoading(show, message = "Memproses Data...") {
            const el = document.getElementById('loadingOverlay');
            const textEl = document.getElementById('loadingText');
            
            textEl.textContent = message;
            
            if (show) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        function showScheduleInfo() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            toggleLoading(true, "Mengambil info sistem...");
            
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "GET_SCHEDULE_INFO",
                    date: todayStr
                })
            })
            .then(res => res.json())
            .then(data => {
                toggleLoading(false);
                
                if (data.result === 'success') {
                    let infoHtml = `
                        <div class="text-left text-sm">
                            <p class="font-bold text-lg mb-2">Sistem Jadwal Shift 2026</p>
                            <p><strong>Tanggal:</strong> ${data.date} (${data.day_name})</p>
                            <p><strong>Status:</strong> ${data.is_holiday ? 'Libur Nasional' : 'Hari Kerja'}</p>
                            <p><strong>Roster Index:</strong> ${data.roster_index}/35</p>
                            <hr class="my-2">
                            <p><strong>Jadwal Hari Ini:</strong></p>
                            <ul class="list-disc pl-4">
                                <li><span class="badge-pagi px-2 py-1 rounded text-xs">PG</span> Pagi: ${data.schedule.pagi.join(', ') || '-'}</li>
                                <li><span class="badge-sore px-2 py-1 rounded text-xs">SR</span> Sore: ${data.schedule.sore.join(', ') || '-'}</li>
                                <li><span class="badge-libur px-2 py-1 rounded text-xs">LB</span> Libur: ${data.schedule.libur.join(', ') || '-'}</li>
                            </ul>
                            <hr class="my-2">
                            <p class="text-xs text-gray-500">Sistem menggunakan siklus 35 hari dengan kalibrasi tanggal 1 Januari 2026.</p>
                        </div>
                    `;
                    
                    Swal.fire({
                        title: 'Info Sistem Jadwal',
                        html: infoHtml,
                        width: '80%',
                        confirmButtonColor: '#db2777',
                        confirmButtonText: 'Mengerti'
                    });
                }
            })
            .catch(error => {
                toggleLoading(false);
                Swal.fire('Error', 'Gagal memuat info sistem', 'error');
            });
        }

        // ========== INIT APP ON LOAD ==========
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
