<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi Bidan & Terapis - Sistem Lengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #FFF0F5;
            background-image: url('https://www.transparenttextures.com/patterns/sakura.png');
        }
        .kawaii-shadow {
            box-shadow: 0 4px 6px -1px rgba(219, 112, 147, 0.3), 0 2px 4px -2px rgba(219, 112, 147, 0.2);
        }
        .btn-primary {
            background-color: #FF69B4;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #FF1493;
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            background-color: #f7b8d6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background-color: #87CEEB;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #00BFFF;
            transform: translateY(-2px);
        }
        .btn-admin {
            background-color: #9370DB;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-admin:hover {
            background-color: #7B68EE;
            transform: translateY(-2px);
        }
        .tab-active {
            border-bottom: 3px solid #FF69B4;
            color: #FF69B4;
            font-weight: 700;
        }
        .tab-inactive {
            color: #a0aec0;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .attendance-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        .attendance-item:hover {
            background-color: #f9fafb;
            border-left-color: #FF69B4;
        }
        .attendance-item.selected {
            background-color: #f0f9ff;
            border-left-color: #3b82f6;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF69B4;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-day {
            border: 1px solid #e2e8f0;
            min-height: 100px;
            padding: 8px;
            position: relative;
        }
        .calendar-day.today {
            background-color: #f0fff4;
            border-color: #68d391;
        }
        .calendar-day.weekend {
            background-color: #f7fafc;
        }
        .calendar-event {
            background-color: #bee3f8;
            border-radius: 4px;
            padding: 2px 4px;
            margin-bottom: 2px;
            font-size: 12px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .calendar-event.pagi {
            background-color: #c6f6d5;
            border-left: 3px solid #38a169;
        }
        .calendar-event.sore {
            background-color: #fed7d7;
            border-left: 3px solid #e53e3e;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .admin-locked {
            position: relative;
        }
        .admin-locked::after {
            content: "üîí";
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 14px;
        }
        .chart-container {
            position: relative;
            height: 350px;
            width: 100%;
        }
        .shift-pagi {
            background-color: #c6f6d5;
            border-color: #38a169;
        }
        .shift-sore {
            background-color: #fed7d7;
            border-color: #e53e3e;
        }
        .export-option {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .export-option:hover {
            border-color: #FF69B4;
            transform: translateY(-2px);
        }
        .export-option.selected {
            border-color: #FF69B4;
            background-color: #fdf2f8;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Elemen audio tersembunyi -->
    <audio id="backgroundAudio" loop autoplay>
        <source src="lagu.mp3" type="audio/mpeg">
        Browser Anda tidak mendukung elemen audio.
    </audio>
    
    <!-- Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center kawaii-shadow fade-in">
            <h2 class="text-3xl font-bold text-pink-500 mb-2">‚ô° Konnichiwa! ‚ô°</h2>
            <p class="text-lg text-gray-600 mb-6">Siapa nama kamu? üòä</p>
            <input type="text" id="name-input" placeholder="Tulis nama/nama panggilan di sini..." class="w-full px-4 py-3 border-2 border-pink-200 rounded-lg focus:outline-none focus:border-pink-400 mb-6 text-center">
            <button id="start-btn" class="w-full btn-primary font-bold py-3 rounded-lg kawaii-shadow">Masuk</button>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full text-center kawaii-shadow fade-in">
            <h2 class="text-3xl font-bold text-purple-500 mb-2">üîê Admin Panel</h2>
            <p class="text-lg text-gray-600 mb-6">Masukkan password admin</p>
            <input type="password" id="admin-password" placeholder="Password admin..." class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:outline-none focus:border-purple-400 mb-6 text-center">
            <button id="admin-login-submit" class="w-full btn-admin font-bold py-3 rounded-lg kawaii-shadow">Masuk</button>
            <button id="admin-login-cancel" class="w-full bg-gray-300 text-gray-700 font-bold py-3 rounded-lg kawaii-shadow mt-2">Batal</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="max-w-7xl mx-auto bg-white min-h-screen shadow-lg hidden">
        <div class="p-6 bg-pink-100" style="background-image: url('https://i.pinimg.com/564x/c2/a7/9a/c2a79a0f4435887803673059811438a3.jpg'); background-size: cover; background-position: center;">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">Absensi Bidan Terapis & Admin</h1>
                    <div class="text-white mt-1" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.3);">
                        <p class="font-medium text-sm" id="display-name">Nabilah Pulungan</p>
                        <p class="text-xs" id="current-datetime">Senin, 1 Januari 2024</p>
                    </div>
                </div>
                <div class="text-right">
                    <button id="user-logout" class="bg-white text-pink-500 px-4 py-2 rounded-lg text-sm font-medium kawaii-shadow">Logout</button>
                    <button id="admin-access-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium kawaii-shadow mt-2">Admin Access</button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b">
            <button id="tab-datang" class="flex-1 py-3 text-center font-medium tab-active">Absen Datang</button>
            <button id="tab-pulang" class="flex-1 py-3 text-center font-medium tab-inactive">Absen Pulang</button>
            <button id="tab-admin" class="flex-1 py-3 text-center font-medium tab-inactive admin-locked">Panel Admin</button>
        </div>

        <div class="p-6 space-y-6">
            <!-- Universal Shift Selector -->
            <div class="bg-blue-50 p-4 rounded-lg kawaii-shadow">
                <h3 class="font-bold text-lg text-blue-800 mb-2">Pilih Shift Kerja Hari Ini</h3>
                <div class="flex space-x-4">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="shift" value="Pagi" class="form-radio text-pink-500" checked>
                        <span class="text-gray-700">‚òÄÔ∏è Pagi (08:00 - 17:00)</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="shift" value="Sore" class="form-radio text-pink-500">
                        <span class="text-gray-700">üåô Sore (15:00 - 21:30)</span>
                    </label>
                </div>
            </div>

            <!-- Datang Tab Content -->
            <div id="content-datang">
                <div class="bg-green-50 p-4 rounded-lg kawaii-shadow">
                    <h3 class="font-bold text-lg text-green-800 mb-2">Lokasi Kamu Saat Ini</h3>
                    <button id="get-location-btn" class="w-full btn-secondary font-bold py-2 rounded-lg text-sm mb-2 kawaii-shadow">üìç Dapatkan Lokasi</button>
                    <p id="location-display" class="text-center text-gray-600 text-sm h-10">Lokasi akan tampil di sini...</p>
                </div>

                <button id="absen-datang-btn" class="w-full btn-primary font-bold py-4 rounded-lg kawaii-shadow text-lg mt-4" disabled>Absen Datang & Kirim</button>
            </div>

            <!-- Pulang Tab Content -->
            <div id="content-pulang" class="hidden">
                <div class="bg-yellow-50 p-4 rounded-lg kawaii-shadow">
                    <h3 class="font-bold text-lg text-yellow-800 mb-2">Daftar Absen Datang (Belum Pulang)</h3>
                    <div class="flex items-center mb-2">
                        <input type="text" id="search-absen" placeholder="Cari berdasarkan nama..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                        <button id="refresh-absen-btn" class="ml-2 bg-pink-500 text-white px-4 py-2 rounded-lg kawaii-shadow">Refresh</button>
                    </div>
                    <div id="absen-list" class="space-y-2 max-h-60 overflow-y-auto p-2">
                        <!-- List absen datang akan ditampilkan di sini -->
                    </div>
                </div>

                <div class="bg-green-50 p-4 rounded-lg kawaii-shadow mt-4">
                    <h3 class="font-bold text-lg text-green-800 mb-2">Lokasi Kamu Saat Ini</h3>
                    <button id="get-location-btn-pulang" class="w-full btn-secondary font-bold py-2 rounded-lg text-sm mb-2 kawaii-shadow">üìç Dapatkan Lokasi</button>
                    <p id="location-display-pulang" class="text-center text-gray-600 text-sm h-10">Lokasi akan tampil di sini...</p>
                </div>

                <button id="absen-pulang-btn" class="w-full btn-primary font-bold py-4 rounded-lg kawaii-shadow text-lg mt-4" disabled>Absen Pulang & Kirim</button>
            </div>

            <!-- Admin Tab Content -->
            <div id="content-admin" class="hidden">
                <!-- Admin Access Required Message -->
                <div id="admin-access-required" class="bg-yellow-50 p-8 rounded-lg kawaii-shadow text-center">
                    <div class="text-5xl mb-4">üîí</div>
                    <h3 class="text-xl font-bold text-yellow-800 mb-2">Akses Admin Diperlukan</h3>
                    <p class="text-gray-600 mb-6">Panel admin membutuhkan autentikasi. Silakan login sebagai admin untuk mengakses fitur ini.</p>
                    <button id="admin-login-from-tab" class="btn-admin font-bold py-3 px-6 rounded-lg kawaii-shadow">Login sebagai Admin</button>
                </div>

                <!-- Admin Content (akan ditampilkan setelah login) -->
                <div id="admin-content" class="hidden">
                    <!-- Admin Controls -->
                    <div class="bg-purple-50 p-4 rounded-lg kawaii-shadow mb-6">
                        <h3 class="font-bold text-lg text-purple-800 mb-4">Kontrol Admin</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <button id="refresh-admin-data" class="btn-admin py-2 rounded-lg kawaii-shadow">Refresh Data</button>
                            <button id="export-data" class="btn-secondary py-2 rounded-lg kawaii-shadow">Export Data</button>
                            <button id="fix-user-data" class="bg-yellow-500 text-white py-2 rounded-lg kawaii-shadow">Perbaiki Data User</button>
                            <button id="generate-pdf" class="bg-red-500 text-white py-2 rounded-lg kawaii-shadow">Generate PDF Report</button>
                        </div>
                    </div>

                    <!-- PDF Export Modal -->
                    <div id="pdf-export-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
                        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full kawaii-shadow fade-in">
                            <h2 class="text-2xl font-bold text-pink-500 mb-4">Export Laporan PDF</h2>
                            <div class="space-y-4 mb-6">
                                <p class="text-gray-600">Pilih jenis laporan yang ingin diexport:</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="export-option" data-type="table">
                                        <div class="text-center">
                                            <div class="text-3xl mb-2">üìä</div>
                                            <h4 class="font-bold text-gray-800">Data Tabel</h4>
                                            <p class="text-sm text-gray-600 mt-1">Data absensi dalam format tabel</p>
                                        </div>
                                    </div>
                                    <div class="export-option" data-type="calendar">
                                        <div class="text-center">
                                            <div class="text-3xl mb-2">üìÖ</div>
                                            <h4 class="font-bold text-gray-800">Kalender</h4>
                                            <p class="text-sm text-gray-600 mt-1">Tampilan kalender absensi</p>
                                        </div>
                                    </div>
                                    <div class="export-option" data-type="statistics">
                                        <div class="text-center">
                                            <div class="text-3xl mb-2">üìà</div>
                                            <h4 class="font-bold text-gray-800">Statistik</h4>
                                            <p class="text-sm text-gray-600 mt-1">Grafik dan statistik lengkap</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-blue-50 p-4 rounded-lg mt-4">
                                    <p class="text-sm text-blue-800"><strong>Tip:</strong> Anda bisa memilih satu, dua, atau ketiga jenis laporan sekaligus!</p>
                                </div>
                            </div>
                            <div class="flex space-x-4">
                                <button id="generate-pdf-btn" class="flex-1 bg-red-500 text-white py-3 rounded-lg kawaii-shadow">Generate PDF</button>
                                <button id="cancel-pdf-export" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg kawaii-shadow">Batal</button>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Filter Data</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                                <input type="text" id="filter-nama" placeholder="Semua nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                <input type="date" id="filter-tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                                <select id="filter-shift" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                    <option value="">Semua Shift</option>
                                    <option value="Pagi">Pagi</option>
                                    <option value="Sore">Sore</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 flex space-x-4">
                            <button id="apply-filters" class="btn-primary px-4 py-2 rounded-lg kawaii-shadow">Terapkan Filter</button>
                            <button id="clear-filters" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Hapus Filter</button>
                        </div>
                    </div>

                    <!-- View Options -->
                    <div class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Tampilan Data</h3>
                        <div class="flex space-x-4">
                            <button id="view-table" class="btn-secondary px-4 py-2 rounded-lg kawaii-shadow">Tabel</button>
                            <button id="view-calendar" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Kalender</button>
                            <button id="view-statistics" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Statistik</button>
                        </div>
                    </div>

                    <!-- Table View -->
                    <div id="table-view" class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Data Absensi</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-700">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3">Tanggal</th>
                                        <th class="px-4 py-3">Nama</th>
                                        <th class="px-4 py-3">Shift</th>
                                        <th class="px-4 py-3">Waktu Datang</th>
                                        <th class="px-4 py-3">Keterlambatan</th>
                                        <th class="px-4 py-3">Waktu Pulang</th>
                                        <th class="px-4 py-3">Total Jam</th>
                                        <th class="px-4 py-3">Status</th>
                                        <th class="px-4 py-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-table-body">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Calendar View -->
                    <div id="calendar-view" class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6 hidden">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Kalender Absensi</h3>
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month" class="btn-secondary px-4 py-2 rounded-lg kawaii-shadow">‚Üê Bulan Sebelumnya</button>
                            <h4 id="current-month" class="text-lg font-bold">Januari 2024</h4>
                            <button id="next-month" class="btn-secondary px-4 py-2 rounded-lg kawaii-shadow">Bulan Selanjutnya ‚Üí</button>
                        </div>
                        
                        <div class="grid grid-cols-7 text-center font-bold py-2 bg-gray-100 text-sm">
                            <div>Min</div>
                            <div>Sen</div>
                            <div>Sel</div>
                            <div>Rab</div>
                            <div>Kam</div>
                            <div>Jum</div>
                            <div>Sab</div>
                        </div>
                        <div id="calendar-container" class="grid grid-cols-7 gap-1">
                            <!-- Kalender akan diisi oleh JavaScript -->
                        </div>
                    </div>

                    <!-- Statistics View -->
                    <div id="statistics-view" class="bg-white p-4 rounded-lg kawaii-shadow border border-gray-200 mb-6 hidden">
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Statistik Absensi</h3>
                        
                        <!-- Period Selector -->
                        <div class="bg-blue-50 p-4 rounded-lg mb-6">
                            <h4 class="font-bold text-blue-800 mb-2">Pilih Periode Statistik</h4>
                            <div class="flex space-x-4">
                                <button data-period="weekly" class="stats-period-btn btn-secondary px-4 py-2 rounded-lg kawaii-shadow">Mingguan</button>
                                <button data-period="monthly" class="stats-period-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Bulanan</button>
                                <button data-period="yearly" class="stats-period-btn bg-gray-300 text-gray-700 px-4 py-2 rounded-lg kawaii-shadow">Tahunan</button>
                            </div>
                        </div>

                        <!-- Summary Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="stat-card">
                                <h4 class="text-lg font-bold mb-2">Total Absensi Bulan Ini</h4>
                                <p id="total-absensi" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="stat-card">
                                <h4 class="text-lg font-bold mb-2">Rata-rata Keterlambatan</h4>
                                <p id="avg-late" class="text-3xl font-bold">0 menit</p>
                            </div>
                            <div class="stat-card">
                                <h4 class="text-lg font-bold mb-2">Total Keterlambatan</h4>
                                <p id="total-late" class="text-3xl font-bold">0 menit</p>
                            </div>
                        </div>

                        <!-- Charts Container -->
                        <div id="charts-container" class="mt-6">
                             <!-- Grafik akan dimuat di sini -->
                        </div>
                    </div>

                    <!-- Edit Modal -->
                    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
                        <div class="bg-white rounded-2xl p-8 max-w-md w-full kawaii-shadow fade-in">
                            <h2 class="text-2xl font-bold text-pink-500 mb-4">Edit Data Absensi</h2>
                            <form id="edit-form" class="space-y-4">
                                <input type="hidden" id="edit-id">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
                                    <input type="date" id="edit-tanggal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                                    <input type="text" id="edit-nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Shift</label>
                                    <select id="edit-shift" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                        <option value="Pagi">Pagi</option>
                                        <option value="Sore">Sore</option>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Datang</label>
                                        <input type="time" id="edit-waktu-datang" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" step="1">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Waktu Pulang</label>
                                        <input type="time" id="edit-waktu-pulang" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300" step="1">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Keterlambatan (Otomatis/Manual)</label>
                                    <input type="text" id="edit-keterlambatan" placeholder="Contoh: 5 menit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Lembur (Otomatis/Manual)</label>
                                    <input type="text" id="edit-lembur" placeholder="Contoh: 30 menit" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
                                </div>
                                <div class="flex space-x-4 mt-6">
                                    <button type="submit" class="flex-1 btn-primary py-3 rounded-lg kawaii-shadow">Simpan Perubahan</button>
                                    <button type="button" id="cancel-edit" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg kawaii-shadow">Batal</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg border-l-4 border-green-500 hidden z-50 max-w-sm fade-in">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3 text-green-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div>
                <p id="toast-message" class="text-gray-800 font-medium">Pesan notifikasi</p>
            </div>
        </div>
    </div>

    <script>
        // URL Google Apps Script Anda
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZxc9s1hUgn04AM3OWV4JLEr1l_oHn8VM0L4Cwaqev54gKag31teoWNSFHa3JBB4FKMQ/exec";

        // Eelemen audio tersembunyi
        // Mengatasi kebijakan autoplay browser
        document.addEventListener('DOMContentLoaded', function() {
            const audio = document.getElementById('backgroundAudio');
            
            // Coba putar audio
            const playAudio = () => {
                audio.play().catch(error => {
                    console.log('Autoplay diblokir, menunggu interaksi pengguna');
                });
            };
            
            // Coba putar saat halaman dimuat
            playAudio();
            
            // Coba putar kembali setelah interaksi pengguna
            document.addEventListener('click', function() {
                if (audio.paused) {
                    playAudio();
                }
            });
        });
        
        // State management untuk aplikasi
        let state = {
            currentUser: null,
            currentTab: 'datang',
            isAdmin: false,
            currentLocation: null,
            absenDatangList: [],
            allAttendanceData: [],
            filteredAttendanceData: [],
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            charts: {},
            currentStatsPeriod: 'weekly',
            selectedExports: new Set()
        };

        // Cache elemen DOM untuk performa
        const elements = {
            welcomeModal: document.getElementById('welcome-modal'),
            adminLoginModal: document.getElementById('admin-login-modal'),
            mainContent: document.getElementById('main-content'),
            editModal: document.getElementById('edit-modal'),
            pdfExportModal: document.getElementById('pdf-export-modal'),
            toast: document.getElementById('toast'),
            nameInput: document.getElementById('name-input'),
            adminPassword: document.getElementById('admin-password'),
            startBtn: document.getElementById('start-btn'),
            adminAccessBtn: document.getElementById('admin-access-btn'),
            userLogout: document.getElementById('user-logout'),
            adminLoginSubmit: document.getElementById('admin-login-submit'),
            adminLoginCancel: document.getElementById('admin-login-cancel'),
            adminLoginFromTab: document.getElementById('admin-login-from-tab'),
            getLocationBtn: document.getElementById('get-location-btn'),
            getLocationBtnPulang: document.getElementById('get-location-btn-pulang'),
            absenDatangBtn: document.getElementById('absen-datang-btn'),
            absenPulangBtn: document.getElementById('absen-pulang-btn'),
            refreshAbsenBtn: document.getElementById('refresh-absen-btn'),
            generatePdf: document.getElementById('generate-pdf'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            cancelPdfExport: document.getElementById('cancel-pdf-export'),
            tabDatang: document.getElementById('tab-datang'),
            tabPulang: document.getElementById('tab-pulang'),
            tabAdmin: document.getElementById('tab-admin'),
            contentDatang: document.getElementById('content-datang'),
            contentPulang: document.getElementById('content-pulang'),
            contentAdmin: document.getElementById('content-admin'),
            adminAccessRequired: document.getElementById('admin-access-required'),
            adminContent: document.getElementById('admin-content'),
            refreshAdminData: document.getElementById('refresh-admin-data'),
            exportData: document.getElementById('export-data'),
            fixUserData: document.getElementById('fix-user-data'),
            filterNama: document.getElementById('filter-nama'),
            filterTanggal: document.getElementById('filter-tanggal'),
            filterShift: document.getElementById('filter-shift'),
            applyFilters: document.getElementById('apply-filters'),
            clearFilters: document.getElementById('clear-filters'),
            viewTable: document.getElementById('view-table'),
            viewCalendar: document.getElementById('view-calendar'),
            viewStatistics: document.getElementById('view-statistics'),
            tableView: document.getElementById('table-view'),
            calendarView: document.getElementById('calendar-view'),
            statisticsView: document.getElementById('statistics-view'),
            adminTableBody: document.getElementById('admin-table-body'),
            calendarContainer: document.getElementById('calendar-container'),
            currentMonth: document.getElementById('current-month'),
            prevMonth: document.getElementById('prev-month'),
            nextMonth: document.getElementById('next-month'),
            statsPeriodBtns: document.querySelectorAll('.stats-period-btn'),
            chartsContainer: document.getElementById('charts-container'),
            editForm: document.getElementById('edit-form'),
            editId: document.getElementById('edit-id'),
            editTanggal: document.getElementById('edit-tanggal'),
            editNama: document.getElementById('edit-nama'),
            editShift: document.getElementById('edit-shift'),
            editWaktuDatang: document.getElementById('edit-waktu-datang'),
            editWaktuPulang: document.getElementById('edit-waktu-pulang'),
            editKeterlambatan: document.getElementById('edit-keterlambatan'),
            editLembur: document.getElementById('edit-lembur'),
            cancelEdit: document.getElementById('cancel-edit'),
            displayName: document.getElementById('display-name'),
            currentDatetime: document.getElementById('current-datetime'),
            locationDisplay: document.getElementById('location-display'),
            locationDisplayPulang: document.getElementById('location-display-pulang'),
            absenList: document.getElementById('absen-list'),
            searchAbsen: document.getElementById('search-absen'),
            totalAbsensi: document.getElementById('total-absensi'),
            avgLate: document.getElementById('avg-late'),
            totalLate: document.getElementById('total-late')
        };

        function init() {
            setupEventListeners();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            const storedUser = localStorage.getItem('currentUser');
            const storedAdmin = localStorage.getItem('isAdmin') === 'true';
            if (storedUser) {
                state.currentUser = storedUser;
                state.isAdmin = storedAdmin;
                elements.welcomeModal.classList.add('hidden');
                elements.mainContent.classList.remove('hidden');
                elements.displayName.textContent = storedUser;
                updateAdminState();
            }
        }

        function setupEventListeners() {
            elements.startBtn.addEventListener('click', handleStart);
            elements.nameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleStart(); });
            elements.adminAccessBtn.addEventListener('click', showAdminLogin);
            elements.userLogout.addEventListener('click', handleLogout);
            elements.adminLoginSubmit.addEventListener('click', handleAdminLogin);
            elements.adminLoginCancel.addEventListener('click', hideAdminLogin);
            elements.adminPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAdminLogin(); });
            elements.adminLoginFromTab.addEventListener('click', showAdminLogin);
            elements.tabDatang.addEventListener('click', () => switchTab('datang'));
            elements.tabPulang.addEventListener('click', () => switchTab('pulang'));
            elements.tabAdmin.addEventListener('click', () => switchTab('admin'));
            elements.getLocationBtn.addEventListener('click', getCurrentLocation);
            elements.getLocationBtnPulang.addEventListener('click', getCurrentLocationPulang);
            elements.absenDatangBtn.addEventListener('click', submitAbsenDatang);
            elements.absenPulangBtn.addEventListener('click', submitAbsenPulang);
            elements.refreshAbsenBtn.addEventListener('click', loadAbsenDatangList);
            elements.searchAbsen.addEventListener('input', filterAbsenList);
            elements.refreshAdminData.addEventListener('click', loadAllAttendanceData);
            elements.exportData.addEventListener('click', () => showToast('Fitur export CSV akan segera hadir!', 'info'));
            elements.fixUserData.addEventListener('click', showFixUserDataModal);
            elements.generatePdf.addEventListener('click', () => showToast('Fitur export PDF akan segera hadir!', 'info'));
            elements.applyFilters.addEventListener('click', applyAdminFilters);
            elements.clearFilters.addEventListener('click', clearAdminFilters);
            elements.viewTable.addEventListener('click', () => switchAdminView('table'));
            elements.viewCalendar.addEventListener('click', () => switchAdminView('calendar'));
            elements.viewStatistics.addEventListener('click', () => switchAdminView('statistics'));
            elements.prevMonth.addEventListener('click', prevMonth);
            elements.nextMonth.addEventListener('click', nextMonth);
            elements.statsPeriodBtns.forEach(btn => {
                btn.addEventListener('click', () => switchStatsPeriod(btn.dataset.period));
            });
            elements.editForm.addEventListener('submit', handleEditSubmit);
            elements.cancelEdit.addEventListener('click', hideEditModal);
            elements.editWaktuDatang.addEventListener('change', autoCalculateEditFields);
            elements.editWaktuPulang.addEventListener('change', autoCalculateEditFields);
            elements.editShift.addEventListener('change', autoCalculateEditFields);
        }

        function handleStart() {
            const name = elements.nameInput.value.trim();
            if (!name) {
                showToast('Harap masukkan nama kamu!', 'error');
                return;
            }
            state.currentUser = name;
            localStorage.setItem('currentUser', name);
            elements.displayName.textContent = name;
            elements.welcomeModal.classList.add('hidden');
            elements.mainContent.classList.remove('hidden');
            showToast(`Selamat datang, ${name}!`, 'success');
            updateAdminState();
        }

        function handleLogout() {
            state.currentUser = null;
            state.isAdmin = false;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isAdmin');
            elements.mainContent.classList.add('hidden');
            elements.welcomeModal.classList.remove('hidden');
            elements.nameInput.value = '';
            showToast('Berhasil logout!', 'success');
        }

        function showAdminLogin() { elements.adminLoginModal.classList.remove('hidden'); }
        function hideAdminLogin() {
            elements.adminLoginModal.classList.add('hidden');
            elements.adminPassword.value = '';
        }

        function handleAdminLogin() {
            const password = elements.adminPassword.value.trim();
            if (password === '112211') { // Harap ganti dengan metode autentikasi yang lebih aman
                state.isAdmin = true;
                localStorage.setItem('isAdmin', 'true');
                hideAdminLogin();
                updateAdminState();
                if (state.currentTab === 'admin') {
                    loadAllAttendanceData();
                }
                showToast('Berhasil login sebagai admin!', 'success');
            } else {
                showToast('Password admin salah!', 'error');
            }
        }

        function updateAdminState() {
            const isAdmin = state.isAdmin;
            elements.tabAdmin.classList.toggle('admin-locked', !isAdmin);
            elements.adminAccessBtn.textContent = isAdmin ? 'Admin Mode' : 'Admin Access';
            elements.adminAccessBtn.classList.toggle('bg-purple-500', !isAdmin);
            elements.adminAccessBtn.classList.toggle('bg-green-500', isAdmin);
            if (state.currentTab === 'admin') {
                elements.adminAccessRequired.classList.toggle('hidden', isAdmin);
                elements.adminContent.classList.toggle('hidden', !isAdmin);
            }
        }

        function switchTab(tab) {
            state.currentTab = tab;
            ['datang', 'pulang', 'admin'].forEach(t => {
                const tabElement = elements[`tab${t.charAt(0).toUpperCase() + t.slice(1)}`];
                const contentElement = elements[`content${t.charAt(0).toUpperCase() + t.slice(1)}`];
                tabElement.classList.toggle('tab-active', t === tab);
                tabElement.classList.toggle('tab-inactive', t !== tab);
                contentElement.classList.toggle('hidden', t !== tab);
            });
            
            if (tab === 'pulang') loadAbsenDatangList();
            if (tab === 'admin') {
                updateAdminState();
                if (state.isAdmin && state.allAttendanceData.length === 0) {
                     loadAllAttendanceData();
                }
            }
        }

        function getLocation(displayElement, buttonElement, targetButtonToEnable) {
            buttonElement.disabled = true;
            buttonElement.innerHTML = '<div class="loading-spinner"></div>Mendapatkan lokasi...';
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude: lat, longitude: lng } = position.coords;
                        state.currentLocation = { lat, lng };
                        displayElement.textContent = `Lokasi terdeteksi: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                        if (targetButtonToEnable) targetButtonToEnable.disabled = false;
                        buttonElement.disabled = false;
                        buttonElement.textContent = 'üìç Dapatkan Lokasi';
                    },
                    (error) => {
                        handleLocationError(error, displayElement);
                        buttonElement.disabled = false;
                        buttonElement.textContent = 'üìç Dapatkan Lokasi';
                    }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                displayElement.textContent = 'Geolocation tidak didukung oleh browser ini';
                buttonElement.disabled = false;
                buttonElement.textContent = 'üìç Dapatkan Lokasi';
            }
        }
        
        function getCurrentLocation() { getLocation(elements.locationDisplay, elements.getLocationBtn, elements.absenDatangBtn); }
        function getCurrentLocationPulang() { getLocation(elements.locationDisplayPulang, elements.getLocationBtnPulang, elements.absenPulangBtn); }

        function handleLocationError(error, displayElement) {
            const messages = {
                [error.PERMISSION_DENIED]: "Anda harus mengizinkan akses lokasi.",
                [error.POSITION_UNAVAILABLE]: "Informasi lokasi tidak tersedia.",
                [error.TIMEOUT]: "Waktu permintaan lokasi habis.",
            };
            displayElement.textContent = messages[error.code] || "Gagal mendapatkan lokasi.";
            showToast(displayElement.textContent, 'error');
        }

        function calculateKeterlambatan(shift, checkInTime) {
            const shiftStartHour = shift === "Pagi" ? 8 : 15;
            const lateMinutes = (checkInTime.getHours() - shiftStartHour) * 60 + checkInTime.getMinutes();
            return lateMinutes > 0 ? `${lateMinutes} menit` : "Tepat Waktu";
        }

        function calculateLembur(shift, checkOutTime) {
            const shiftEndHour = shift === "Pagi" ? 17 : 21;
            const shiftEndMinute = shift === "Pagi" ? 0 : 30;
            const overtimeMinutes = (checkOutTime.getHours() - shiftEndHour) * 60 + (checkOutTime.getMinutes() - shiftEndMinute);
            return overtimeMinutes > 0 ? `${overtimeMinutes} menit` : "Tidak ada";
        }
        
        function submitAbsenDatang() {
            if (!state.currentLocation) {
                showToast('Harap dapatkan lokasi terlebih dahulu!', 'error');
                return;
            }
            const shift = document.querySelector('input[name="shift"]:checked').value;
            const now = new Date();
            const data = {
                action: 'absen_datang',
                nama: state.currentUser,
                shift: shift,
                tanggal: formatDate(now),
                waktu: now.toTimeString().split(' ')[0],
                lokasi: elements.locationDisplay.textContent,
                keterlambatan: calculateKeterlambatan(shift, now),
                latitude: state.currentLocation.lat,
                longitude: state.currentLocation.lng
            };
            sendData(data, elements.absenDatangBtn, 'Absen Datang & Kirim', () => {
                elements.locationDisplay.textContent = 'Lokasi akan tampil di sini...';
                elements.absenDatangBtn.disabled = true;
            });
        }

        function submitAbsenPulang() {
            if (!state.currentLocation) {
                showToast('Harap dapatkan lokasi terlebih dahulu!', 'error');
                return;
            }
            const selectedAbsen = document.querySelector('.attendance-item.selected');
            if (!selectedAbsen) {
                showToast('Harap pilih absen datang yang sesuai!', 'error');
                return;
            }
            const shift = document.querySelector('input[name="shift"]:checked').value;
            const now = new Date();
            const data = {
                action: 'absen_pulang',
                absen_datang_id: selectedAbsen.dataset.id,
                nama: state.currentUser,
                shift: shift,
                tanggal: formatDate(now),
                waktu: now.toTimeString().split(' ')[0],
                lokasi: elements.locationDisplayPulang.textContent,
                lembur: calculateLembur(shift, now),
                latitude: state.currentLocation.lat,
                longitude: state.currentLocation.lng
            };
            sendData(data, elements.absenPulangBtn, 'Absen Pulang & Kirim', () => {
                elements.locationDisplayPulang.textContent = 'Lokasi akan tampil di sini...';
                elements.absenPulangBtn.disabled = true;
                loadAbsenDatangList();
            });
        }
        
        function sendData(data, button, buttonText, onSuccess) {
            if (button) {
                button.disabled = true;
                button.innerHTML = '<div class="loading-spinner"></div>Mengirim...';
            }
            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) throw new Error(`Network response error: ${response.statusText}`);
                return response.json();
            })
            .then(result => {
                if (result.result === 'success') {
                    showToast(result.message || 'Aksi berhasil!', 'success');
                    if (onSuccess) onSuccess(result);
                } else {
                    throw new Error(result.message || 'Terjadi kesalahan di server.');
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                showToast(`Gagal: ${error.message}`, 'error');
            })
            .finally(() => {
                if (button) {
                    button.disabled = false;
                    button.textContent = buttonText;
                }
            });
        }
        
        async function fetchData(action) {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=${action}`);
                if (!response.ok) throw new Error(`Network response was not ok for action: ${action}`);
                const result = await response.json();
                if (result.result !== 'success') throw new Error(result.message);
                return result;
            } catch (error) {
                showToast(`Gagal memuat data: ${error.message}`, 'error');
                return null;
            }
        }

        async function loadAbsenDatangList() {
            elements.absenList.innerHTML = '<p class="text-center text-gray-500 py-4">Memuat data...</p>';
            const result = await fetchData(`get_attendance&nama=${encodeURIComponent(state.currentUser)}`);
            if (result) {
                state.absenDatangList = result.data;
                renderAbsenDatangList();
            } else {
                elements.absenList.innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat daftar absen.</p>`;
            }
        }

        function renderAbsenDatangList() {
            if (state.absenDatangList.length === 0) {
                elements.absenList.innerHTML = '<p class="text-center text-gray-500 py-4">Tidak ada data absen datang yang belum pulang.</p>';
                return;
            }
            elements.absenList.innerHTML = state.absenDatangList.map(absen => `
                <div class="attendance-item bg-white p-3 rounded-lg border border-gray-200 cursor-pointer" data-id="${absen.id}">
                    <p class="font-medium">${absen.tanggal}</p>
                    <p class="text-sm text-gray-600">Shift: ${absen.shift} | Datang: ${absen.waktu}</p>
                </div>
            `).join('');
            elements.absenList.querySelectorAll('.attendance-item').forEach(item => {
                item.addEventListener('click', () => {
                    elements.absenList.querySelectorAll('.attendance-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                });
            });
        }
        
        function filterAbsenList() {
            const searchTerm = elements.searchAbsen.value.toLowerCase();
            elements.absenList.querySelectorAll('.attendance-item').forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
            });
        }

        async function loadAllAttendanceData() {
            if (!state.isAdmin) return;
            elements.adminTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">Memuat data...</td></tr>';
            const result = await fetchData('get_all_attendance');
            if(result) {
                state.allAttendanceData = result.data;
                state.filteredAttendanceData = result.data;
                renderAdminTable();
                renderCalendar();
                loadSummaryStatistics(); // Memuat statistik ringkasan setelah data utama dimuat
                switchStatsPeriod(state.currentStatsPeriod); // Memuat grafik default
            } else {
                elements.adminTableBody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-red-500">Gagal memuat data.</td></tr>`;
            }
        }

        function renderAdminTable() {
            if (state.filteredAttendanceData.length === 0) {
                elements.adminTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center">Tidak ada data.</td></tr>';
                return;
            }
            elements.adminTableBody.innerHTML = state.filteredAttendanceData.map(item => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${item.tanggal}</td>
                    <td class="px-4 py-3">${item.nama}</td>
                    <td class="px-4 py-3">${item.shift}</td>
                    <td class="px-4 py-3">${item.waktu_datang || '-'}</td>
                    <td class="px-4 py-3">${item.keterlambatan || '-'}</td>
                    <td class="px-4 py-3">${item.waktu_pulang || '-'}</td>
                    <td class="px-4 py-3">${item.total_jam_kerja || '-'}</td>
                    <td class="px-4 py-3"><span class="status-badge ${item.status === 'Pulang' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${item.status}</span></td>
                    <td class="px-4 py-3"><button class="edit-btn text-blue-600 hover:underline text-xs" data-id="${item.id}">Edit</button> <button class="delete-btn text-red-600 hover:underline text-xs" data-id="${item.id}">Hapus</button></td>
                </tr>
            `).join('');
            elements.adminTableBody.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => showEditModal(e.target.dataset.id)));
            elements.adminTableBody.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteAttendance(e.target.dataset.id)));
        }

        function applyAdminFilters() {
            const nama = elements.filterNama.value.trim().toLowerCase();
            const tanggal = elements.filterTanggal.value;
            const shift = elements.filterShift.value;
            state.filteredAttendanceData = state.allAttendanceData.filter(item => {
                return (!nama || item.nama.toLowerCase().includes(nama)) &&
                       (!tanggal || item.tanggal_iso === tanggal) &&
                       (!shift || item.shift === shift);
            });
            renderAdminTable();
            renderCalendar(); // Perbarui kalender dengan data terfilter
        }

        function clearAdminFilters() {
            elements.filterNama.value = '';
            elements.filterTanggal.value = '';
            elements.filterShift.value = '';
            state.filteredAttendanceData = state.allAttendanceData;
            renderAdminTable();
            renderCalendar();
        }

        function switchAdminView(view) {
            ['table', 'calendar', 'statistics'].forEach(v => {
                elements[`${v}View`].classList.toggle('hidden', v !== view);
                const viewButton = elements[`view${v.charAt(0).toUpperCase() + v.slice(1)}`];
                viewButton.classList.toggle('btn-secondary', v === view);
                viewButton.classList.toggle('bg-gray-300', v !== view);
                viewButton.classList.toggle('text-gray-700', v !== view);
            });
            if (view === 'calendar') renderCalendar();
            if (view === 'statistics' && state.allAttendanceData.length > 0) {
                 switchStatsPeriod(state.currentStatsPeriod);
            }
        }

        function renderCalendar() {
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            elements.currentMonth.textContent = `${monthNames[state.calendarMonth]} ${state.calendarYear}`;
            
            const firstDay = new Date(state.calendarYear, state.calendarMonth, 1);
            const daysInMonth = new Date(state.calendarYear, state.calendarMonth + 1, 0).getDate();
            const startingDay = firstDay.getDay(); // 0 for Sunday, 1 for Monday, etc.

            elements.calendarContainer.innerHTML = ''; // Kosongkan kalender

            // Tambahkan sel kosong untuk hari sebelum tanggal 1
            for (let i = 0; i < startingDay; i++) {
                elements.calendarContainer.innerHTML += `<div class="calendar-day bg-gray-50"></div>`;
            }

            // Tambahkan sel untuk setiap hari dalam bulan
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(state.calendarYear, state.calendarMonth, day);
                const isToday = date.toDateString() === new Date().toDateString();
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const dateString = `${String(day).padStart(2, '0')}-${String(state.calendarMonth + 1).padStart(2, '0')}-${state.calendarYear}`;

                // Gunakan state.filteredAttendanceData agar filter juga berlaku di kalender
                const dayEvents = state.filteredAttendanceData.filter(item => {
                    const itemDate = new Date(item.tanggal_iso);
                    return itemDate.toDateString() === date.toDateString();
                });

                let dayHtml = `<div class="calendar-day ${isToday ? 'today' : ''} ${isWeekend ? 'weekend' : ''}">
                    <div class="font-bold mb-1">${day}</div>
                    <div class="space-y-1">
                        ${dayEvents.map(e => `<div class="calendar-event ${e.shift.toLowerCase()}" title="${e.nama} - ${e.shift}">${e.nama}</div>`).join('')}
                    </div>
                </div>`;
                elements.calendarContainer.innerHTML += dayHtml;
            }
        }
        function prevMonth() { state.calendarMonth--; if (state.calendarMonth < 0) { state.calendarMonth = 11; state.calendarYear--; } renderCalendar(); }
        function nextMonth() { state.calendarMonth++; if (state.calendarMonth > 11) { state.calendarMonth = 0; state.calendarYear++; } renderCalendar(); }
        
        async function loadSummaryStatistics() {
            const result = await fetchData('get_statistics');
            if (result && result.statistics) {
                renderStatistics(result.statistics);
            }
        }

        function renderStatistics(stats) {
            elements.totalAbsensi.textContent = stats.total_absensi_bulan_ini || 0;
            elements.avgLate.textContent = `${stats.rata_rata_keterlambatan || 0} menit`;
            elements.totalLate.textContent = `${stats.total_keterlambatan || 0} menit`;
        }

        async function switchStatsPeriod(period) {
            state.currentStatsPeriod = period;
            elements.statsPeriodBtns.forEach(btn => {
                const isSelected = btn.dataset.period === period;
                btn.classList.toggle('btn-secondary', isSelected);
                btn.classList.toggle('bg-gray-300', !isSelected);
                btn.classList.toggle('text-gray-700', !isSelected);
            });
            
            elements.chartsContainer.innerHTML = '<div class="flex justify-center items-center h-48"><div class="loading-spinner"></div><p>Memuat grafik...</p></div>';
            const result = await fetchData(`get_stats_${period}`);

            if (result && result.stats) {
                elements.chartsContainer.innerHTML = ''; // Clear loader
                const renderer = {
                    weekly: renderWeeklyStats,
                    monthly: renderMonthlyStats,
                    yearly: renderYearlyStats
                };
                if(renderer[period]) renderer[period](result.stats);
            } else {
                 elements.chartsContainer.innerHTML = '<p class="text-center text-red-500">Gagal memuat data grafik.</p>';
            }
        }

        function renderWeeklyStats(stats) {
            elements.chartsContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="chart-container"><canvas id="chart-daily"></canvas></div>
                    <div class="chart-container"><canvas id="chart-shift-pie"></canvas></div>
                </div>`;
            
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            createChart('chart-daily', 'bar', {
                labels: days,
                datasets: [{ 
                    label: 'Absensi Harian', 
                    data: days.map(d => stats.daily_attendance[d] || 0), 
                    backgroundColor: 'rgba(255, 105, 180, 0.7)',
                    borderColor: 'rgba(255, 105, 180, 1)',
                    borderWidth: 1
                }]
            }, 'Absensi per Hari (Minggu Ini)');

            createChart('chart-shift-pie', 'doughnut', {
                labels: ['Pagi', 'Sore'],
                datasets: [{ 
                    data: [stats.shift_comparison.Pagi || 0, stats.shift_comparison.Sore || 0], 
                    backgroundColor: ['#87CEEB', '#FF69B4']
                }]
            }, 'Perbandingan Shift (Minggu Ini)');
        }
        
        function renderMonthlyStats(stats) {
            elements.chartsContainer.innerHTML = `
                <div class="chart-container" style="height: 400px;"><canvas id="chart-user-attendance"></canvas></div>`;

            createChart('chart-user-attendance', 'bar', {
                labels: Object.keys(stats.user_attendance),
                datasets: [{
                    label: 'Total Kehadiran',
                    data: Object.values(stats.user_attendance),
                    backgroundColor: '#9370DB'
                }]
            }, 'Total Kehadiran per Pengguna (Bulan Ini)', { indexAxis: 'y' });
        }

        function renderYearlyStats(stats) {
            elements.chartsContainer.innerHTML = `
                <div class="chart-container"><canvas id="chart-monthly-attendance"></canvas></div>`;
            
            const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
            createChart('chart-monthly-attendance', 'line', {
                labels: months,
                datasets: [{
                    label: 'Total Absensi',
                    data: months.map((m, i) => stats.monthly_attendance[i + 1] || 0),
                    borderColor: '#FF69B4',
                    backgroundColor: 'rgba(255, 105, 180, 0.2)',
                    fill: true,
                    tension: 0.3
                }]
            }, `Total Absensi per Bulan (${state.calendarYear})`);
        }

        function createChart(canvasId, type, data, titleText, customOptions = {}) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return;
            if (state.charts[canvasId]) state.charts[canvasId].destroy();
            
            const options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: { display: true, text: titleText, font: { size: 16 } },
                    legend: { position: 'top' }
                },
                ...customOptions
            };

            state.charts[canvasId] = new Chart(ctx, { type, data, options });
        }

        function showEditModal(id) {
            const item = state.allAttendanceData.find(i => i.id === id);
            if (!item) return;
            elements.editId.value = item.id;
            elements.editTanggal.value = item.tanggal_iso;
            elements.editNama.value = item.nama;
            elements.editShift.value = item.shift;
            elements.editWaktuDatang.value = item.waktu_datang || '';
            elements.editWaktuPulang.value = item.waktu_pulang || '';
            elements.editKeterlambatan.value = item.keterlambatan || '';
            elements.editLembur.value = item.lembur || '';
            elements.editModal.classList.remove('hidden');
        }

        function hideEditModal() { elements.editModal.classList.add('hidden'); }

        function autoCalculateEditFields() {
            const shift = elements.editShift.value;
            if (elements.editWaktuDatang.value) {
                const [h, m] = elements.editWaktuDatang.value.split(':');
                const checkInTime = new Date(0, 0, 0, h, m);
                elements.editKeterlambatan.value = calculateKeterlambatan(shift, checkInTime);
            }
            if (elements.editWaktuPulang.value) {
                const [h, m] = elements.editWaktuPulang.value.split(':');
                const checkOutTime = new Date(0, 0, 0, h, m);
                elements.editLembur.value = calculateLembur(shift, checkOutTime);
            }
        }

        function handleEditSubmit(e) {
            e.preventDefault();
            const data = {
                action: 'update_attendance',
                id: elements.editId.value,
                tanggal: elements.editTanggal.value,
                nama: elements.editNama.value,
                shift: elements.editShift.value,
                waktu_datang: elements.editWaktuDatang.value,
                waktu_pulang: elements.editWaktuPulang.value,
                keterlambatan: elements.editKeterlambatan.value,
                lembur: elements.editLembur.value,
                total_jam_kerja: calculateWorkingHours(elements.editWaktuDatang.value, elements.editWaktuPulang.value)
            };
            sendData(data, e.target.querySelector('button[type="submit"]'), 'Simpan Perubahan', () => {
                hideEditModal();
                loadAllAttendanceData();
            });
        }
        
        function deleteAttendance(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) return;
            sendData({ action: 'delete_attendance', id }, null, null, loadAllAttendanceData);
        }

        function showFixUserDataModal() {
            const namaLama = prompt("Masukkan nama lama yang ingin diperbaiki:");
            if (!namaLama) return;
            const namaBaru = prompt(`Masukkan nama baru untuk "${namaLama}":`);
            if (!namaBaru) return;
            sendData({ action: 'fix_user_data', nama_lama: namaLama, nama_baru: namaBaru }, null, null, loadAllAttendanceData);
        }

        function calculateWorkingHours(startTime, endTime) {
            if (!startTime || !endTime) return '';
            const start = new Date(`1970-01-01T${startTime}`);
            const end = new Date(`1970-01-01T${endTime}`);
            let diff = end - start;
            if (diff < 0) diff += 24 * 60 * 60 * 1000;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours} jam ${minutes} menit`;
        }

        function formatDate(date) { return `${date.getDate()} ${date.toLocaleString('id-ID', { month: 'long' })} ${date.getFullYear()}`; }
        
        function updateDateTime() {
            elements.currentDatetime.textContent = new Date().toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        
        function showToast(message, type = 'success') {
            const toast = elements.toast;
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            const colors = {
                success: 'green',
                error: 'red',
                info: 'blue'
            };
            const icons = {
                success: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                info: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
            };
            
            toastMessage.textContent = message;
            toast.className = `fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg border-l-4 z-50 max-w-sm fade-in border-${colors[type]}-500`;
            toastIcon.className = `mr-3 text-${colors[type]}-500`;
            toastIcon.innerHTML = icons[type];
            
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.add('hidden'); }, 3000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
